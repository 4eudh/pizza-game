<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack of the Vampire Pizzas! - Enhanced Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-fast': 'pulse 1s infinite',
                        'shake': 'shake 0.5s ease-in-out',
                        'float': 'float 3s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'stars': 'stars 20s linear infinite',
                        'nebula': 'nebula 30s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="20" cy="20" r="1" fill="white" opacity="0.3"/><circle cx="80" cy="40" r="0.5" fill="white" opacity="0.5"/><circle cx="50" cy="70" r="1.5" fill="white" opacity="0.2"/><circle cx="10" cy="90" r="0.8" fill="white" opacity="0.4"/><circle cx="90" cy="10" r="0.3" fill="white" opacity="0.6"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>'),
                linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0e1428 75%, #0a0a1a 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 200px 200px, 100% 100%;
            background-attachment: fixed;
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            animation: nebula 30s ease-in-out infinite;
        }
        
        .game-title {
            font-family: 'Creepster', cursive;
            background: linear-gradient(45deg, #7C3AED, #EC4899, #F59E0B, #10B981);
            background-size: 400% 400%;
            animation: gradient 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.7));
        }
        
        .tech-title {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(45deg, #00D4FF, #7C3AED);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes nebula {
            0%, 100% { filter: brightness(1) hue-rotate(0deg); }
            33% { filter: brightness(1.1) hue-rotate(60deg); }
            66% { filter: brightness(0.9) hue-rotate(-30deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(124, 58, 237, 0.5); }
            to { box-shadow: 0 0 40px rgba(124, 58, 237, 0.8), 0 0 60px rgba(236, 72, 153, 0.5); }
        }
        
        @keyframes fadeUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        @keyframes explosion {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }
        
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #7C3AED, #EC4899);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(124, 58, 237, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #374151, #6B7280);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(45deg, #4B5563, #9CA3AF);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .screen {
            display: none;
            min-height: 100vh;
        }
        
        .screen.active {
            display: flex;
        }
        
        .game-canvas {
            background: 
                linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.9) 50%, rgba(14, 20, 40, 0.8) 100%),
                url('https://raw.githubusercontent.com/4eudh/pizza-game/main/game_background.jpg');
            background-size: cover;
            background-position: center;
            background-blend-mode: multiply;
            border: 3px solid #7C3AED;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 0 30px rgba(124, 58, 237, 0.3),
                inset 0 0 100px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 500px;
        }
        
        .game-path {
            position: absolute;
            left: 0;
            top: 0;
            width: 150px;
            height: 100%;
            background: 
                linear-gradient(90deg, 
                    rgba(139, 69, 19, 0.9) 0%, 
                    rgba(160, 82, 45, 0.8) 30%, 
                    rgba(205, 133, 63, 0.9) 70%, 
                    rgba(210, 105, 30, 0.8) 100%),
                url('https://raw.githubusercontent.com/4eudh/pizza-game/main/road_background.png');
            background-size: cover;
            background-blend-mode: multiply;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent, 
                    transparent 10px, 
                    rgba(139, 69, 19, 0.3) 10px, 
                    rgba(139, 69, 19, 0.3) 20px);
            border-right: 3px solid #654321;
            box-shadow: 
                inset -10px 0 20px rgba(0,0,0,0.5),
                0 0 20px rgba(139, 69, 19, 0.3);
            z-index: 1;
        }
        
        .enemy, .trap, .powerup, .projectile {
            position: absolute;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-size: 18px;
            z-index: 10;
            transition: all 0.1s ease;
        }
        
        .enemy {
            animation: float 2s ease-in-out infinite;
        }
        
        .enemy.boss {
            animation: float 1s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
            border: 3px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        
        .trap {
            cursor: pointer;
            animation: glow 3s ease-in-out infinite alternate;
        }
        
        .trap.ready {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
        }
        
        .trap.cooldown {
            opacity: 0.6;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .powerup {
            animation: bounce-slow infinite, glow 1s ease-in-out infinite alternate;
        }
        
        .projectile {
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }
        
        .health-bar {
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #EF4444, #F59E0B, #10B981);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }
        
        .shield-bar {
            position: absolute;
            top: -18px;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 2px;
        }
        
        .shield-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.8);
        }
        
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 16px;
            z-index: 20;
            pointer-events: none;
            animation: fadeUp 1.5s ease-out forwards;
        }
        
        .damage-number.heal { color: #10B981; }
        .damage-number.damage { color: #EF4444; }
        .damage-number.money { color: #F59E0B; }
        .damage-number.critical { 
            color: #FFD700; 
            font-size: 20px; 
            text-shadow: 0 0 10px #FFD700;
        }
        
        .explosion-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #FFD700, #FF4500, #DC2626);
            border-radius: 50%;
            animation: explosion 0.5s ease-out forwards;
            z-index: 15;
        }
        
        .lightning-effect {
            position: absolute;
            width: 4px;
            background: linear-gradient(90deg, #60A5FA, #FFFFFF, #60A5FA);
            animation: lightning 0.2s ease-in-out;
            z-index: 15;
            box-shadow: 0 0 10px #60A5FA;
        }
        
        .notification {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .trap-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .trap-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .trap-btn:hover::before {
            left: 100%;
        }
        
        .trap-btn:hover {
            border-color: #7C3AED;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }
        
        .trap-btn.selected {
            border-color: #F59E0B;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
        }
        
        .trap-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .trap-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .mode-btn {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(236, 72, 153, 0.2));
            border: 2px solid rgba(124, 58, 237, 0.5);
            transition: all 0.3s ease;
        }
        
        .mode-btn.selected {
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            border-color: #F59E0B;
            box-shadow: 0 0 25px rgba(124, 58, 237, 0.6);
        }
        
        .difficulty-btn {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(59, 130, 246, 0.2));
            border: 2px solid rgba(34, 197, 94, 0.5);
            transition: all 0.3s ease;
        }
        
        .difficulty-btn.selected {
            background: linear-gradient(135deg, #22C55E, #3B82F6);
            border-color: #F59E0B;
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.6);
        }
        
        .difficulty-btn.hard {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(239, 68, 68, 0.2));
            border-color: rgba(251, 146, 60, 0.5);
        }
        
        .difficulty-btn.hard.selected {
            background: linear-gradient(135deg, #FB923C, #EF4444);
        }
        
        .difficulty-btn.expert {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border-color: rgba(168, 85, 247, 0.5);
        }
        
        .difficulty-btn.expert.selected {
            background: linear-gradient(135deg, #A855F7, #EC4899);
        }
        
        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }
        
        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #374151;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #7C3AED;
        }
        
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .toggle-switch.active::before {
            transform: translateX(30px);
        }
        
        .rank-medal {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; }
        .rank-2 { background: linear-gradient(45deg, #C0C0C0, #A0A0A0); color: #000; }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #B8860B); color: #fff; }
        .rank-other { background: linear-gradient(45deg, #6B7280, #4B5563); color: #fff; }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .achievement-badge {
            background: linear-gradient(45deg, #10B981, #059669);
            border: 2px solid #D1FAE5;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .achievement-badge.locked {
            background: linear-gradient(45deg, #6B7280, #4B5563);
            border-color: #9CA3AF;
            opacity: 0.6;
        }
        
        .level-progress {
            background: linear-gradient(90deg, #7C3AED, #EC4899, #F59E0B);
            height: 8px;
            border-radius: 4px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .game-canvas {
                height: 400px;
            }
            
            .game-title {
                font-size: 2.5rem !important;
            }
            
            .trap-btn {
                padding: 0.75rem;
            }
            
            .enemy, .trap {
                font-size: 14px;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .glass {
                background: rgba(0, 0, 0, 0.4);
                border-color: rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="screen active items-center justify-center p-6">
        <div class="w-full max-w-md mx-auto">
            <div class="text-center mb-8">
                <h1 class="game-title text-5xl md:text-6xl mb-4">Vampire Pizzas!</h1>
                <p class="text-xl text-gray-300 mb-2">Enhanced Edition</p>
                <p class="text-gray-400">Defend your pizzeria from the undead hordes!</p>
            </div>
            
            <div class="glass-strong rounded-2xl p-8">
                <!-- Login Form -->
                <div id="loginForm">
                    <h2 class="tech-title text-2xl font-bold text-center mb-6">Access Terminal</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-blue-300">Email Address</label>
                            <input type="email" id="loginEmail" 
                                   class="w-full px-4 py-3 bg-black/30 border border-blue-500/30 rounded-lg text-base text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                                   placeholder="Enter your email">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-blue-300">Password</label>
                            <input type="password" id="loginPassword" 
                                   class="w-full px-4 py-3 bg-black/30 border border-blue-500/30 rounded-lg text-base text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                                   placeholder="Enter your password">
                        </div>
                        <button id="loginBtn" class="w-full btn-primary py-4 rounded-lg font-semibold text-lg relative overflow-hidden">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üîê" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üîê'">
                            Initialize Defense System
                        </button>
                        <div class="text-center space-y-3">
                            <button type="button" id="showSignupBtn" class="text-primary hover:text-secondary transition-colors block w-full py-2">
                                Register New Commander
                            </button>
                            <button type="button" id="playAsGuestBtn" class="text-accent hover:text-white transition-colors text-lg font-semibold block w-full py-3 border border-accent/50 rounded-lg hover:bg-accent/20">
                                <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üéÆ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üéÆ'">
                                Emergency Guest Access
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="signupForm" class="hidden">
                    <h2 class="tech-title text-2xl font-bold text-center mb-6">Commander Registration</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-blue-300">Commander Name</label>
                            <input type="text" id="signupUsername" 
                                   class="w-full px-4 py-3 bg-black/30 border border-blue-500/30 rounded-lg text-base text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                                   placeholder="Choose your callsign">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-blue-300">Email Address</label>
                            <input type="email" id="signupEmail" 
                                   class="w-full px-4 py-3 bg-black/30 border border-blue-500/30 rounded-lg text-base text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                                   placeholder="Enter your email">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-blue-300">Access Code</label>
                            <input type="password" id="signupPassword" 
                                   class="w-full px-4 py-3 bg-black/30 border border-blue-500/30 rounded-lg text-base text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
                                   placeholder="Create secure password">
                        </div>
                        <button id="signupBtn" class="w-full btn-primary py-4 rounded-lg font-semibold text-lg">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üöÄ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üöÄ'">
                            Register Commander
                        </button>
                        <div class="text-center">
                            <button type="button" id="showLoginBtn" class="text-primary hover:text-secondary transition-colors">
                                Return to Login Terminal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Menu -->
    <div id="menuScreen" class="screen items-center justify-center p-6">
        <div class="text-center max-w-6xl mx-auto">
            <h1 class="game-title text-6xl md:text-8xl mb-4">Vampire Pizzas!</h1>
            <h2 class="tech-title text-2xl md:text-3xl mb-8">Enhanced Defense System</h2>
            
            <!-- Player Level & Progress -->
            <div class="glass-strong rounded-2xl p-6 mb-8">
                <div class="flex items-center justify-center mb-4">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üë§" class="w-16 h-16 rounded-full mr-4" onerror="this.outerHTML='<div class=&quot;w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-2xl mr-4&quot;>üë§</div>'">
                    <div class="text-left">
                        <div class="text-2xl font-bold text-blue-300" id="playerLevel">Level 1 Rookie</div>
                        <div class="text-gray-400" id="playerXP">0 / 100 XP</div>
                    </div>
                </div>
                <div class="w-full bg-gray-700/50 rounded-full h-3 overflow-hidden mb-2">
                    <div id="xpProgress" class="level-progress" style="width: 0%"></div>
                </div>
                <div class="text-sm text-gray-400">Next: Unlock Advanced Traps</div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="glass-strong rounded-2xl p-6 mb-8">
                <h3 class="text-2xl font-bold mb-6 text-green-300">Select Difficulty</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="difficultySelection">
                    <button class="difficulty-btn selected rounded-xl p-4 text-center" data-difficulty="beginner">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/gem1blue.png" alt="üü¢" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üü¢</div>'">
                        <div class="font-bold">Beginner</div>
                        <div class="text-sm text-gray-300">Easy start</div>
                    </button>
                    <button class="difficulty-btn rounded-xl p-4 text-center" data-difficulty="intermediate">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üü°" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üü°</div>'">
                        <div class="font-bold">Intermediate</div>
                        <div class="text-sm text-gray-300">Balanced</div>
                    </button>
                    <button class="difficulty-btn hard rounded-xl p-4 text-center" data-difficulty="advanced">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/explosion.png" alt="üü†" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üü†</div>'">
                        <div class="font-bold">Advanced</div>
                        <div class="text-sm text-gray-300">Challenging</div>
                    </button>
                    <button class="difficulty-btn expert rounded-xl p-4 text-center" data-difficulty="expert">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/cthulu-pizza.png" alt="üî¥" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üî¥</div>'">
                        <div class="font-bold">Expert</div>
                        <div class="text-sm text-gray-300">Hardcore</div>
                    </button>
                </div>
            </div>
            
            <!-- Game Mode Selection -->
            <div class="glass-strong rounded-2xl p-6 mb-8">
                <h3 class="text-2xl font-bold mb-6 text-blue-300">Select Mission Type</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="gameModeSelection">
                    <button class="mode-btn selected rounded-xl p-4 text-center" data-mode="classic">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/garlic.png" alt="üéØ" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üéØ</div>'">
                        <div class="font-bold">Classic</div>
                        <div class="text-sm text-gray-300">Standard waves</div>
                    </button>
                    <button class="mode-btn rounded-xl p-4 text-center" data-mode="endless">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png" alt="‚ôæÔ∏è" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>‚ôæÔ∏è</div>'">
                        <div class="font-bold">Endless</div>
                        <div class="text-sm text-gray-300">Infinite survival</div>
                    </button>
                    <button class="mode-btn rounded-xl p-4 text-center" data-mode="boss_rush">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/cthulu-pizza.png" alt="üëë" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>üëë</div>'">
                        <div class="font-bold">Boss Rush</div>
                        <div class="text-sm text-gray-300">Bosses only</div>
                    </button>
                    <button class="mode-btn rounded-xl p-4 text-center" data-mode="speed">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="‚ö°" class="w-8 h-8 mx-auto mb-2" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>‚ö°</div>'">
                        <div class="font-bold">Speed Mode</div>
                        <div class="text-sm text-gray-300">Fast & furious</div>
                    </button>
                </div>
                <button id="startGameBtn" class="btn-primary px-8 py-4 rounded-xl font-bold text-xl">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/anchovy-cannon.png" alt="üöÄ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üöÄ'">
                    Begin Defense Mission
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
                <button id="leaderboardBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üèÜ" class="w-12 h-12 mx-auto mb-4" onerror="this.outerHTML='<div class=&quot;text-4xl mb-4&quot;>üèÜ</div>'">
                    <h3 class="text-xl font-bold mb-2">Command Center</h3>
                    <p class="text-gray-300">Rankings & Records</p>
                </button>
                
                <button id="profileBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üéñÔ∏è" class="w-12 h-12 mx-auto mb-4" onerror="this.outerHTML='<div class=&quot;text-4xl mb-4&quot;>üéñÔ∏è</div>'">
                    <h3 class="text-xl font-bold mb-2">Commander Profile</h3>
                    <p class="text-gray-300">Stats & Achievements</p>
                </button>
                
                <button id="settingsBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="‚öôÔ∏è" class="w-12 h-12 mx-auto mb-4" onerror="this.outerHTML='<div class=&quot;text-4xl mb-4&quot;>‚öôÔ∏è</div>'">
                    <h3 class="text-xl font-bold mb-2">System Config</h3>
                    <p class="text-gray-300">Preferences & Settings</p>
                </button>
            </div>
            
            <div class="flex justify-center gap-4 mb-8">
                <button id="logoutBtn" class="glass rounded-xl px-6 py-3 hover:bg-red-500/20 transition-all">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png" alt="üö™" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üö™'"> Logout
                </button>
            </div>
            
            <div id="userInfo" class="text-xl font-semibold text-blue-300"></div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen" class="screen flex-col p-4">
        <div class="flex flex-col lg:flex-row gap-4 h-full">
            <!-- Main Game Area -->
            <div class="flex-1">
                <!-- Top Control Bar -->
                <div class="glass-strong rounded-xl p-4 mb-4 flex items-center justify-between">
                    <button id="backToMenuBtn" class="btn-secondary px-6 py-3 rounded-lg">‚Üê Command Center</button>
                    <div class="text-center">
                        <h2 class="game-title text-2xl md:text-3xl">Wave <span id="currentWave">1</span></h2>
                        <div class="tech-title text-sm" id="gameMode">Classic Mode</div>
                        <div class="text-xs text-gray-400" id="gameDifficulty">Beginner</div>
                    </div>
                    <div class="flex gap-3">
                        <button id="pauseGameBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-3 rounded-lg font-semibold transition-all">‚è∏Ô∏è</button>
                        <button id="speedBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-3 rounded-lg font-semibold transition-all">1x</button>
                    </div>
                </div>
                
                <!-- Enhanced Stats Bar -->
                <div class="glass rounded-xl p-4 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-7 gap-3">
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="pizzaBucks">100</div>
                            <div class="text-xs text-gray-400">Pizza Bucks</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-400" id="lives">5</div>
                            <div class="text-xs text-gray-400">Lives</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400" id="kills">0</div>
                            <div class="text-xs text-gray-400">Eliminated</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="score">0</div>
                            <div class="text-xs text-gray-400">Score</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="enemiesLeft">0</div>
                            <div class="text-xs text-gray-400">Incoming</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-orange-400" id="combo">0</div>
                            <div class="text-xs text-gray-400">Combo</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-pink-400" id="sessionXP">0</div>
                            <div class="text-xs text-gray-400">XP Earned</div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Canvas -->
                <div id="gameCanvas" class="game-canvas">
                    <!-- Path layer -->
                    <div class="game-path"></div>
                    
                    <!-- Game entities will be spawned here -->
                </div>
            </div>
            
            <!-- Enhanced Side Panel -->
            <div class="w-full lg:w-96 space-y-4">
                <!-- Defense Arsenal -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-primary flex items-center justify-center">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/garlic.png" alt="üõ°Ô∏è" class="w-6 h-6 mr-2" onerror="this.outerHTML='üõ°Ô∏è'"> Defense Arsenal
                    </h3>
                    <div class="grid grid-cols-2 gap-3" id="trapShop">
                        <!-- Enhanced trap buttons will be populated here -->
                    </div>
                </div>
                
                <!-- Wave Intel -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-blue-400">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üìä" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üìä'"> Wave Intel
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>Next Wave:</span>
                            <span id="waveTimer" class="text-blue-400 font-bold">30s</span>
                        </div>
                        <div class="w-full bg-gray-700/50 rounded-full h-4 overflow-hidden">
                            <div id="waveProgress" class="bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-400 text-center" id="waveInfo">Preparing defenses...</div>
                    </div>
                </div>
                
                <!-- Power-ups & Abilities -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-green-400">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="‚ö°" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='‚ö°'"> Power Systems
                    </h3>
                    <div class="grid grid-cols-2 gap-3" id="powerupShop">
                        <button class="bg-red-500/20 hover:bg-red-500/30 py-3 rounded-lg transition-colors font-semibold text-sm" id="airstrikeBtn">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/explosion.png" alt="üí•" class="w-5 h-5 inline mr-1" onerror="this.outerHTML='üí•'"> Airstrike ($50)
                        </button>
                        <button class="bg-blue-500/20 hover:bg-blue-500/30 py-3 rounded-lg transition-colors font-semibold text-sm" id="freezeBtn">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/gem1blue.png" alt="‚ùÑÔ∏è" class="w-5 h-5 inline mr-1" onerror="this.outerHTML='‚ùÑÔ∏è'"> Freeze ($30)
                        </button>
                        <button class="bg-yellow-500/20 hover:bg-yellow-500/30 py-3 rounded-lg transition-colors font-semibold text-sm" id="repairBtn">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üîß" class="w-5 h-5 inline mr-1" onerror="this.outerHTML='üîß'"> Repair ($40)
                        </button>
                        <button class="bg-purple-500/20 hover:bg-purple-500/30 py-3 rounded-lg transition-colors font-semibold text-sm" id="boostBtn">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/anchovy-cannon.png" alt="üöÄ" class="w-5 h-5 inline mr-1" onerror="this.outerHTML='üöÄ'"> Boost ($35)
                        </button>
                    </div>
                </div>
                
                <!-- Command Actions -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-orange-400">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/anchovy-cannon.png" alt="üéØ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üéØ'"> Commands
                    </h3>
                    <div class="space-y-3">
                        <button id="sellModeBtn" class="w-full bg-red-500/20 hover:bg-red-500/30 py-3 rounded-lg transition-colors font-semibold">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üí∞" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üí∞'"> Salvage Mode
                        </button>
                        <button id="upgradeMode" class="w-full bg-green-500/20 hover:bg-green-500/30 py-3 rounded-lg transition-colors font-semibold">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="‚¨ÜÔ∏è" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='‚¨ÜÔ∏è'"> Upgrade Mode
                        </button>
                        <button id="clearAllBtn" class="w-full bg-orange-500/20 hover:bg-orange-500/30 py-3 rounded-lg transition-colors font-semibold">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/explosion.png" alt="üóëÔ∏è" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üóëÔ∏è'"> Emergency Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Leaderboard Screen -->
    <div id="leaderboardScreen" class="screen flex-col p-6">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex items-center justify-between mb-8">
                <h1 class="game-title text-4xl md:text-6xl">Command Center</h1>
                <button id="backFromLeaderboardBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ‚Üê Return to Base
                </button>
            </div>
            
            <div class="glass-strong rounded-2xl p-6">
                <div class="flex justify-center mb-6">
                    <div class="flex space-x-2 bg-black/30 rounded-lg p-1">
                        <button id="scoreLeaderboard" class="px-6 py-2 rounded-lg btn-primary">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üèÜ" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üèÜ'"> High Scores
                        </button>
                        <button id="waveLeaderboard" class="px-6 py-2 rounded-lg hover:bg-white/10 transition-colors">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png" alt="üåä" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üåä'"> Wave Records
                        </button>
                        <button id="killsLeaderboard" class="px-6 py-2 rounded-lg hover:bg-white/10 transition-colors">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/explosion.png" alt="‚öîÔ∏è" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='‚öîÔ∏è'"> Elimination Count
                        </button>
                        <button id="achievementLeaderboard" class="px-6 py-2 rounded-lg hover:bg-white/10 transition-colors">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üéñÔ∏è" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üéñÔ∏è'"> Achievements
                        </button>
                    </div>
                </div>
                
                <div id="leaderboardLoading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <p class="mt-2 text-gray-400">Accessing command database...</p>
                </div>
                
                <div id="leaderboardContent" class="space-y-3 hidden">
                    <!-- Enhanced leaderboard items will be populated here -->
                </div>
                
                <div id="leaderboardError" class="text-center py-8 hidden">
                    <p class="text-red-400 mb-4">Failed to access command database</p>
                    <button id="retryLeaderboard" class="btn-primary px-6 py-2 rounded-lg">
                        Retry Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Profile Screen -->
    <div id="profileScreen" class="screen flex-col p-6">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex items-center justify-between mb-8">
                <h1 class="game-title text-4xl md:text-6xl">Commander Profile</h1>
                <button id="backFromProfileBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ‚Üê Return to Base
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Commander Info -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-blue-300">Commander Intel</h2>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üë§" class="w-20 h-20 rounded-full" onerror="this.outerHTML='<div class=&quot;w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-2xl font-bold&quot;>üë§</div>'">
                            <div>
                                <div class="text-2xl font-bold" id="profileUsername">Commander</div>
                                <div class="text-gray-400" id="profileEmail">email@hq.com</div>
                                <div class="text-sm text-primary" id="profileJoinDate">Enlisted: --</div>
                                <div class="text-sm text-green-400" id="profileRank">Rank: Rookie</div>
                                <div class="text-sm text-purple-400" id="profileLevel">Level 1</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Combat Statistics -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-green-300">Combat Statistics</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="profileHighScore">0</div>
                            <div class="text-sm text-gray-400">Best Score</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="profileMaxWave">0</div>
                            <div class="text-sm text-gray-400">Max Wave</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-400" id="profileTotalKills">0</div>
                            <div class="text-sm text-gray-400">Total Eliminated</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-400" id="profileGamesPlayed">0</div>
                            <div class="text-sm text-gray-400">Missions</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="profileWinRate">0%</div>
                            <div class="text-sm text-gray-400">Success Rate</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-400" id="profilePlayTime">0h</div>
                            <div class="text-sm text-gray-400">Play Time</div>
                        </div>
                    </div>
                </div>
                
                <!-- Achievements -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-yellow-300">Achievements</h2>
                    <div class="space-y-3 max-h-96 overflow-y-auto" id="achievementsList">
                        <!-- Achievement badges will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Settings Screen -->
    <div id="settingsScreen" class="screen flex-col p-6">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex items-center justify-between mb-8">
                <h1 class="game-title text-4xl md:text-6xl">System Configuration</h1>
                <button id="backFromSettingsBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ‚Üê Return to Base
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Game Settings -->
                <div class="settings-section glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-blue-300">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üéÆ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üéÆ'"> Game Settings
                    </h2>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Auto-pause between waves</div>
                                <div class="text-sm text-gray-400">Automatically pause when a wave ends</div>
                            </div>
                            <div class="toggle-switch" id="autoPauseToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Show damage numbers</div>
                                <div class="text-sm text-gray-400">Display floating damage text</div>
                            </div>
                            <div class="toggle-switch active" id="damageNumbersToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Show trap ranges</div>
                                <div class="text-sm text-gray-400">Display attack range circles</div>
                            </div>
                            <div class="toggle-switch active" id="trapRangesToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Screen shake effects</div>
                                <div class="text-sm text-gray-400">Camera shake on impacts</div>
                            </div>
                            <div class="toggle-switch active" id="screenShakeToggle"></div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Default game speed</label>
                            <select id="defaultSpeedSelect" class="w-full px-4 py-2 bg-black/30 border border-blue-500/30 rounded-lg text-white focus:border-primary focus:outline-none">
                                <option value="1">1x (Standard)</option>
                                <option value="2">2x (Fast)</option>
                                <option value="3">3x (Very Fast)</option>
                                <option value="4">4x (Ultra Fast)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Audio/Visual Settings -->
                <div class="settings-section glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-green-300">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üé®" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üé®'"> Audio & Visual
                    </h2>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Sound effects</div>
                                <div class="text-sm text-gray-400">Play game sound effects</div>
                            </div>
                            <div class="toggle-switch active" id="soundEffectsToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Background music</div>
                                <div class="text-sm text-gray-400">Play ambient music</div>
                            </div>
                            <div class="toggle-switch active" id="backgroundMusicToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Particle effects</div>
                                <div class="text-sm text-gray-400">Show explosions and particles</div>
                            </div>
                            <div class="toggle-switch active" id="particleEffectsToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Animation quality</div>
                                <div class="text-sm text-gray-400">Enhanced visual effects</div>
                            </div>
                            <div class="toggle-switch active" id="animationQualityToggle"></div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Graphics quality</label>
                            <select id="graphicsQualitySelect" class="w-full px-4 py-2 bg-black/30 border border-blue-500/30 rounded-lg text-white focus:border-primary focus:outline-none">
                                <option value="low">Low (Better performance)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Better visuals)</option>
                                <option value="ultra">Ultra (Maximum quality)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Master volume</label>
                            <input type="range" id="masterVolumeSlider" min="0" max="100" value="80" 
                                   class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <div class="text-center text-sm text-gray-400" id="volumeDisplay">80%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Settings -->
            <div class="text-center mt-8">
                <button id="saveSettingsBtn" class="btn-primary px-12 py-4 rounded-xl font-bold text-lg">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üíæ" class="w-6 h-6 inline mr-2" onerror="this.outerHTML='üíæ'"> Save Configuration
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Modals -->
    <div id="pauseModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-3xl font-bold text-center mb-6 game-title">Mission Paused</h2>
            <div class="space-y-4">
                <button id="resumeBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">‚ñ∂Ô∏è Resume Mission</button>
                <button id="restartBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 py-4 rounded-lg text-lg font-semibold transition-all">üîÑ Restart Wave</button>
                <button id="quitBtn" class="w-full bg-red-500 hover:bg-red-600 py-4 rounded-lg text-lg font-semibold transition-all">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png" alt="üè†" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üè†'"> Return to Base
                </button>
            </div>
        </div>
    </div>
    
    <div id="gameOverModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-lg w-full mx-4">
            <h2 id="gameOverTitle" class="text-3xl font-bold text-center mb-6 game-title">Mission Report</h2>
            <div id="finalStats" class="text-center mb-6">
                <!-- Enhanced stats will be populated here -->
            </div>
            <div id="achievements" class="mb-6">
                <!-- New achievements will be shown here -->
            </div>
            <div class="space-y-4">
                <button id="playAgainBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üéÆ" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üéÆ'"> New Mission
                </button>
                <button id="menuBtn" class="w-full btn-secondary py-4 rounded-lg text-lg font-semibold">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png" alt="üè†" class="w-5 h-5 inline mr-2" onerror="this.outerHTML='üè†'"> Command Center
                </button>
            </div>
        </div>
    </div>
    
    <!-- Level Up Modal -->
    <div id="levelUpModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-3xl font-bold text-center mb-6 game-title">Level Up!</h2>
            <div class="text-center mb-6">
                <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üéâ" class="w-16 h-16 mx-auto mb-4" onerror="this.outerHTML='<div class=&quot;text-6xl mb-4&quot;>üéâ</div>'">
                <div class="text-2xl font-bold text-blue-300" id="newLevel">Level 2</div>
                <div class="text-lg text-gray-400" id="newRank">Soldier</div>
                <div class="mt-4 p-4 bg-blue-500/20 rounded-lg">
                    <div class="font-bold text-blue-300 mb-2">New Unlocks:</div>
                    <div id="unlockedFeatures" class="text-sm space-y-1">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
            <button id="levelUpContinueBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">Continue</button>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // ============================================
        // ENHANCED SUPABASE CONFIGURATION
        // ============================================
        
        const SUPABASE_URL = 'https://tzbgavzhciqclgmcmoqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YmdhdnpoY2lxY2xnbWNtb3F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzMwNzYsImV4cCI6MjA2ODc0OTA3Nn0.gwjUMYjSLtiI5u5sBTZpg1S9OqVBhKvTZWttuOYPiek';
        
        let supabase = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.log('Supabase not configured, using enhanced demo mode');
        }
        
        // ============================================
        // ENHANCED ASSET CONFIGURATION
        // ============================================
        
        const ASSET_PATHS = {
            enemies: {
                basic_vampire: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/vampire.png',
                zombie_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/zombie_pizza.png',
                were_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/were_pizza.png',
                monster_food: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/monsterfood-were.png',
                cthulhu_boss: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/cthulu-pizza.png',
                shadow_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/vampire.png',
                armored_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/monsterfood-were.png',
                flying_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/were_pizza.png',
                inferno_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/cthulu-pizza.png',
                ghost_pizza: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/vampire.png'
            },
            
            traps: {
                garlic_tower: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/garlic.png',
                pizza_cutter: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/pizzacutter.png',
                holy_water: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png',
                mirror_trap: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/gem1blue.png',
                stake_launcher: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/anchovy-cannon.png',
                power_generator: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png',
                ice_trap: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/gem1blue.png',
                explosive_trap: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png',
                lightning_rod: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png',
                shield_generator: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/wormhole.png'
            },
            
            ui: {
                game_background: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/game_background.jpg',
                path_texture: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/road_background.png',
                user_avatar: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png'
            },
            
            effects: {
                explosion: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/explosion.png',
                projectile: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/anchovy.png',
                coin_pickup: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png',
                lightning: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png'
            }
        };
        
        // ============================================
        // ENHANCED GLOBAL STATE
        // ============================================
        
        let currentUser = null;
        let gameLoop = null;
        let selectedGameMode = 'classic';
        let selectedDifficulty = 'beginner';
        let playerLevel = 1;
        let playerXP = 0;
        let sessionXP = 0;
        
        let userSettings = {
            autoPause: false,
            showDamageNumbers: true,
            showTrapRanges: true,
            defaultSpeed: 1,
            soundEffects: true,
            backgroundMusic: true,
            masterVolume: 80,
            graphicsQuality: 'medium',
            particleEffects: true,
            screenShake: true,
            animationQuality: true
        };
        
        let gameState = {
            playing: false,
            paused: false,
            wave: 1,
            pizzaBucks: 100,
            lives: 5,
            score: 0,
            kills: 0,
            combo: 0,
            selectedTrap: null,
            sellMode: false,
            upgradeMode: false,
            gameSpeed: 1,
            waveTimer: 30,
            enemies: [],
            traps: [],
            powerups: [],
            projectiles: [],
            effects: [],
            frameCount: 0,
            spawnTimer: 0,
            lastKillTime: 0,
            gameMode: 'classic',
            difficulty: 'beginner',
            sessionXP: 0
        };
        
        // ============================================
        // ENHANCED GAME CONFIGURATION
        // ============================================
        
        const CONFIG = {
            WAVE_DURATION: 45,
            DIFFICULTY_MODIFIERS: {
                beginner: { 
                    spawnRate: 1.5, 
                    enemyHealth: 0.7, 
                    enemySpeed: 0.8, 
                    startMoney: 150, 
                    startLives: 7,
                    xpMultiplier: 1.0
                },
                intermediate: { 
                    spawnRate: 1.0, 
                    enemyHealth: 1.0, 
                    enemySpeed: 1.0, 
                    startMoney: 100, 
                    startLives: 5,
                    xpMultiplier: 1.2
                },
                advanced: { 
                    spawnRate: 0.8, 
                    enemyHealth: 1.3, 
                    enemySpeed: 1.2, 
                    startMoney: 80, 
                    startLives: 4,
                    xpMultiplier: 1.5
                },
                expert: { 
                    spawnRate: 0.6, 
                    enemyHealth: 1.8, 
                    enemySpeed: 1.5, 
                    startMoney: 60, 
                    startLives: 3,
                    xpMultiplier: 2.0
                }
            },
            BASE_ENEMY_SPEED: 1,
            TRAP_COOLDOWNS: {
                fast: 30,
                normal: 60,
                slow: 90
            },
            COMBO_TIMEOUT: 3000,
            POWERUP_SPAWN_CHANCE: 0.1,
            LEVEL_XP_REQUIREMENTS: [0, 100, 250, 500, 800, 1200, 1700, 2300, 3000, 3800, 4700, 5700, 6800, 8000, 9300, 10700, 12200, 13800, 15500, 17300]
        };
        
        // ============================================
        // ENHANCED ENEMY TYPES WITH RARITY
        // ============================================
        
        const ENEMY_TYPES = {
            basic_vampire: {
                name: 'Basic Vampire Pizza',
                health: 80,
                speed: 1.0,
                reward: 15,
                scoreValue: 10,
                color: '#8B4513',
                sprite: ASSET_PATHS.enemies.basic_vampire,
                fallback: 'üßõ',
                abilities: [],
                rarity: 'common',
                spawnWeight: 100,
                minWave: 1,
                xpReward: 2
            },
            
            zombie_pizza: {
                name: 'Zombie Pizza',
                health: 120,
                speed: 0.7,
                reward: 20,
                scoreValue: 15,
                color: '#556B2F',
                sprite: ASSET_PATHS.enemies.zombie_pizza,
                fallback: 'üßü',
                abilities: ['regeneration'],
                rarity: 'common',
                spawnWeight: 80,
                minWave: 2,
                xpReward: 3
            },
            
            were_pizza: {
                name: 'Werewolf Pizza',
                health: 60,
                speed: 2.0,
                reward: 25,
                scoreValue: 20,
                color: '#8B4513',
                sprite: ASSET_PATHS.enemies.were_pizza,
                fallback: 'üê∫',
                abilities: ['speed_boost'],
                rarity: 'uncommon',
                spawnWeight: 60,
                minWave: 3,
                xpReward: 4
            },
            
            shadow_pizza: {
                name: 'Shadow Pizza',
                health: 90,
                speed: 1.5,
                reward: 30,
                scoreValue: 25,
                color: '#4B0082',
                sprite: ASSET_PATHS.enemies.shadow_pizza,
                fallback: 'üëª',
                abilities: ['invisibility'],
                rarity: 'uncommon',
                spawnWeight: 40,
                minWave: 5,
                xpReward: 5
            },
            
            monster_food: {
                name: 'Monster Food',
                health: 200,
                speed: 0.5,
                reward: 35,
                scoreValue: 30,
                color: '#2F4F4F',
                sprite: ASSET_PATHS.enemies.monster_food,
                fallback: 'üëπ',
                abilities: ['armor'],
                rarity: 'rare',
                spawnWeight: 30,
                minWave: 6,
                xpReward: 8
            },
            
            flying_pizza: {
                name: 'Flying Pizza',
                health: 70,
                speed: 1.8,
                reward: 40,
                scoreValue: 35,
                color: '#87CEEB',
                sprite: ASSET_PATHS.enemies.flying_pizza,
                fallback: 'ü¶á',
                abilities: ['flying'],
                rarity: 'rare',
                spawnWeight: 25,
                minWave: 8,
                xpReward: 10
            },
            
            armored_pizza: {
                name: 'Armored Pizza',
                health: 300,
                speed: 0.8,
                reward: 50,
                scoreValue: 40,
                color: '#708090',
                sprite: ASSET_PATHS.enemies.armored_pizza,
                fallback: 'üõ°Ô∏è',
                abilities: ['armor', 'reflect'],
                rarity: 'epic',
                spawnWeight: 15,
                minWave: 10,
                xpReward: 15
            },
            
            inferno_pizza: {
                name: 'Inferno Pizza',
                health: 250,
                speed: 1.3,
                reward: 60,
                scoreValue: 50,
                color: '#FF4500',
                sprite: ASSET_PATHS.enemies.inferno_pizza,
                fallback: 'üî•',
                abilities: ['fire_aura', 'burn'],
                rarity: 'epic',
                spawnWeight: 12,
                minWave: 12,
                xpReward: 18
            },
            
            ghost_pizza: {
                name: 'Ghost Pizza',
                health: 150,
                speed: 2.2,
                reward: 70,
                scoreValue: 60,
                color: '#E6E6FA',
                sprite: ASSET_PATHS.enemies.ghost_pizza,
                fallback: 'üëª',
                abilities: ['phase', 'invisibility'],
                rarity: 'legendary',
                spawnWeight: 8,
                minWave: 15,
                xpReward: 25
            },
            
            cthulhu_boss: {
                name: 'Cthulhu Pizza Boss',
                health: 1000,
                speed: 0.3,
                reward: 200,
                scoreValue: 500,
                color: '#228B22',
                sprite: ASSET_PATHS.enemies.cthulhu_boss,
                fallback: 'üêô',
                abilities: ['boss', 'summon_minions', 'area_damage'],
                isBoss: true,
                rarity: 'boss',
                spawnWeight: 5,
                minWave: 20,
                xpReward: 100
            }
        };
        
        // ============================================
        // ENHANCED TRAP TYPES WITH LEVEL REQUIREMENTS
        // ============================================
        
        const TRAP_TYPES = {
            garlic_tower: {
                name: 'Garlic Tower',
                cost: 25,
                damage: 30,
                range: 100,
                cooldown: 'normal',
                color: '#FFFACD',
                sprite: ASSET_PATHS.traps.garlic_tower,
                fallback: 'üßÑ',
                abilities: ['poison'],
                upgrades: ['damage', 'range', 'poison_duration'],
                requiredLevel: 1
            },
            
            pizza_cutter: {
                name: 'Pizza Cutter',
                cost: 40,
                damage: 50,
                range: 80,
                cooldown: 'fast',
                color: '#C0C0C0',
                sprite: ASSET_PATHS.traps.pizza_cutter,
                fallback: 'üî™',
                abilities: ['slice'],
                upgrades: ['damage', 'attack_speed', 'penetration'],
                requiredLevel: 2
            },
            
            holy_water: {
                name: 'Holy Water Sprinkler',
                cost: 60,
                damage: 40,
                range: 120,
                cooldown: 'normal',
                color: '#87CEEB',
                sprite: ASSET_PATHS.traps.holy_water,
                fallback: 'üíß',
                abilities: ['area_damage', 'holy'],
                upgrades: ['damage', 'area_size', 'holy_power'],
                requiredLevel: 3
            },
            
            mirror_trap: {
                name: 'Mirror Trap',
                cost: 80,
                damage: 60,
                range: 90,
                cooldown: 'normal',
                color: '#E6E6FA',
                sprite: ASSET_PATHS.traps.mirror_trap,
                fallback: 'ü™û',
                abilities: ['reflect', 'stun'],
                upgrades: ['damage', 'stun_duration', 'reflect_chance'],
                requiredLevel: 5
            },
            
            ice_trap: {
                name: 'Ice Trap',
                cost: 70,
                damage: 25,
                range: 110,
                cooldown: 'normal',
                color: '#B0E0E6',
                sprite: ASSET_PATHS.traps.ice_trap,
                fallback: '‚ùÑÔ∏è',
                abilities: ['slow', 'freeze'],
                upgrades: ['slow_power', 'freeze_duration', 'area_size'],
                requiredLevel: 4
            },
            
            stake_launcher: {
                name: 'Stake Launcher',
                cost: 100,
                damage: 80,
                range: 150,
                cooldown: 'slow',
                color: '#8B4513',
                sprite: ASSET_PATHS.traps.stake_launcher,
                fallback: 'üèπ',
                abilities: ['piercing', 'critical'],
                upgrades: ['damage', 'range', 'critical_chance'],
                requiredLevel: 6
            },
            
            explosive_trap: {
                name: 'Explosive Trap',
                cost: 120,
                damage: 100,
                range: 70,
                cooldown: 'slow',
                color: '#FF4500',
                sprite: ASSET_PATHS.traps.explosive_trap,
                fallback: 'üí•',
                abilities: ['explosion', 'area_damage'],
                upgrades: ['damage', 'explosion_radius', 'chain_reaction'],
                requiredLevel: 8
            },
            
            lightning_rod: {
                name: 'Lightning Rod',
                cost: 150,
                damage: 120,
                range: 200,
                cooldown: 'slow',
                color: '#FFD700',
                sprite: ASSET_PATHS.traps.lightning_rod,
                fallback: '‚ö°',
                abilities: ['chain_lightning', 'stun'],
                upgrades: ['damage', 'chain_count', 'stun_duration'],
                requiredLevel: 10
            },
            
            shield_generator: {
                name: 'Shield Generator',
                cost: 200,
                damage: 0,
                range: 80,
                cooldown: 'normal',
                color: '#4169E1',
                sprite: ASSET_PATHS.traps.shield_generator,
                fallback: 'üõ°Ô∏è',
                abilities: ['shield_boost', 'support'],
                upgrades: ['shield_power', 'range', 'efficiency'],
                requiredLevel: 12
            },
            
            power_generator: {
                name: 'Power Generator',
                cost: 300,
                damage: 0,
                range: 60,
                cooldown: 'normal',
                color: '#32CD32',
                sprite: ASSET_PATHS.traps.power_generator,
                fallback: '‚ö°',
                abilities: ['power_boost', 'support'],
                upgrades: ['power_output', 'efficiency', 'range'],
                requiredLevel: 15
            }
        };
        
        // ============================================
        // ENHANCED ACHIEVEMENTS SYSTEM
        // ============================================
        
        const ACHIEVEMENTS = {
            // Combat Achievements
            first_kill: {
                name: 'First Blood',
                description: 'Eliminate your first enemy',
                icon: 'vampire.png',
                xpReward: 10,
                condition: (stats) => stats.totalKills >= 1
            },
            
            vampire_slayer: {
                name: 'Vampire Slayer',
                description: 'Eliminate 100 vampire pizzas',
                icon: 'vampire.png',
                xpReward: 50,
                condition: (stats) => stats.totalKills >= 100
            },
            
            mass_destroyer: {
                name: 'Mass Destroyer',
                description: 'Eliminate 1000 enemies',
                icon: 'explosion.png',
                xpReward: 200,
                condition: (stats) => stats.totalKills >= 1000
            },
            
            combo_master: {
                name: 'Combo Master',
                description: 'Achieve a 10x combo',
                icon: 'orb5.png',
                xpReward: 25,
                condition: (stats) => stats.maxCombo >= 10
            },
            
            combo_legend: {
                name: 'Combo Legend',
                description: 'Achieve a 50x combo',
                icon: 'orb5.png',
                xpReward: 100,
                condition: (stats) => stats.maxCombo >= 50
            },
            
            // Wave Achievements
            wave_survivor: {
                name: 'Wave Survivor',
                description: 'Reach wave 10',
                icon: 'garlic.png',
                xpReward: 30,
                condition: (stats) => stats.maxWave >= 10
            },
            
            wave_master: {
                name: 'Wave Master',
                description: 'Reach wave 25',
                icon: 'wormhole.png',
                xpReward: 75,
                condition: (stats) => stats.maxWave >= 25
            },
            
            wave_legend: {
                name: 'Wave Legend',
                description: 'Reach wave 50',
                icon: 'cthulu-pizza.png',
                xpReward: 150,
                condition: (stats) => stats.maxWave >= 50
            },
            
            // Defense Achievements
            trap_builder: {
                name: 'Trap Builder',
                description: 'Deploy 10 traps in a single game',
                icon: 'garlic.png',
                xpReward: 20,
                condition: (stats) => stats.trapsBuilt >= 10
            },
            
            defense_master: {
                name: 'Defense Master',
                description: 'Deploy 50 traps total',
                icon: 'anchovy-cannon.png',
                xpReward: 40,
                condition: (stats) => stats.totalTrapsBuilt >= 50
            },
            
            fortress_architect: {
                name: 'Fortress Architect',
                description: 'Deploy 200 traps total',
                icon: 'circuit.png',
                xpReward: 100,
                condition: (stats) => stats.totalTrapsBuilt >= 200
            },
            
            // Score Achievements
            high_scorer: {
                name: 'High Scorer',
                description: 'Achieve 10,000 points',
                icon: 'pepperoni1.png',
                xpReward: 25,
                condition: (stats) => stats.highScore >= 10000
            },
            
            score_master: {
                name: 'Score Master',
                description: 'Achieve 100,000 points',
                icon: 'orb5.png',
                xpReward: 75,
                condition: (stats) => stats.highScore >= 100000
            },
            
            score_legend: {
                name: 'Score Legend',
                description: 'Achieve 1,000,000 points',
                icon: 'gem1blue.png',
                xpReward: 200,
                condition: (stats) => stats.highScore >= 1000000
            },
            
            // Survival Achievements
            perfectionist: {
                name: 'Perfectionist',
                description: 'Complete a game without losing a life',
                icon: 'gem1blue.png',
                xpReward: 50,
                condition: (stats) => stats.perfectGames >= 1
            },
            
            survivor: {
                name: 'Survivor',
                description: 'Win 10 games',
                icon: 'pepperoni1.png',
                xpReward: 40,
                condition: (stats) => stats.wins >= 10
            },
            
            veteran: {
                name: 'Veteran',
                description: 'Play 50 games',
                icon: 'anchovy-cannon.png',
                xpReward: 60,
                condition: (stats) => stats.gamesPlayed >= 50
            },
            
            // Special Achievements
            boss_slayer: {
                name: 'Boss Slayer',
                description: 'Defeat 5 boss enemies',
                icon: 'cthulu-pizza.png',
                xpReward: 100,
                condition: (stats) => stats.bossesKilled >= 5
            },
            
            speed_demon: {
                name: 'Speed Demon',
                description: 'Complete a game on 4x speed',
                icon: 'circuit.png',
                xpReward: 30,
                condition: (stats) => stats.speedGames >= 1
            },
            
            pizza_economist: {
                name: 'Pizza Economist',
                description: 'Accumulate 5,000 Pizza Bucks in one game',
                icon: 'orb5.png',
                xpReward: 40,
                condition: (stats) => stats.maxMoney >= 5000
            },
            
            hardcore_player: {
                name: 'Hardcore Player',
                description: 'Win a game on Expert difficulty',
                icon: 'explosion.png',
                xpReward: 150,
                condition: (stats) => stats.expertWins >= 1
            },
            
            // Mode-specific Achievements
            endless_warrior: {
                name: 'Endless Warrior',
                description: 'Survive 30 waves in Endless mode',
                icon: 'wormhole.png',
                xpReward: 80,
                condition: (stats) => stats.endlessWaves >= 30
            },
            
            boss_rush_champion: {
                name: 'Boss Rush Champion',
                description: 'Complete Boss Rush mode',
                icon: 'cthulu-pizza.png',
                xpReward: 120,
                condition: (stats) => stats.bossRushCompleted >= 1
            },
            
            speed_master: {
                name: 'Speed Master',
                description: 'Complete Speed mode in under 10 minutes',
                icon: 'circuit.png',
                xpReward: 90,
                condition: (stats) => stats.fastestSpeedTime <= 600
            }
        };
        
        // ============================================
        // LEVEL SYSTEM
        // ============================================
        
        const LEVEL_REWARDS = {
            2: { traps: ['pizza_cutter'], features: ['Advanced targeting'] },
            3: { traps: ['holy_water'], features: ['Combo system enhanced'] },
            4: { traps: ['ice_trap'], features: ['Freeze effects'] },
            5: { traps: ['mirror_trap'], features: ['Advanced game modes'] },
            6: { traps: ['stake_launcher'], features: ['Critical hit system'] },
            8: { traps: ['explosive_trap'], features: ['Area damage effects'] },
            10: { traps: ['lightning_rod'], features: ['Chain attacks'] },
            12: { traps: ['shield_generator'], features: ['Support traps'] },
            15: { traps: ['power_generator'], features: ['Power amplification'] }
        };
        
        // ============================================
        // ENHANCED UTILITY FUNCTIONS
        // ============================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
                achievement: 'bg-purple-500',
                levelup: 'bg-gradient-to-r from-purple-500 to-pink-500'
            };
            
            notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg font-semibold max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-xl">
                        ${type === 'success' ? '‚úÖ' : 
                          type === 'error' ? '‚ùå' : 
                          type === 'warning' ? '‚ö†Ô∏è' : 
                          type === 'achievement' ? 'üèÜ' : 
                          type === 'levelup' ? '‚¨ÜÔ∏è' : '‚ÑπÔ∏è'}
                    </div>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, duration);
        }
        
        function playSound(soundName) {
            if (!userSettings.soundEffects) return;
            
            // Simulate sound effects with visual feedback
            const soundEffects = {
                shoot: () => console.log('üî´ Shoot sound'),
                explosion: () => console.log('üí• Explosion sound'),
                coin: () => console.log('üí∞ Coin sound'),
                death: () => console.log('üíÄ Death sound'),
                wave: () => console.log('üåä Wave sound'),
                upgrade: () => console.log('‚¨ÜÔ∏è Upgrade sound'),
                error: () => console.log('‚ùå Error sound'),
                levelup: () => console.log('üéâ Level up sound'),
                achievement: () => console.log('üèÜ Achievement sound')
            };
            
            if (soundEffects[soundName]) {
                soundEffects[soundName]();
            }
        }
        
        function createScreenShake() {
            if (!userSettings.screenShake) return;
            
            const canvas = document.getElementById('gameCanvas');
            canvas.style.animation = 'shake 0.5s ease-in-out';
            
            setTimeout(() => {
                canvas.style.animation = '';
            }, 500);
        }
        
        function updatePlayerLevel() {
            const xpNeeded = CONFIG.LEVEL_XP_REQUIREMENTS[playerLevel] || (playerLevel * 100);
            document.getElementById('playerLevel').textContent = `Level ${playerLevel} ${getRankName(playerLevel)}`;
            document.getElementById('playerXP').textContent = `${playerXP} / ${xpNeeded} XP`;
            
            const progress = Math.min((playerXP / xpNeeded) * 100, 100);
            document.getElementById('xpProgress').style.width = `${progress}%`;
        }
        
        function checkLevelUp() {
            const xpNeeded = CONFIG.LEVEL_XP_REQUIREMENTS[playerLevel] || (playerLevel * 100);
            
            if (playerXP >= xpNeeded && playerLevel < 20) {
                playerXP -= xpNeeded;
                playerLevel++;
                
                // Show level up modal
                showLevelUpModal();
                
                // Save progress
                savePlayerProgress();
                
                return true;
            }
            return false;
        }
        
        function showLevelUpModal() {
            const modal = document.getElementById('levelUpModal');
            const rankName = getRankName(playerLevel);
            
            document.getElementById('newLevel').textContent = `Level ${playerLevel}`;
            document.getElementById('newRank').textContent = rankName;
            
            const rewards = LEVEL_REWARDS[playerLevel];
            if (rewards) {
                const featuresHtml = rewards.features?.map(f => `<div>‚Ä¢ ${f}</div>`).join('') || '';
                const trapsHtml = rewards.traps?.map(t => `<div>‚Ä¢ ${TRAP_TYPES[t].name}</div>`).join('') || '';
                
                document.getElementById('unlockedFeatures').innerHTML = featuresHtml + trapsHtml;
            } else {
                document.getElementById('unlockedFeatures').innerHTML = '<div>‚Ä¢ Increased XP multiplier</div>';
            }
            
            modal.classList.remove('hidden');
            playSound('levelup');
            showNotification(`üéâ Level up! Welcome to Level ${playerLevel}!`, 'levelup', 5000);
        }
        
        function getRankName(level) {
            const ranks = [
                'Rookie', 'Soldier', 'Corporal', 'Sergeant', 'Lieutenant',
                'Captain', 'Major', 'Colonel', 'General', 'Marshal',
                'Commander', 'Admiral', 'Supreme Commander', 'War Chief',
                'Battle Master', 'Pizza Guardian', 'Vampire Hunter', 
                'Legendary Defender', 'Pizza God', 'Cosmic Protector'
            ];
            return ranks[Math.min(level - 1, ranks.length - 1)] || 'Legendary';
        }
        
        function addXP(amount) {
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[selectedDifficulty];
            const finalXP = Math.floor(amount * difficultyMod.xpMultiplier);
            
            playerXP += finalXP;
            sessionXP += finalXP;
            gameState.sessionXP = sessionXP;
            
            updatePlayerLevel();
            checkLevelUp();
        }
        
        function savePlayerProgress() {
            const progress = {
                level: playerLevel,
                xp: playerXP,
                lastPlayed: Date.now()
            };
            localStorage.setItem(`playerProgress_${currentUser.id}`, JSON.stringify(progress));
        }
        
        function loadPlayerProgress() {
            const saved = localStorage.getItem(`playerProgress_${currentUser.id}`);
            if (saved) {
                const progress = JSON.parse(saved);
                playerLevel = progress.level || 1;
                playerXP = progress.xp || 0;
            }
            updatePlayerLevel();
        }
        
        // ============================================
        // ENHANCED GAME LOGIC
        // ============================================
        
        function initGame() {
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[selectedDifficulty];
            
            gameState = {
                playing: true,
                paused: false,
                wave: 1,
                pizzaBucks: difficultyMod.startMoney,
                lives: difficultyMod.startLives,
                score: 0,
                kills: 0,
                combo: 0,
                selectedTrap: null,
                sellMode: false,
                upgradeMode: false,
                gameSpeed: userSettings.defaultSpeed,
                waveTimer: CONFIG.WAVE_DURATION,
                enemies: [],
                traps: [],
                powerups: [],
                projectiles: [],
                effects: [],
                frameCount: 0,
                spawnTimer: 0,
                lastKillTime: 0,
                gameMode: selectedGameMode,
                difficulty: selectedDifficulty,
                sessionXP: 0
            };
            
            sessionXP = 0;
            setupEnhancedTrapShop();
            clearCanvas();
            updateUI();
            showScreen('gameScreen');
            startGameLoop();
            
            const modeNames = {
                classic: 'Classic Mode',
                endless: 'Endless Mode', 
                boss_rush: 'Boss Rush',
                speed: 'Speed Mode'
            };
            
            document.getElementById('gameMode').textContent = modeNames[selectedGameMode];
            document.getElementById('gameDifficulty').textContent = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
            
            showNotification(`üöÄ ${modeNames[selectedGameMode]} initialized! Defend the pizzeria!`, 'success');
            playSound('wave');
        }
        
        function setupEnhancedTrapShop() {
            const trapShop = document.getElementById('trapShop');
            trapShop.innerHTML = '';
            
            Object.entries(TRAP_TYPES).forEach(([key, trap]) => {
                const button = document.createElement('button');
                const isUnlocked = playerLevel >= trap.requiredLevel;
                
                button.className = `trap-btn rounded-lg p-3 text-center w-full ${!isUnlocked ? 'opacity-50' : ''}`;
                
                const useImage = userSettings.graphicsQuality !== 'low';
                const display = useImage ? 
                    `<img src="${trap.sprite}" alt="${trap.fallback}" class="w-10 h-10 mx-auto mb-2 object-cover" onerror="this.outerHTML='<div class=&quot;text-3xl mb-2&quot;>${trap.fallback}</div>'">` :
                    `<div class="text-3xl mb-2">${trap.fallback}</div>`;
                
                button.innerHTML = `
                    ${display}
                    <div class="text-sm font-bold">${trap.name}</div>
                    <div class="text-xs text-yellow-400 mb-1">$${trap.cost}</div>
                    <div class="text-xs text-gray-400">DMG: ${trap.damage}</div>
                    <div class="text-xs text-blue-400">RNG: ${trap.range}</div>
                    ${!isUnlocked ? `<div class="text-xs text-red-400">Req: Lv${trap.requiredLevel}</div>` : ''}
                `;
                
                if (isUnlocked) {
                    button.addEventListener('click', () => selectTrap(key));
                } else {
                    button.addEventListener('click', () => {
                        showNotification(`‚ùå Requires Level ${trap.requiredLevel}!`, 'error');
                    });
                }
                
                button.id = `trap_${key}`;
                trapShop.appendChild(button);
            });
        }
        
        function selectTrap(trapType) {
            const trap = TRAP_TYPES[trapType];
            if (playerLevel < trap.requiredLevel) {
                showNotification(`‚ùå Requires Level ${trap.requiredLevel}!`, 'error');
                return;
            }
            
            if (gameState.pizzaBucks >= trap.cost) {
                gameState.selectedTrap = trapType;
                gameState.sellMode = false;
                gameState.upgradeMode = false;
                updateTrapButtons();
                showNotification(`üõ°Ô∏è ${trap.name} selected - Click to deploy!`, 'info');
                playSound('upgrade');
            } else {
                showNotification('‚ùå Insufficient Pizza Bucks!', 'error');
                playSound('error');
            }
        }
        
        function updateTrapButtons() {
            Object.keys(TRAP_TYPES).forEach(key => {
                const button = document.getElementById(`trap_${key}`);
                const trap = TRAP_TYPES[key];
                
                button.classList.remove('selected', 'disabled');
                
                if (gameState.selectedTrap === key) {
                    button.classList.add('selected');
                }
                
                if (gameState.pizzaBucks < trap.cost || playerLevel < trap.requiredLevel) {
                    button.classList.add('disabled');
                }
            });
        }
        
        function getEnemyTypeForWave(wave) {
            // Create weighted list based on wave and rarity
            const availableEnemies = Object.entries(ENEMY_TYPES).filter(([key, enemy]) => {
                return wave >= enemy.minWave;
            });
            
            if (availableEnemies.length === 0) {
                return 'basic_vampire';
            }
            
            // Boss spawn logic
            if (gameState.gameMode === 'boss_rush') {
                return 'cthulhu_boss';
            }
            
            if (wave % 10 === 0 && wave >= 10 && Math.random() < 0.3) {
                return 'cthulhu_boss';
            }
            
            // Create weighted spawn pool
            const spawnPool = [];
            availableEnemies.forEach(([key, enemy]) => {
                // Adjust spawn weight based on wave progression
                let adjustedWeight = enemy.spawnWeight;
                
                // Reduce weight of common enemies in later waves
                if (enemy.rarity === 'common' && wave > 10) {
                    adjustedWeight *= Math.max(0.3, 1 - (wave - 10) * 0.05);
                }
                
                // Increase weight of rare enemies in later waves
                if (enemy.rarity === 'rare' && wave > 8) {
                    adjustedWeight *= 1 + (wave - 8) * 0.1;
                }
                
                if (enemy.rarity === 'epic' && wave > 12) {
                    adjustedWeight *= 1 + (wave - 12) * 0.15;
                }
                
                if (enemy.rarity === 'legendary' && wave > 15) {
                    adjustedWeight *= 1 + (wave - 15) * 0.2;
                }
                
                // Add to spawn pool
                for (let i = 0; i < Math.ceil(adjustedWeight); i++) {
                    spawnPool.push(key);
                }
            });
            
            return spawnPool[Math.floor(Math.random() * spawnPool.length)] || 'basic_vampire';
        }
        
        function spawnEnemy() {
            const enemyType = getEnemyTypeForWave(gameState.wave);
            const enemyTemplate = ENEMY_TYPES[enemyType];
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty];
            
            const healthMultiplier = difficultyMod.enemyHealth * (1 + (gameState.wave * 0.1));
            const speedMultiplier = difficultyMod.enemySpeed * (1 + (gameState.wave * 0.03));
            
            const enemy = {
                id: Date.now() + Math.random(),
                type: enemyType,
                x: 800,
                y: 50 + Math.random() * 400,
                health: Math.floor(enemyTemplate.health * healthMultiplier),
                maxHealth: Math.floor(enemyTemplate.health * healthMultiplier),
                speed: enemyTemplate.speed * speedMultiplier,
                reward: Math.floor(enemyTemplate.reward * (1 + gameState.wave * 0.1)),
                scoreValue: enemyTemplate.scoreValue,
                xpReward: enemyTemplate.xpReward,
                color: enemyTemplate.color,
                sprite: enemyTemplate.sprite,
                fallback: enemyTemplate.fallback,
                abilities: [...enemyTemplate.abilities],
                effects: {},
                shield: enemyTemplate.abilities?.includes('armor') ? Math.floor(enemyTemplate.health * 0.5 * healthMultiplier) : 0,
                maxShield: enemyTemplate.abilities?.includes('armor') ? Math.floor(enemyTemplate.health * 0.5 * healthMultiplier) : 0,
                rarity: enemyTemplate.rarity
            };
            
            gameState.enemies.push(enemy);
            createEnemyElement(enemy);
        }
        
        function createEnemyElement(enemy) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = `enemy ${ENEMY_TYPES[enemy.type].isBoss ? 'boss' : ''}`;
            element.id = `enemy_${enemy.id}`;
            
            const size = ENEMY_TYPES[enemy.type].isBoss ? 60 : 40;
            element.style.cssText = `
                left: ${enemy.x}px;
                top: ${enemy.y}px;
                width: ${size}px;
                height: ${size}px;
                background: ${enemy.color};
                z-index: 10;
            `;
            
            // Add rarity glow effect
            const rarityGlows = {
                uncommon: '0 0 10px rgba(34, 197, 94, 0.5)',
                rare: '0 0 15px rgba(59, 130, 246, 0.6)',
                epic: '0 0 20px rgba(168, 85, 247, 0.7)',
                legendary: '0 0 25px rgba(245, 158, 11, 0.8)',
                boss: '0 0 30px rgba(239, 68, 68, 0.9)'
            };
            
            if (rarityGlows[enemy.rarity]) {
                element.style.boxShadow = rarityGlows[enemy.rarity];
            }
            
            if (userSettings.graphicsQuality !== 'low') {
                element.innerHTML = `<img src="${enemy.sprite}" alt="${enemy.fallback}" class="w-full h-full object-cover rounded-lg" onerror="this.outerHTML='<div class=&quot;w-full h-full flex items-center justify-center text-xl&quot;>${enemy.fallback}</div>'">`;
            } else {
                element.textContent = enemy.fallback;
            }
            
            // Health bar
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar';
            healthBar.innerHTML = '<div class="health-fill" style="width: 100%"></div>';
            element.appendChild(healthBar);
            
            // Shield bar for armored enemies
            if (enemy.shield > 0) {
                const shieldBar = document.createElement('div');
                shieldBar.className = 'shield-bar';
                shieldBar.innerHTML = '<div class="shield-fill" style="width: 100%"></div>';
                element.appendChild(shieldBar);
            }
            
            canvas.appendChild(element);
        }
        
        function updateEnemies() {
            gameState.enemies.forEach((enemy, index) => {
                // Apply movement
                let moveSpeed = enemy.speed * gameState.gameSpeed;
                
                // Apply effects
                if (enemy.effects.slow) {
                    moveSpeed *= 0.5;
                    enemy.effects.slow--;
                    if (enemy.effects.slow <= 0) delete enemy.effects.slow;
                }
                
                if (enemy.effects.freeze) {
                    moveSpeed = 0;
                    enemy.effects.freeze--;
                    if (enemy.effects.freeze <= 0) delete enemy.effects.freeze;
                }
                
                enemy.x -= moveSpeed;
                
                const element = document.getElementById(`enemy_${enemy.id}`);
                if (element) {
                    element.style.left = `${enemy.x}px`;
                    
                    // Update health bar
                    const healthFill = element.querySelector('.health-fill');
                    if (healthFill) {
                        healthFill.style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
                    }
                    
                    // Update shield bar
                    const shieldFill = element.querySelector('.shield-fill');
                    if (shieldFill) {
                        shieldFill.style.width = `${(enemy.shield / enemy.maxShield) * 100}%`;
                    }
                    
                    // Apply visual effects
                    if (enemy.effects.freeze) {
                        element.style.filter = 'hue-rotate(240deg) brightness(0.8)';
                    } else if (enemy.effects.slow) {
                        element.style.filter = 'hue-rotate(60deg)';
                    } else {
                        element.style.filter = '';
                    }
                }
                
                // Check if reached end
                if (enemy.x < -60) {
                    gameState.lives--;
                    element?.remove();
                    gameState.enemies.splice(index, 1);
                    showNotification('üö® Enemy breakthrough! Life lost!', 'error');
                    playSound('death');
                    createScreenShake();
                    
                    if (gameState.lives <= 0) {
                        gameOver();
                    }
                    return;
                }
                
                // Check if dead
                if (enemy.health <= 0) {
                    gameState.pizzaBucks += enemy.reward;
                    gameState.score += enemy.scoreValue * (gameState.combo + 1);
                    gameState.kills++;
                    
                    // Add XP
                    addXP(enemy.xpReward);
                    
                    // Update combo
                    if (Date.now() - gameState.lastKillTime < CONFIG.COMBO_TIMEOUT) {
                        gameState.combo++;
                    } else {
                        gameState.combo = 1;
                    }
                    gameState.lastKillTime = Date.now();
                    
                    element?.remove();
                    gameState.enemies.splice(index, 1);
                    
                    // Show enhanced damage numbers
                    if (userSettings.showDamageNumbers) {
                        showEnhancedDamageNumber(enemy.x, enemy.y, enemy.reward, 'money');
                        if (gameState.combo > 1) {
                            showEnhancedDamageNumber(enemy.x, enemy.y - 25, `${gameState.combo}x COMBO!`, 'critical');
                        }
                        showEnhancedDamageNumber(enemy.x, enemy.y - 40, `+${enemy.xpReward} XP`, 'heal');
                    }
                    
                    // Create death effect
                    if (userSettings.particleEffects) {
                        createExplosionEffect(enemy.x, enemy.y);
                    }
                    
                    // Chance to spawn powerup (higher for rare enemies)
                    let powerupChance = CONFIG.POWERUP_SPAWN_CHANCE;
                    if (enemy.rarity === 'rare') powerupChance *= 2;
                    if (enemy.rarity === 'epic') powerupChance *= 3;
                    if (enemy.rarity === 'legendary') powerupChance *= 4;
                    if (enemy.rarity === 'boss') powerupChance *= 5;
                    
                    if (Math.random() < powerupChance) {
                        spawnPowerup(enemy.x, enemy.y);
                    }
                    
                    playSound('coin');
                }
            });
        }
        
        function showEnhancedDamageNumber(x, y, amount, type) {
            const canvas = document.getElementById('gameCanvas');
            const damageText = document.createElement('div');
            damageText.className = `damage-number ${type}`;
            damageText.style.cssText = `
                left: ${x}px;
                top: ${y}px;
                z-index: 20;
                pointer-events: none;
            `;
            
            if (type === 'money') {
                damageText.textContent = `+$${amount}`;
            } else if (type === 'heal') {
                damageText.textContent = amount;
            } else {
                damageText.textContent = amount;
            }
            
            canvas.appendChild(damageText);
            setTimeout(() => damageText.remove(), 1500);
        }
        
        function createExplosionEffect(x, y) {
            const canvas = document.getElementById('gameCanvas');
            const explosion = document.createElement('div');
            explosion.className = 'explosion-effect';
            explosion.style.cssText = `
                left: ${x - 30}px;
                top: ${y - 30}px;
            `;
            
            canvas.appendChild(explosion);
            setTimeout(() => explosion.remove(), 500);
        }
        
        function spawnPowerup(x, y) {
            const powerupTypes = ['health', 'money', 'speed', 'damage', 'xp'];
            const type = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
            
            const powerup = {
                id: Date.now() + Math.random(),
                type: type,
                x: x,
                y: y,
                lifetime: 300 // 5 seconds at 60fps
            };
            
            gameState.powerups.push(powerup);
            createPowerupElement(powerup);
        }
        
        function createPowerupElement(powerup) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = 'powerup';
            element.id = `powerup_${powerup.id}`;
            
            const icons = {
                health: '‚ù§Ô∏è',
                money: 'üí∞',
                speed: '‚ö°',
                damage: 'üí•',
                xp: '‚≠ê'
            };
            
            element.style.cssText = `
                left: ${powerup.x}px;
                top: ${powerup.y}px;
                width: 30px;
                height: 30px;
                background: linear-gradient(45deg, #FFD700, #FFA500);
                z-index: 12;
                border-radius: 50%;
                cursor: pointer;
            `;
            
            element.textContent = icons[powerup.type];
            element.addEventListener('click', () => collectPowerup(powerup));
            
            canvas.appendChild(element);
        }
        
        function collectPowerup(powerup) {
            const effects = {
                health: () => {
                    gameState.lives++;
                    showNotification('‚ù§Ô∏è Life restored!', 'success');
                },
                money: () => {
                    const bonus = 50 + gameState.wave * 5;
                    gameState.pizzaBucks += bonus;
                    showNotification(`üí∞ Bonus: $${bonus}!`, 'success');
                },
                speed: () => {
                    showNotification('‚ö° Turbo boost activated!', 'success');
                    // Temporary speed boost for all traps
                },
                damage: () => {
                    showNotification('üí• Damage amplifier activated!', 'success');
                    // Temporary damage boost for all traps
                },
                xp: () => {
                    const xpBonus = 25 + gameState.wave * 2;
                    addXP(xpBonus);
                    showNotification(`‚≠ê XP Bonus: +${xpBonus}!`, 'success');
                }
            };
            
            effects[powerup.type]();
            
            const element = document.getElementById(`powerup_${powerup.id}`);
            element?.remove();
            
            gameState.powerups = gameState.powerups.filter(p => p.id !== powerup.id);
            playSound('upgrade');
        }
        
        function updateTraps() {
            gameState.traps.forEach(trap => {
                trap.cooldown = Math.max(0, trap.cooldown - 1);
                
                const element = document.getElementById(`trap_${trap.id}`);
                if (element) {
                    if (trap.cooldown === 0) {
                        element.classList.add('ready');
                        element.classList.remove('cooldown');
                    } else {
                        element.classList.remove('ready');
                        element.classList.add('cooldown');
                    }
                }
                
                if (trap.cooldown === 0) {
                    const targets = findTargetsInRange(trap);
                    if (targets.length > 0) {
                        attackTargets(trap, targets);
                        trap.cooldown = CONFIG.TRAP_COOLDOWNS[TRAP_TYPES[trap.type].cooldown] || 60;
                    }
                }
            });
        }
        
        function findTargetsInRange(trap) {
            const targets = [];
            const trapType = TRAP_TYPES[trap.type];
            
            gameState.enemies.forEach(enemy => {
                const distance = Math.sqrt(
                    Math.pow(enemy.x - trap.x, 2) + 
                    Math.pow(enemy.y - trap.y, 2)
                );
                
                if (distance <= trap.range) {
                    targets.push(enemy);
                }
            });
            
            // Sort by distance (closest first)
            targets.sort((a, b) => {
                const distA = Math.sqrt(Math.pow(a.x - trap.x, 2) + Math.pow(a.y - trap.y, 2));
                const distB = Math.sqrt(Math.pow(b.x - trap.x, 2) + Math.pow(b.y - trap.y, 2));
                return distA - distB;
            });
            
            return targets;
        }
        
        function attackTargets(trap, targets) {
            const trapType = TRAP_TYPES[trap.type];
            const primary = targets[0];
            
            if (trapType.abilities.includes('area_damage')) {
                // Area damage hits multiple targets
                targets.slice(0, 5).forEach(target => {
                    damageEnemy(target, trap.damage, trap);
                });
                createExplosionEffect(primary.x, primary.y);
            } else if (trapType.abilities.includes('chain_lightning')) {
                // Chain lightning
                let currentTarget = primary;
                for (let i = 0; i < 3 && currentTarget; i++) {
                    damageEnemy(currentTarget, trap.damage * (0.8 ** i), trap);
                    createLightningEffect(trap.x, trap.y, currentTarget.x, currentTarget.y);
                    
                    // Find next closest target
                    const remaining = targets.filter(t => t !== currentTarget);
                    currentTarget = remaining.length > 0 ? remaining[0] : null;
                }
            } else {
                // Single target
                damageEnemy(primary, trap.damage, trap);
                createProjectileEffect(trap.x, trap.y, primary.x, primary.y, trapType.color);
            }
            
            playSound('shoot');
        }
        
        function damageEnemy(enemy, damage, trap) {
            const trapType = TRAP_TYPES[trap.type];
            let finalDamage = damage;
            
            // Apply special effects
            if (trapType.abilities.includes('poison')) {
                enemy.effects.poison = 60; // 1 second of poison
            }
            
            if (trapType.abilities.includes('slow')) {
                enemy.effects.slow = 120; // 2 seconds of slow
            }
            
            if (trapType.abilities.includes('freeze')) {
                enemy.effects.freeze = 60; // 1 second of freeze
            }
            
            if (trapType.abilities.includes('stun')) {
                enemy.effects.stun = 30; // 0.5 seconds of stun
            }
            
            // Critical hit chance
            if (trapType.abilities.includes('critical') && Math.random() < 0.2) {
                finalDamage *= 2;
                if (userSettings.showDamageNumbers) {
                    showEnhancedDamageNumber(enemy.x, enemy.y - 30, 'CRITICAL!', 'critical');
                }
            }
            
            // Apply damage to shield first, then health
            if (enemy.shield > 0) {
                const shieldDamage = Math.min(finalDamage, enemy.shield);
                enemy.shield -= shieldDamage;
                finalDamage -= shieldDamage;
            }
            
            if (finalDamage > 0) {
                enemy.health -= finalDamage;
            }
            
            if (userSettings.showDamageNumbers) {
                showEnhancedDamageNumber(enemy.x, enemy.y - 15, finalDamage, 'damage');
            }
        }
        
        function createProjectileEffect(fromX, fromY, toX, toY, color) {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            projectile.style.cssText = `
                left: ${fromX}px;
                top: ${fromY}px;
                width: 8px;
                height: 8px;
                background: ${color};
                z-index: 15;
                transition: all 0.3s ease;
            `;
            
            canvas.appendChild(projectile);
            
            setTimeout(() => {
                projectile.style.left = `${toX}px`;
                projectile.style.top = `${toY}px`;
            }, 10);
            
            setTimeout(() => {
                projectile.remove();
            }, 300);
        }
        
        function createLightningEffect(fromX, fromY, toX, toY) {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            const lightning = document.createElement('div');
            lightning.className = 'lightning-effect';
            
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            
            lightning.style.cssText = `
                left: ${fromX}px;
                top: ${fromY}px;
                width: ${length}px;
                height: 4px;
                transform: rotate(${angle}rad);
                transform-origin: left center;
            `;
            
            canvas.appendChild(lightning);
            setTimeout(() => lightning.remove(), 200);
        }
        
        function updateWave() {
            gameState.waveTimer -= 1/60;
            
            if (gameState.waveTimer <= 0) {
                gameState.wave++;
                gameState.waveTimer = CONFIG.WAVE_DURATION;
                
                // Check victory condition for non-endless modes
                if (selectedGameMode === 'classic' && gameState.wave > 25) {
                    victory();
                    return;
                } else if (selectedGameMode === 'boss_rush' && gameState.wave > 10) {
                    victory();
                    return;
                } else if (selectedGameMode === 'speed' && gameState.wave > 15) {
                    victory();
                    return;
                }
                
                showNotification(`üåä Wave ${gameState.wave} incoming!`, 'warning');
                playSound('wave');
                
                if (userSettings.autoPause) {
                    gameState.paused = true;
                    showNotification('‚è∏Ô∏è Auto-paused between waves', 'info');
                }
            }
        }
        
        function updatePowerups() {
            gameState.powerups.forEach((powerup, index) => {
                powerup.lifetime--;
                if (powerup.lifetime <= 0) {
                    const element = document.getElementById(`powerup_${powerup.id}`);
                    element?.remove();
                    gameState.powerups.splice(index, 1);
                }
            });
        }
        
        function updateUI() {
            document.getElementById('pizzaBucks').textContent = gameState.pizzaBucks;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('kills').textContent = gameState.kills;
            document.getElementById('score').textContent = gameState.score.toLocaleString();
            document.getElementById('enemiesLeft').textContent = gameState.enemies.length;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('currentWave').textContent = gameState.wave;
            document.getElementById('waveTimer').textContent = `${Math.ceil(gameState.waveTimer)}s`;
            document.getElementById('speedBtn').textContent = `${gameState.gameSpeed}x`;
            document.getElementById('sessionXP').textContent = sessionXP;
            
            // Update wave progress
            const progress = ((CONFIG.WAVE_DURATION - gameState.waveTimer) / CONFIG.WAVE_DURATION) * 100;
            document.getElementById('waveProgress').style.width = `${progress}%`;
            
            // Update wave info
            const nextEnemyType = getEnemyTypeForWave(gameState.wave);
            document.getElementById('waveInfo').textContent = `Next: ${ENEMY_TYPES[nextEnemyType].name}`;
            
            updateTrapButtons();
        }
        
        function gameUpdate() {
            if (!gameState.playing || gameState.paused) return;
            
            gameState.frameCount++;
            gameState.spawnTimer++;
            
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty];
            const spawnInterval = (difficultyMod.spawnRate * 60);
            
            // Spawn enemies
            if (gameState.spawnTimer >= spawnInterval) {
                spawnEnemy();
                gameState.spawnTimer = 0;
            }
            
            updateEnemies();
            updateTraps();
            updatePowerups();
            updateWave();
            updateUI();
        }
        
        function startGameLoop() {
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(gameUpdate, 1000 / 60); // 60 FPS
        }
        
        function pauseGame() {
            gameState.paused = !gameState.paused;
            document.getElementById('pauseModal').classList.toggle('hidden', !gameState.paused);
            
            if (gameState.paused) {
                showNotification('‚è∏Ô∏è Mission paused', 'info');
            } else {
                showNotification('‚ñ∂Ô∏è Mission resumed', 'success');
            }
        }
        
        function victory() {
            gameState.playing = false;
            if (gameLoop) clearInterval(gameLoop);
            
            // Calculate final XP bonus
            const completionBonus = 100 + (gameState.wave * 10);
            addXP(completionBonus);
            
            document.getElementById('gameOverTitle').textContent = 'üéâ Mission Accomplished!';
            document.getElementById('finalStats').innerHTML = `
                <div class="space-y-3">
                    <div class="text-2xl text-green-400 font-bold">VICTORY!</div>
                    <div class="text-xl">Final Score: <span class="text-primary font-bold">${gameState.score.toLocaleString()}</span></div>
                    <div class="text-lg">Waves Completed: <span class="text-secondary font-bold">${gameState.wave - 1}</span></div>
                    <div class="text-lg">Enemies Eliminated: <span class="text-accent font-bold">${gameState.kills}</span></div>
                    <div class="text-lg">Max Combo: <span class="text-purple-400 font-bold">${gameState.combo}</span></div>
                    <div class="text-lg">Lives Remaining: <span class="text-green-400 font-bold">${gameState.lives}</span></div>
                    <div class="text-lg">XP Earned: <span class="text-blue-400 font-bold">${sessionXP}</span></div>
                    <div class="text-lg">Difficulty: <span class="text-yellow-400 font-bold">${gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1)}</span></div>
                </div>
            `;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveGameData();
            checkAchievements();
            showNotification('üéâ Victory achieved!', 'achievement', 5000);
            playSound('achievement');
        }
        
        function gameOver() {
            gameState.playing = false;
            if (gameLoop) clearInterval(gameLoop);
            
            // Calculate final XP (reduced for defeat)
            const defeatBonus = Math.floor((gameState.kills * 2) + (gameState.wave * 5));
            addXP(defeatBonus);
            
            document.getElementById('gameOverTitle').textContent = 'üíÄ Mission Failed';
            document.getElementById('finalStats').innerHTML = `
                <div class="space-y-3">
                    <div class="text-2xl text-red-400 font-bold">DEFEAT</div>
                    <div class="text-xl">Final Score: <span class="text-primary font-bold">${gameState.score.toLocaleString()}</span></div>
                    <div class="text-lg">Wave Reached: <span class="text-secondary font-bold">${gameState.wave}</span></div>
                    <div class="text-lg">Enemies Eliminated: <span class="text-accent font-bold">${gameState.kills}</span></div>
                    <div class="text-lg">Max Combo: <span class="text-purple-400 font-bold">${gameState.combo}</span></div>
                    <div class="text-lg">XP Earned: <span class="text-blue-400 font-bold">${sessionXP}</span></div>
                    <div class="text-lg">Difficulty: <span class="text-yellow-400 font-bold">${gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1)}</span></div>
                </div>
            `;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveGameData();
            checkAchievements();
            showNotification('üíÄ Mission failed!', 'error');
            playSound('death');
        }
        
        function checkAchievements() {
            const currentStats = getCurrentStats();
            const newAchievements = [];
            
            Object.entries(ACHIEVEMENTS).forEach(([key, achievement]) => {
                const isUnlocked = JSON.parse(localStorage.getItem(`achievement_${currentUser.id}_${key}`) || 'false');
                
                if (!isUnlocked && achievement.condition(currentStats)) {
                    localStorage.setItem(`achievement_${currentUser.id}_${key}`, 'true');
                    newAchievements.push(achievement);
                    addXP(achievement.xpReward);
                    showNotification(`üèÜ Achievement Unlocked: ${achievement.name}!`, 'achievement', 5000);
                    playSound('achievement');
                }
            });
            
            if (newAchievements.length > 0) {
                displayNewAchievements(newAchievements);
            }
        }
        
        function getCurrentStats() {
            const saved = JSON.parse(localStorage.getItem(`userStats_${currentUser.id}`) || '{}');
            return {
                highScore: Math.max(saved.highScore || 0, gameState.score),
                maxWave: Math.max(saved.maxWave || 0, gameState.wave),
                totalKills: (saved.totalKills || 0) + gameState.kills,
                maxCombo: Math.max(saved.maxCombo || 0, gameState.combo),
                gamesPlayed: (saved.gamesPlayed || 0) + 1,
                wins: (saved.wins || 0) + (gameState.lives > 0 ? 1 : 0),
                trapsBuilt: gameState.traps.length,
                totalTrapsBuilt: (saved.totalTrapsBuilt || 0) + gameState.traps.length,
                perfectGames: (saved.perfectGames || 0) + (gameState.lives === CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty].startLives ? 1 : 0),
                bossesKilled: (saved.bossesKilled || 0) + gameState.enemies.filter(e => e.rarity === 'boss').length,
                speedGames: (saved.speedGames || 0) + (gameState.gameSpeed === 4 ? 1 : 0),
                maxMoney: Math.max(saved.maxMoney || 0, gameState.pizzaBucks),
                expertWins: (saved.expertWins || 0) + (gameState.difficulty === 'expert' && gameState.lives > 0 ? 1 : 0),
                endlessWaves: gameState.gameMode === 'endless' ? Math.max(saved.endlessWaves || 0, gameState.wave) : (saved.endlessWaves || 0),
                bossRushCompleted: (saved.bossRushCompleted || 0) + (gameState.gameMode === 'boss_rush' && gameState.lives > 0 ? 1 : 0),
                fastestSpeedTime: gameState.gameMode === 'speed' ? Math.min(saved.fastestSpeedTime || 999999, gameState.frameCount / 60) : (saved.fastestSpeedTime || 999999)
            };
        }
        
        function displayNewAchievements(achievements) {
            const achievementsHtml = achievements.map(achievement => `
                <div class="bg-yellow-500/20 rounded-lg p-3 mb-2">
                    <div class="flex items-center space-x-3">
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/${achievement.icon}" alt="üèÜ" class="w-8 h-8" onerror="this.outerHTML='<div class=&quot;text-2xl&quot;>üèÜ</div>'">
                        <div>
                            <div class="font-bold text-yellow-300">${achievement.name}</div>
                            <div class="text-sm text-gray-300">${achievement.description}</div>
                            <div class="text-xs text-blue-400">+${achievement.xpReward} XP</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('achievements').innerHTML = `
                <h3 class="text-lg font-bold text-yellow-300 mb-3">üèÜ New Achievements!</h3>
                ${achievementsHtml}
            `;
        }
        
        async function saveGameData() {
            if (!currentUser) return;
            
            const gameData = {
                user_id: currentUser.id,
                final_score: gameState.score,
                waves_completed: gameState.wave,
                enemies_killed: gameState.kills,
                max_combo: gameState.combo,
                session_duration_seconds: Math.floor(gameState.frameCount / 60),
                is_victory: gameState.lives > 0,
                game_mode: gameState.gameMode,
                difficulty: gameState.difficulty,
                xp_earned: sessionXP
            };
            
            if (supabase && currentUser.id !== 'guest') {
                try {
                    await supabase.from('game_sessions').insert(gameData);
                } catch (error) {
                    console.error('Error saving game data:', error);
                }
            } else {
                // Save to localStorage for guests/demo
                const currentStats = getCurrentStats();
                localStorage.setItem(`userStats_${currentUser.id}`, JSON.stringify(currentStats));
            }
            
            savePlayerProgress();
        }
        
        function clearCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const entities = canvas.querySelectorAll('.enemy, .trap, .powerup, .projectile, .explosion-effect, .lightning-effect, .damage-number');
            entities.forEach(entity => entity.remove());
        }
        
        // ============================================
        // ENHANCED CANVAS INTERACTION
        // ============================================
        
        function setupCanvasEvents() {
            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('click', (e) => {
                if (!gameState.playing || gameState.paused) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Don't allow building on the path
                if (x < 150) {
                    showNotification('‚ùå Cannot build on the path!', 'error');
                    return;
                }
                
                if (gameState.sellMode) {
                    sellTrapAt(x, y);
                } else if (gameState.upgradeMode) {
                    upgradeTrapAt(x, y);
                } else if (gameState.selectedTrap) {
                    buildTrap(x, y);
                }
            });
            
            // Show range preview on hover
            canvas.addEventListener('mousemove', (e) => {
                if (!gameState.selectedTrap || gameState.paused) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                showRangePreview(x, y);
            });
            
            canvas.addEventListener('mouseleave', hideRangePreview);
        }
        
        function buildTrap(x, y) {
            const trapType = TRAP_TYPES[gameState.selectedTrap];
            
            // Check level requirement
            if (playerLevel < trapType.requiredLevel) {
                showNotification(`‚ùå Requires Level ${trapType.requiredLevel}!`, 'error');
                return;
            }
            
            // Check for overlapping traps
            const overlap = gameState.traps.some(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance < 50;
            });
            
            if (overlap) {
                showNotification('‚ùå Too close to another trap!', 'error');
                return;
            }
            
            if (gameState.pizzaBucks >= trapType.cost) {
                gameState.pizzaBucks -= trapType.cost;
                
                const trap = {
                    id: Date.now(),
                    type: gameState.selectedTrap,
                    x: x,
                    y: y,
                    damage: trapType.damage,
                    range: trapType.range,
                    cooldown: 0,
                    level: 1,
                    kills: 0
                };
                
                gameState.traps.push(trap);
                createTrapElement(trap);
                
                gameState.selectedTrap = null;
                updateTrapButtons();
                showNotification(`üõ°Ô∏è ${trapType.name} deployed!`, 'success');
                playSound('upgrade');
            }
        }
        
        function createTrapElement(trap) {
            const canvas = document.getElementById('gameCanvas');
            const trapType = TRAP_TYPES[trap.type];
            
            const element = document.createElement('div');
            element.className = 'trap';
            element.id = `trap_${trap.id}`;
            element.style.cssText = `
                left: ${trap.x - 20}px;
                top: ${trap.y - 20}px;
                width: 40px;
                height: 40px;
                background: ${trapType.color};
                z-index: 5;
                cursor: pointer;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 8px;
            `;
            
            if (userSettings.graphicsQuality !== 'low') {
                element.innerHTML = `<img src="${trapType.sprite}" alt="${trapType.fallback}" class="w-full h-full object-cover rounded-lg" onerror="this.outerHTML='<div class=&quot;w-full h-full flex items-center justify-center text-xl&quot;>${trapType.fallback}</div>'">`;
            } else {
                element.textContent = trapType.fallback;
            }
            
            // Level indicator
            if (trap.level > 1) {
                const levelIndicator = document.createElement('div');
                levelIndicator.className = 'absolute -top-2 -right-2 w-4 h-4 bg-green-500 rounded-full text-xs flex items-center justify-center text-white font-bold';
                levelIndicator.textContent = trap.level;
                element.appendChild(levelIndicator);
            }
            
            // Show range on hover if enabled
            if (userSettings.showTrapRanges) {
                element.addEventListener('mouseenter', () => showTrapRange(trap));
                element.addEventListener('mouseleave', hideTrapRange);
            }
            
            canvas.appendChild(element);
        }
        
        function showRangePreview(x, y) {
            if (!gameState.selectedTrap) return;
            
            hideRangePreview();
            
            const canvas = document.getElementById('gameCanvas');
            const trapType = TRAP_TYPES[gameState.selectedTrap];
            const rangeCircle = document.createElement('div');
            rangeCircle.id = 'rangePreview';
            rangeCircle.style.cssText = `
                position: absolute;
                left: ${x - trapType.range}px;
                top: ${y - trapType.range}px;
                width: ${trapType.range * 2}px;
                height: ${trapType.range * 2}px;
                border: 2px dashed rgba(124, 58, 237, 0.7);
                border-radius: 50%;
                z-index: 1;
                pointer-events: none;
                background: rgba(124, 58, 237, 0.1);
            `;
            canvas.appendChild(rangeCircle);
        }
        
        function hideRangePreview() {
            const preview = document.getElementById('rangePreview');
            preview?.remove();
        }
        
        function showTrapRange(trap) {
            hideTrapRange();
            
            const canvas = document.getElementById('gameCanvas');
            const rangeCircle = document.createElement('div');
            rangeCircle.id = 'trapRange';
            rangeCircle.style.cssText = `
                position: absolute;
                left: ${trap.x - trap.range}px;
                top: ${trap.y - trap.range}px;
                width: ${trap.range * 2}px;
                height: ${trap.range * 2}px;
                border: 2px solid rgba(16, 185, 129, 0.7);
                border-radius: 50%;
                z-index: 1;
                pointer-events: none;
                background: rgba(16, 185, 129, 0.1);
            `;
            canvas.appendChild(rangeCircle);
        }
        
        function hideTrapRange() {
            const rangeCircle = document.getElementById('trapRange');
            rangeCircle?.remove();
        }
        
        function sellTrapAt(x, y) {
            const clickedTrap = gameState.traps.find(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance <= 25;
            });
            
            if (clickedTrap) {
                const trapType = TRAP_TYPES[clickedTrap.type];
                const sellPrice = Math.floor(trapType.cost * 0.8 * clickedTrap.level);
                
                gameState.pizzaBucks += sellPrice;
                gameState.traps = gameState.traps.filter(t => t.id !== clickedTrap.id);
                
                const element = document.getElementById(`trap_${clickedTrap.id}`);
                element?.remove();
                
                showNotification(`üí∞ Salvaged ${trapType.name} for $${sellPrice}!`, 'success');
                playSound('coin');
            }
        }
        
        function upgradeTrapAt(x, y) {
            const clickedTrap = gameState.traps.find(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance <= 25;
            });
            
            if (clickedTrap) {
                const trapType = TRAP_TYPES[clickedTrap.type];
                const upgradeCost = trapType.cost * clickedTrap.level;
                
                if (gameState.pizzaBucks >= upgradeCost && clickedTrap.level < 5) {
                    gameState.pizzaBucks -= upgradeCost;
                    clickedTrap.level++;
                    clickedTrap.damage = Math.floor(trapType.damage * (1 + 0.5 * (clickedTrap.level - 1)));
                    clickedTrap.range = Math.floor(trapType.range * (1 + 0.2 * (clickedTrap.level - 1)));
                    
                    // Update visual
                    const element = document.getElementById(`trap_${clickedTrap.id}`);
                    if (element) {
                        element.style.transform = `scale(${1 + 0.1 * (clickedTrap.level - 1)})`;
                        element.style.filter = `brightness(${1 + 0.2 * (clickedTrap.level - 1)})`;
                    }
                    
                    createTrapElement(clickedTrap); // Recreate with level indicator
                    element?.remove();
                    
                    showNotification(`‚¨ÜÔ∏è ${trapType.name} upgraded to Level ${clickedTrap.level}!`, 'success');
                    playSound('upgrade');
                } else if (clickedTrap.level >= 5) {
                    showNotification('‚ö†Ô∏è Maximum level reached!', 'warning');
                } else {
                    showNotification('‚ùå Insufficient funds for upgrade!', 'error');
                }
            }
        }
        
        // ============================================
        // ENHANCED EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // Auth events
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('playAsGuestBtn').addEventListener('click', playAsGuest);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Form toggles
            document.getElementById('showSignupBtn').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            });
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            
            // Difficulty selection
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedDifficulty = btn.dataset.difficulty;
                });
            });
            
            // Game mode selection
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedGameMode = btn.dataset.mode;
                });
            });
            
            // Menu events
            document.getElementById('startGameBtn').addEventListener('click', initGame);
            document.getElementById('leaderboardBtn').addEventListener('click', () => {
                showScreen('leaderboardScreen');
                loadLeaderboard('score');
            });
            document.getElementById('profileBtn').addEventListener('click', () => {
                showScreen('profileScreen');
                loadProfile();
            });
            document.getElementById('settingsBtn').addEventListener('click', () => {
                showScreen('settingsScreen');
            });
            
            // Back buttons
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                gameState.playing = false;
                if (gameLoop) clearInterval(gameLoop);
                showMainMenu();
            });
            document.getElementById('backFromLeaderboardBtn').addEventListener('click', () => showMainMenu());
            document.getElementById('backFromProfileBtn').addEventListener('click', () => showMainMenu());
            document.getElementById('backFromSettingsBtn').addEventListener('click', () => showMainMenu());
            
            // Game events
            document.getElementById('pauseGameBtn').addEventListener('click', pauseGame);
            document.getElementById('speedBtn').addEventListener('click', () => {
                gameState.gameSpeed = gameState.gameSpeed >= 4 ? 1 : gameState.gameSpeed + 1;
            });
            
            // Enhanced game actions
            document.getElementById('sellModeBtn').addEventListener('click', () => {
                gameState.sellMode = !gameState.sellMode;
                gameState.selectedTrap = null;
                gameState.upgradeMode = false;
                const btn = document.getElementById('sellModeBtn');
                btn.textContent = gameState.sellMode ? 'üî® Build Mode' : 'üí∞ Salvage Mode';
                btn.innerHTML = gameState.sellMode ? 
                    '<img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üî®" class="w-5 h-5 inline mr-2" onerror="this.outerHTML=\'üî®\'"> Build Mode' :
                    '<img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/orb5.png" alt="üí∞" class="w-5 h-5 inline mr-2" onerror="this.outerHTML=\'üí∞\'"> Salvage Mode';
                btn.className = gameState.sellMode ? 
                    'w-full bg-yellow-500/20 hover:bg-yellow-500/30 py-3 rounded-lg transition-colors font-semibold' :
                    'w-full bg-red-500/20 hover:bg-red-500/30 py-3 rounded-lg transition-colors font-semibold';
                updateTrapButtons();
                showNotification(gameState.sellMode ? 'üí∞ Salvage mode activated' : 'üî® Build mode activated', 'info');
            });
            
            document.getElementById('upgradeMode').addEventListener('click', () => {
                gameState.upgradeMode = !gameState.upgradeMode;
                gameState.selectedTrap = null;
                gameState.sellMode = false;
                const btn = document.getElementById('upgradeMode');
                btn.innerHTML = gameState.upgradeMode ? 
                    '<img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="üî®" class="w-5 h-5 inline mr-2" onerror="this.outerHTML=\'üî®\'"> Build Mode' :
                    '<img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/circuit.png" alt="‚¨ÜÔ∏è" class="w-5 h-5 inline mr-2" onerror="this.outerHTML=\'‚¨ÜÔ∏è\'"> Upgrade Mode';
                btn.className = gameState.upgradeMode ? 
                    'w-full bg-yellow-500/20 hover:bg-yellow-500/30 py-3 rounded-lg transition-colors font-semibold' :
                    'w-full bg-green-500/20 hover:bg-green-500/30 py-3 rounded-lg transition-colors font-semibold';
                updateTrapButtons();
                showNotification(gameState.upgradeMode ? '‚¨ÜÔ∏è Upgrade mode activated' : 'üî® Build mode activated', 'info');
            });
            
            document.getElementById('clearAllBtn').addEventListener('click', () => {
                if (gameState.traps.length === 0) {
                    showNotification('‚ö†Ô∏è No traps to clear!', 'warning');
                    return;
                }
                
                // Create custom confirmation dialog
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="glass-strong rounded-2xl p-6 max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold text-center mb-4">‚ö†Ô∏è Confirm Emergency Clear</h3>
                        <p class="text-gray-300 text-center mb-6">This will salvage all deployed traps. Continue?</p>
                        <div class="flex space-x-3">
                            <button class="flex-1 bg-gray-500 hover:bg-gray-600 py-3 rounded-lg font-semibold transition-all" onclick="this.closest('.fixed').remove()">Cancel</button>
                            <button class="flex-1 bg-red-500 hover:bg-red-600 py-3 rounded-lg font-semibold transition-all" onclick="confirmClearAll(); this.closest('.fixed').remove()">Clear All</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            });
            
            // Power-up buttons
            document.getElementById('airstrikeBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 50) {
                    gameState.pizzaBucks -= 50;
                    // Damage all enemies
                    gameState.enemies.forEach(enemy => {
                        enemy.health -= 100;
                        createExplosionEffect(enemy.x, enemy.y);
                    });
                    showNotification('üí• Airstrike deployed!', 'success');
                    createScreenShake();
                    playSound('explosion');
                } else {
                    showNotification('‚ùå Insufficient funds!', 'error');
                }
            });
            
            document.getElementById('freezeBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 30) {
                    gameState.pizzaBucks -= 30;
                    gameState.enemies.forEach(enemy => {
                        enemy.effects.freeze = 180; // 3 seconds
                    });
                    showNotification('‚ùÑÔ∏è All enemies frozen!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('‚ùå Insufficient funds!', 'error');
                }
            });
            
            document.getElementById('repairBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 40) {
                    gameState.pizzaBucks -= 40;
                    gameState.lives = Math.min(gameState.lives + 1, 10);
                    showNotification('üîß Base repaired! Life restored!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('‚ùå Insufficient funds!', 'error');
                }
            });
            
            document.getElementById('boostBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 35) {
                    gameState.pizzaBucks -= 35;
                    // Temporary boost to all traps
                    gameState.traps.forEach(trap => {
                        trap.cooldown = Math.max(0, trap.cooldown - 30);
                    });
                    showNotification('üöÄ All traps boosted!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('‚ùå Insufficient funds!', 'error');
                }
            });
            
            // Modal events
            document.getElementById('resumeBtn').addEventListener('click', pauseGame);
            document.getElementById('restartBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('quitBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                gameState.playing = false;
                if (gameLoop) clearInterval(gameLoop);
                showMainMenu();
            });
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                showMainMenu();
            });
            document.getElementById('levelUpContinueBtn').addEventListener('click', () => {
                document.getElementById('levelUpModal').classList.add('hidden');
                setupEnhancedTrapShop(); // Refresh trap shop with new unlocks
            });
            
            // Enhanced keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const activeScreen = document.querySelector('.screen.active');
                    if (activeScreen && activeScreen.id === 'authScreen') {
                        const visibleForm = document.querySelector('#authScreen .glass div:not(.hidden)');
                        if (visibleForm?.id === 'loginForm') {
                            handleLogin();
                        } else if (visibleForm?.id === 'signupForm') {
                            handleSignup();
                        }
                    }
                }
                
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen && activeScreen.id === 'gameScreen') {
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            pauseGame();
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                            gameState.gameSpeed = parseInt(e.key);
                            break;
                        case 'Escape':
                            gameState.selectedTrap = null;
                            gameState.sellMode = false;
                            gameState.upgradeMode = false;
                            updateTrapButtons();
                            break;
                    }
                }
            });
            
            // Setup module events
            setupLeaderboardEvents();
            setupSettingsEvents();
        }
        
        // Global function for clear all confirmation
        window.confirmClearAll = function() {
            const totalRefund = gameState.traps.reduce((sum, trap) => {
                const trapType = TRAP_TYPES[trap.type];
                return sum + Math.floor(trapType.cost * 0.8 * trap.level);
            }, 0);
            
            gameState.pizzaBucks += totalRefund;
            gameState.traps = [];
            
            const canvas = document.getElementById('gameCanvas');
            canvas.querySelectorAll('.trap').forEach(trap => trap.remove());
            
            showNotification(`üóëÔ∏è Emergency clear complete! Salvaged $${totalRefund}`, 'success');
            playSound('coin');
        };
        
        // Authentication functions (same as before with enhanced notifications)
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showNotification('‚ùå Please fill in all fields', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    loadPlayerProgress();
                    showNotification('‚úÖ Access granted! Welcome back, Commander!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('‚ùå Access denied: ' + error.message, 'error');
                }
            } else {
                currentUser = { 
                    id: 'user_' + Date.now(), 
                    email: email, 
                    user_metadata: { username: email.split('@')[0] } 
                };
                loadPlayerProgress();
                showNotification('‚úÖ Demo access granted!', 'success');
                showMainMenu();
            }
        }
        
        async function handleSignup() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            
            if (!username || !email || !password) {
                showNotification('‚ùå Please fill in all fields', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: { data: { username } }
                    });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    loadPlayerProgress();
                    showNotification('‚úÖ Commander registered successfully!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('‚ùå Registration failed: ' + error.message, 'error');
                }
            } else {
                currentUser = { 
                    id: 'user_' + Date.now(), 
                    email: email, 
                    user_metadata: { username: username } 
                };
                loadPlayerProgress();
                showNotification('‚úÖ Demo account created!', 'success');
                showMainMenu();
            }
        }
        
        function playAsGuest() {
            currentUser = { 
                id: 'guest_' + Date.now(), 
                email: 'guest@hq.com', 
                user_metadata: { username: 'Guest Commander' } 
            };
            
            loadPlayerProgress();
            showNotification('üéÆ Emergency access granted!', 'success');
            showMainMenu();
        }
        
        async function handleLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            playerLevel = 1;
            playerXP = 0;
            showNotification('üö™ Session terminated', 'info');
            showScreen('authScreen');
        }
        
        function showMainMenu() {
            if (!currentUser) {
                showScreen('authScreen');
                return;
            }
            
            const username = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Commander';
            document.getElementById('userInfo').textContent = `Welcome back, ${username}!`;
            updatePlayerLevel();
            showScreen('menuScreen');
        }
        
        // Enhanced settings and profile functions (similar structure but improved)
        function loadSettings() {
            const saved = localStorage.getItem('gameSettings');
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) };
            }
            updateSettingsUI();
        }
        
        function saveSettings() {
            localStorage.setItem('gameSettings', JSON.stringify(userSettings));
            showNotification('üíæ Configuration saved successfully!', 'success');
        }
        
        function updateSettingsUI() {
            // Update toggles
            document.getElementById('autoPauseToggle').classList.toggle('active', userSettings.autoPause);
            document.getElementById('damageNumbersToggle').classList.toggle('active', userSettings.showDamageNumbers);
            document.getElementById('trapRangesToggle').classList.toggle('active', userSettings.showTrapRanges);
            document.getElementById('soundEffectsToggle').classList.toggle('active', userSettings.soundEffects);
            document.getElementById('backgroundMusicToggle').classList.toggle('active', userSettings.backgroundMusic);
            document.getElementById('particleEffectsToggle').classList.toggle('active', userSettings.particleEffects);
            document.getElementById('screenShakeToggle').classList.toggle('active', userSettings.screenShake);
            document.getElementById('animationQualityToggle').classList.toggle('active', userSettings.animationQuality);
            
            // Update selects and sliders
            document.getElementById('defaultSpeedSelect').value = userSettings.defaultSpeed;
            document.getElementById('graphicsQualitySelect').value = userSettings.graphicsQuality;
            document.getElementById('masterVolumeSlider').value = userSettings.masterVolume;
            document.getElementById('volumeDisplay').textContent = `${userSettings.masterVolume}%`;
        }
        
        function setupSettingsEvents() {
            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    
                    const settingMap = {
                        'autoPauseToggle': 'autoPause',
                        'damageNumbersToggle': 'showDamageNumbers',
                        'trapRangesToggle': 'showTrapRanges',
                        'soundEffectsToggle': 'soundEffects',
                        'backgroundMusicToggle': 'backgroundMusic',
                        'particleEffectsToggle': 'particleEffects',
                        'screenShakeToggle': 'screenShake',
                        'animationQualityToggle': 'animationQuality'
                    };
                    
                    const setting = settingMap[toggle.id];
                    if (setting) {
                        userSettings[setting] = toggle.classList.contains('active');
                    }
                });
            });
            
            // Select dropdowns
            document.getElementById('defaultSpeedSelect').addEventListener('change', (e) => {
                userSettings.defaultSpeed = parseInt(e.target.value);
            });
            
            document.getElementById('graphicsQualitySelect').addEventListener('change', (e) => {
                userSettings.graphicsQuality = e.target.value;
            });
            
            // Volume slider
            const volumeSlider = document.getElementById('masterVolumeSlider');
            const volumeDisplay = document.getElementById('volumeDisplay');
            
            volumeSlider.addEventListener('input', (e) => {
                userSettings.masterVolume = parseInt(e.target.value);
                volumeDisplay.textContent = `${userSettings.masterVolume}%`;
            });
            
            // Save button
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        }
        
        // Enhanced leaderboard functions (similar structure but improved)
        async function loadLeaderboard(type = 'score') {
            const loadingEl = document.getElementById('leaderboardLoading');
            const contentEl = document.getElementById('leaderboardContent');
            const errorEl = document.getElementById('leaderboardError');
            
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            try {
                let data = [];
                
                if (supabase) {
                    const { data: leaderboardData, error } = await supabase
                        .from('leaderboards')
                        .select('*')
                        .eq('leaderboard_type', type)
                        .order('rank')
                        .limit(50);
                    
                    if (error) throw error;
                    data = leaderboardData || [];
                } else {
                    data = generateEnhancedDemoLeaderboard(type);
                }
                
                displayLeaderboard(data, type);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        function generateEnhancedDemoLeaderboard(type) {
            const names = ['PizzaMaster2024', 'VampireSlayer', 'GarlicGuru', 'DefenseKing', 'TrapLord', 
                          'PizzaHunter', 'GhostBuster', 'TowerMaster', 'FlameGuard', 'ShadowWard'];
            
            return names.map((username, index) => ({
                rank: index + 1,
                username,
                value: type === 'score' ? Math.floor(Math.random() * 500000) + 50000 :
                       type === 'waves' ? Math.floor(Math.random() * 50) + 10 :
                       Math.floor(Math.random() * 5000) + 500,
                secondary_value: Math.floor(Math.random() * 100) + 20,
                country: 'US',
                game_mode: ['Classic', 'Endless', 'Boss Rush', 'Speed'][Math.floor(Math.random() * 4)]
            })).sort((a, b) => b.value - a.value).map((item, index) => ({ ...item, rank: index + 1 }));
        }
        
        function displayLeaderboard(data, type) {
            const loadingEl = document.getElementById('leaderboardLoading');
            const contentEl = document.getElementById('leaderboardContent');
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
            const typeLabels = {
                score: { main: 'Score', secondary: 'Wave' },
                waves: { main: 'Wave', secondary: 'Score' },
                kills: { main: 'Kills', secondary: 'Games' },
                achievements: { main: 'Achievements', secondary: 'Points' }
            };
            
            contentEl.innerHTML = data.map(player => `
                <div class="leaderboard-item rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="rank-medal ${getRankClass(player.rank)}">
                            ${player.rank}
                        </div>
                        <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/pepperoni1.png" alt="üë§" class="w-12 h-12 rounded-full" onerror="this.outerHTML='<div class=&quot;w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl font-bold&quot;>üë§</div>'">
                        <div>
                            <div class="font-bold text-lg">${player.username}</div>
                            <div class="text-sm text-gray-400">${typeLabels[type].secondary}: ${player.secondary_value.toLocaleString()}</div>
                            ${player.game_mode ? `<div class="text-xs text-blue-400">${player.game_mode} Mode</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary">${player.value.toLocaleString()}</div>
                        <div class="text-sm text-gray-400">${typeLabels[type].main}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }
        
        function setupLeaderboardEvents() {
            document.getElementById('scoreLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('scoreLeaderboard');
                loadLeaderboard('score');
            });
            
            document.getElementById('waveLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('waveLeaderboard');
                loadLeaderboard('waves');
            });
            
            document.getElementById('killsLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('killsLeaderboard');
                loadLeaderboard('kills');
            });
            
            document.getElementById('achievementLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('achievementLeaderboard');
                loadLeaderboard('achievements');
            });
            
            document.getElementById('retryLeaderboard').addEventListener('click', () => {
                loadLeaderboard('score');
            });
        }
        
        function setActiveLeaderboardTab(activeId) {
            ['scoreLeaderboard', 'waveLeaderboard', 'killsLeaderboard', 'achievementLeaderboard'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.className = 'px-6 py-2 rounded-lg btn-primary';
                } else {
                    btn.className = 'px-6 py-2 rounded-lg hover:bg-white/10 transition-colors';
                }
            });
        }
        
        // Enhanced profile functions
        async function loadProfile() {
            if (!currentUser) return;
            
            const username = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Commander';
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileEmail').textContent = currentUser.email || 'guest@hq.com';
            document.getElementById('profileLevel').textContent = `Level ${playerLevel}`;
            
            if (supabase && currentUser.id !== 'guest') {
                try {
                    const { data: stats } = await supabase
                        .from('user_statistics')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (stats) {
                        updateProfileStats(stats);
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            } else {
                const savedStats = JSON.parse(localStorage.getItem(`userStats_${currentUser.id}`) || '{}');
                updateProfileStats(savedStats);
            }
            
            loadAchievements();
            
            const joinDate = currentUser.created_at ? 
                new Date(currentUser.created_at).toLocaleDateString() : 
                new Date().toLocaleDateString();
            document.getElementById('profileJoinDate').textContent = `Enlisted: ${joinDate}`;
            
            // Calculate rank based on level
            document.getElementById('profileRank').textContent = `Rank: ${getRankName(playerLevel)}`;
        }
        
        function updateProfileStats(stats) {
            document.getElementById('profileHighScore').textContent = (stats.highScore || stats.highest_score || 0).toLocaleString();
            document.getElementById('profileMaxWave').textContent = (stats.maxWave || stats.highest_wave || 0);
            document.getElementById('profileTotalKills').textContent = (stats.totalKills || stats.total_enemies_killed || 0).toLocaleString();
            document.getElementById('profileGamesPlayed').textContent = (stats.gamesPlayed || stats.total_games_played || 0);
            
            const winRate = stats.gamesPlayed > 0 ? Math.round(((stats.wins || 0) / stats.gamesPlayed) * 100) : 0;
            document.getElementById('profileWinRate').textContent = `${winRate}%`;
            
            const playTimeHours = Math.floor((stats.totalPlayTime || 0) / 3600);
            document.getElementById('profilePlayTime').textContent = `${playTimeHours}h`;
        }
        
        function loadAchievements() {
            const achievements = Object.entries(ACHIEVEMENTS).map(([key, achievement]) => {
                const isUnlocked = JSON.parse(localStorage.getItem(`achievement_${currentUser.id}_${key}`) || 'false');
                return {
                    ...achievement,
                    unlocked: isUnlocked,
                    key: key
                };
            });
            
            const container = document.getElementById('achievementsList');
            container.innerHTML = achievements.map(achievement => `
                <div class="achievement-badge ${achievement.unlocked ? '' : 'locked'} rounded-lg p-3 flex items-center space-x-3">
                    <img src="https://raw.githubusercontent.com/4eudh/pizza-game/main/${achievement.icon}" alt="${achievement.unlocked ? 'üèÜ' : 'üîí'}" class="w-8 h-8" onerror="this.outerHTML='<div class=&quot;text-2xl&quot;>${achievement.unlocked ? 'üèÜ' : 'üîí'}</div>'">
                    <div>
                        <div class="font-bold">${achievement.name}</div>
                        <div class="text-sm text-gray-400">${achievement.description}</div>
                        ${achievement.unlocked ? `<div class="text-xs text-green-400">+${achievement.xpReward} XP</div>` : `<div class="text-xs text-gray-500">Locked</div>`}
                    </div>
                </div>
            `).join('');
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupEventListeners();
            setupCanvasEvents();
            showScreen('authScreen');
            
            // Auto-login check for Supabase
            if (supabase) {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        currentUser = session.user;
                        loadPlayerProgress();
                        showMainMenu();
                    }
                });
            }
            
            // Dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        });
    </script>
</body>
</html>
