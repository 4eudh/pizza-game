<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Attack of the Vampire Pizzas! - Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                        neon: '#00FFFF',
                        plasma: '#FF00FF'
                    },
                    animation: {
                        'float': 'float 2s ease-in-out infinite',
                        'pulse-fast': 'pulse 1s infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'shake': 'shake 0.3s ease-in-out',
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'zoom-in': 'zoomIn 0.3s ease-out',
                        'particles': 'particles 1s ease-out forwards',
                        'laser': 'laser 0.2s ease-out'
                    },
                    fontFamily: {
                        'game': ['Orbitron', 'monospace'],
                        'horror': ['Creepster', 'cursive']
                    },
                    screens: {
                        'xs': '475px'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(124, 58, 237, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.2) 0%, transparent 50%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="200" height="200"><circle cx="20" cy="20" r="1" fill="white" opacity="0.3"/><circle cx="80" cy="40" r="0.5" fill="white" opacity="0.5"/><circle cx="50" cy="70" r="1.5" fill="white" opacity="0.2"/><circle cx="150" cy="90" r="0.8" fill="white" opacity="0.4"/><circle cx="180" cy="150" r="0.3" fill="white" opacity="0.6"/><circle cx="30" cy="160" r="1.2" fill="white" opacity="0.3"/><circle cx="120" cy="30" r="0.7" fill="white" opacity="0.4"/><circle cx="170" cy="70" r="0.4" fill="white" opacity="0.5"/></pattern></defs><rect width="200" height="200" fill="url(%23stars)"/></svg>'),
                linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 25%, #16213e 50%, #0e1428 75%, #0a0a1a 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 300px 300px, 100% 100%;
            background-attachment: fixed;
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
        
        @keyframes glow {
            from { 
                box-shadow: 0 0 20px rgba(124, 58, 237, 0.5);
                filter: brightness(1);
            }
            to { 
                box-shadow: 0 0 40px rgba(124, 58, 237, 0.8), 0 0 60px rgba(236, 72, 153, 0.5);
                filter: brightness(1.2);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px) rotate(-2deg); }
            75% { transform: translateX(8px) rotate(2deg); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(5deg); }
            70% { transform: scale(0.9) rotate(-2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes slideUp {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes particles {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(2.5) rotate(360deg); opacity: 0; }
        }
        
        @keyframes laser {
            0% { opacity: 0; transform: scaleX(0); }
            50% { opacity: 1; transform: scaleX(1); }
            100% { opacity: 0; transform: scaleX(1); }
        }
        
        @keyframes fadeUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }
        
        @keyframes explosion {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.8) rotate(180deg); opacity: 0.9; }
            100% { transform: scale(3) rotate(360deg); opacity: 0; }
        }
        
        @keyframes lightning {
            0%, 100% { opacity: 0; transform: scaleY(0); }
            50% { opacity: 1; transform: scaleY(1); }
        }
        
        @keyframes rankGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 69, 0, 0.8); }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.6);
        }
        
        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .screen {
            display: none;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .screen.active {
            display: flex;
            animation: slideUp 0.5s ease-out;
        }
        
        .game-title {
            font-family: 'Creepster', cursive;
            background: linear-gradient(45deg, #7C3AED, #EC4899, #F59E0B, #10B981);
            background-size: 400% 400%;
            animation: gradient 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 30px rgba(124, 58, 237, 0.8));
            text-shadow: 0 0 30px rgba(124, 58, 237, 0.5);
        }
        
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .tech-title {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(45deg, #00FFFF, #7C3AED);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .game-canvas {
            background: 
                linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.95) 50%, rgba(14, 20, 40, 0.9) 100%);
            border: 3px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 0 50px rgba(124, 58, 237, 0.4),
                inset 0 0 100px rgba(0, 0, 0, 0.4);
            transform: translateZ(0);
        }
        
        .game-canvas::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #7C3AED, #EC4899, #F59E0B, #7C3AED);
            background-size: 300% 300%;
            animation: gradient 4s ease infinite;
            border-radius: 16px;
            z-index: -1;
        }
        
        .game-path {
            position: absolute;
            left: 0;
            top: 0;
            width: clamp(120px, 15vw, 180px);
            height: 100%;
            background: 
                linear-gradient(90deg, 
                    rgba(139, 69, 19, 0.95) 0%, 
                    rgba(160, 82, 45, 0.9) 30%, 
                    rgba(205, 133, 63, 0.95) 70%, 
                    rgba(210, 105, 30, 0.9) 100%);
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent, 
                    transparent 15px, 
                    rgba(139, 69, 19, 0.4) 15px, 
                    rgba(139, 69, 19, 0.4) 30px);
            border-right: 4px solid #8B4513;
            box-shadow: 
                inset -15px 0 30px rgba(0,0,0,0.6),
                0 0 30px rgba(139, 69, 19, 0.4);
            z-index: 1;
        }
        
        .entity {
            position: absolute;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
            z-index: 10;
            transition: all 0.2s ease;
            transform: translateZ(0);
        }
        
        .entity img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }
        
        .enemy {
            animation: float 2s ease-in-out infinite;
            cursor: pointer;
        }
        
        .enemy.boss {
            animation: float 1s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
            border: 4px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            z-index: 15;
        }
        
        .enemy.rare {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.7);
        }
        
        .enemy.epic {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
        }
        
        .enemy.legendary {
            box-shadow: 0 0 35px rgba(245, 158, 11, 0.9);
        }
        
        .trap {
            cursor: pointer;
            animation: glow 3s ease-in-out infinite alternate;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .trap.ready {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.9);
            border-color: rgba(16, 185, 129, 0.6);
        }
        
        .trap.cooldown {
            opacity: 0.7;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            filter: grayscale(0.3);
        }
        
        .powerup {
            animation: bounce-in 0.6s ease-out, float 3s ease-in-out infinite 0.6s;
            cursor: pointer;
        }
        
        .projectile {
            border-radius: 50%;
            box-shadow: 0 0 15px currentColor;
            z-index: 12;
        }
        
        .health-bar {
            position: absolute;
            top: -12px;
            left: 0;
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #EF4444, #F59E0B, #10B981);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }
        
        .shield-bar {
            position: absolute;
            top: -22px;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        .shield-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.9);
        }
        
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 16px;
            z-index: 25;
            pointer-events: none;
            animation: fadeUp 2s ease-out forwards;
            font-family: 'Orbitron', monospace;
        }
        
        .damage-number.heal { 
            color: #10B981; 
            text-shadow: 0 0 10px #10B981;
        }
        .damage-number.damage { 
            color: #EF4444; 
            text-shadow: 0 0 10px #EF4444;
        }
        .damage-number.money { 
            color: #F59E0B; 
            text-shadow: 0 0 10px #F59E0B;
        }
        .damage-number.critical { 
            color: #FFD700; 
            font-size: 24px; 
            text-shadow: 0 0 15px #FFD700;
            animation: zoomIn 0.3s ease-out, fadeUp 2s ease-out 0.3s forwards;
        }
        .damage-number.combo {
            color: #FF00FF;
            font-size: 20px;
            text-shadow: 0 0 12px #FF00FF;
        }
        
        .explosion-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #FFD700, #FF4500, #DC2626);
            border-radius: 50%;
            animation: explosion 0.8s ease-out forwards;
            z-index: 20;
        }
        
        .lightning-effect {
            position: absolute;
            width: 6px;
            background: linear-gradient(90deg, #60A5FA, #FFFFFF, #60A5FA);
            animation: lightning 0.3s ease-in-out;
            z-index: 20;
            box-shadow: 0 0 20px #60A5FA;
        }
        
        .laser-effect {
            position: absolute;
            height: 4px;
            background: linear-gradient(90deg, #FF00FF, #00FFFF, #FF00FF);
            animation: laser 0.2s ease-out;
            z-index: 18;
            box-shadow: 0 0 15px #FF00FF;
        }
        
        .particle-effect {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #FFD700, #FF4500);
            border-radius: 50%;
            animation: particles 1s ease-out forwards;
            z-index: 16;
        }
        
        .notification {
            animation: slideUp 0.5s ease-out;
            max-width: 90vw;
        }
        
        .trap-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }
        
        .trap-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .trap-btn:hover::before {
            left: 100%;
        }
        
        .trap-btn:hover {
            border-color: #7C3AED;
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }
        
        .trap-btn.selected {
            border-color: #F59E0B;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(245, 158, 11, 0.15));
        }
        
        .trap-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .trap-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            transform: translateZ(0);
        }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: rgba(124, 58, 237, 0.5);
        }
        
        .level-progress {
            background: linear-gradient(90deg, #7C3AED, #EC4899, #F59E0B);
            height: 10px;
            border-radius: 5px;
            transition: width 0.8s ease;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.6);
            position: relative;
            overflow: hidden;
        }
        
        .level-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #374151;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-switch.active {
            background: linear-gradient(45deg, #7C3AED, #EC4899);
            border-color: rgba(124, 58, 237, 0.5);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }
        
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .toggle-switch.active::before {
            transform: translateX(30px);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.4);
        }
        
        .difficulty-btn, .mode-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            color: white;
        }
        
        .difficulty-btn:hover, .mode-btn:hover {
            border-color: #7C3AED;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }
        
        .difficulty-btn.selected, .mode-btn.selected {
            border-color: #F59E0B;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(245, 158, 11, 0.15));
        }
        
        .rank-display {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .rank-display.legendary {
            background: linear-gradient(135deg, #ff6b35, #f7931e, #ffd700);
            animation: rankGlow 2s infinite;
        }
        
        .rank-display.elite {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
        }
        
        .rank-display.veteran {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
        }
        
        .rank-display.advanced {
            background: linear-gradient(135deg, #10b981, #22c55e);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(124, 58, 237, 0.3);
            border-left: 4px solid #7C3AED;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .neon-glow {
            box-shadow: 
                0 0 20px currentColor,
                inset 0 0 20px rgba(255, 255, 255, 0.1);
        }
        
        .plasma-effect {
            background: linear-gradient(45deg, #FF00FF, #00FFFF, #FF00FF);
            background-size: 200% 200%;
            animation: gradient 2s ease infinite;
        }
        
        .gpu-accelerated {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: #000;
            font-weight: bold;
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: #FFF;
            font-weight: bold;
        }
        
        .rank-other {
            background: linear-gradient(135deg, #4A5568, #2D3748);
            color: #FFF;
        }
        
        .leaderboard-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .rank-medal {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .achievement-badge {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        
        /* Responsive Design Improvements */
        @media (max-width: 1024px) {
            .game-canvas {
                height: 450px !important;
                margin: 0 auto;
            }
            
            .game-path {
                width: clamp(100px, 12vw, 140px);
            }
        }
        
        @media (max-width: 768px) {
            .game-canvas {
                height: 400px !important;
                border-radius: 12px;
            }
            
            .game-title {
                font-size: 2rem !important;
            }
            
            .trap-btn {
                padding: 0.75rem;
                min-height: 80px;
            }
            
            .entity {
                font-size: 12px;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .damage-number {
                font-size: 14px;
            }
            
            .damage-number.critical {
                font-size: 18px;
            }
        }
        
        @media (max-width: 640px) {
            .game-canvas {
                height: 350px !important;
                border-radius: 8px;
            }
            
            .game-path {
                width: clamp(80px, 10vw, 120px);
            }
            
            .trap-btn {
                padding: 0.5rem;
                min-height: 70px;
            }
            
            .stat-card {
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 475px) {
            .game-canvas {
                height: 300px !important;
            }
            
            .entity {
                font-size: 10px;
            }
            
            .trap-btn {
                min-height: 60px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) {
            .trap-btn:hover,
            .btn-primary:hover,
            .stat-card:hover {
                transform: none;
            }
            
            .trap-btn:active {
                transform: scale(0.95);
            }
            
            .btn-primary:active {
                transform: scale(0.98);
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .entity {
                image-rendering: -webkit-optimize-contrast;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .glass {
                background: rgba(0, 0, 0, 0.4);
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .glass-strong {
                background: rgba(0, 0, 0, 0.6);
                border-color: rgba(255, 255, 255, 0.15);
            }
        }
        
        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Authentication Screen -->
    <div id="authScreen" class="screen active items-center justify-center p-4 min-h-screen">
        <div class="w-full max-w-md mx-auto">
            <div class="text-center mb-8 animate-bounce-in">
                <h1 class="game-title text-4xl md:text-6xl mb-4">Vampire Pizzas!</h1>
                <h2 class="tech-title text-xl md:text-2xl mb-2">Ultimate Edition</h2>
                <p class="text-gray-300 mb-2">Advanced Defense Protocol</p>
                <div class="flex justify-center space-x-2 text-2xl animate-float">
                    <img src="vampire_icon.png" alt="🧛" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none;">🧛</span>
                    <img src="pizza_icon.png" alt="🍕" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none;">🍕</span>
                    <img src="lightning_icon.png" alt="⚡" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none;">⚡</span>
                    <img src="shield_icon.png" alt="🛡️" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none;">🛡️</span>
                    <img src="game_icon.png" alt="🎮" class="w-8 h-8" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none;">🎮</span>
                </div>
            </div>
            
            <div class="glass-strong rounded-2xl p-6 md:p-8 animate-slide-up">
                <!-- Enhanced Login Form -->
                <div id="loginForm">
                    <h2 class="tech-title text-2xl font-bold text-center mb-6">System Access</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-cyan-300">
                                <span class="flex items-center">
                                    <span class="mr-2">📧</span> Email Address
                                </span>
                            </label>
                            <input type="email" id="loginEmail" 
                                   class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-base text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 transition-all"
                                   placeholder="commander@hq.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-cyan-300">
                                <span class="flex items-center">
                                    <span class="mr-2">🔐</span> Access Code
                                </span>
                            </label>
                            <input type="password" id="loginPassword" 
                                   class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-base text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 transition-all"
                                   placeholder="Enter security code">
                        </div>
                        <button id="loginBtn" class="w-full btn-primary py-4 rounded-lg font-semibold text-lg relative overflow-hidden">
                            <span class="flex items-center justify-center">
                                <span class="mr-2">🚀</span> Initialize Defense System
                            </span>
                        </button>
                        <div class="text-center space-y-3">
                            <button type="button" id="showSignupBtn" class="text-primary hover:text-secondary transition-colors block w-full py-2">
                                Register New Commander
                            </button>
                            <button type="button" id="playAsGuestBtn" class="text-accent hover:text-white transition-colors text-lg font-semibold block w-full py-3 border border-accent/50 rounded-lg hover:bg-accent/20">
                                <span class="flex items-center justify-center">
                                    <span class="mr-2">⚡</span> Emergency Access
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Signup Form -->
                <div id="signupForm" class="hidden">
                    <h2 class="tech-title text-2xl font-bold text-center mb-6">Commander Registration</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-cyan-300">
                                <span class="flex items-center">
                                    <span class="mr-2">👤</span> Commander Callsign
                                </span>
                            </label>
                            <input type="text" id="signupUsername" 
                                   class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-base text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 transition-all"
                                   placeholder="Choose your callsign">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-cyan-300">
                                <span class="flex items-center">
                                    <span class="mr-2">📧</span> Email Address
                                </span>
                            </label>
                            <input type="email" id="signupEmail" 
                                   class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-base text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 transition-all"
                                   placeholder="commander@hq.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-cyan-300">
                                <span class="flex items-center">
                                    <span class="mr-2">🔐</span> Security Code
                                </span>
                            </label>
                            <input type="password" id="signupPassword" 
                                   class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-base text-white placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30 transition-all"
                                   placeholder="Create secure code">
                        </div>
                        <button id="signupBtn" class="w-full btn-primary py-4 rounded-lg font-semibold text-lg">
                            <span class="flex items-center justify-center">
                                <span class="mr-2">⚡</span> Register Commander
                            </span>
                        </button>
                        <div class="text-center">
                            <button type="button" id="showLoginBtn" class="text-primary hover:text-secondary transition-colors">
                                Return to Access Terminal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="mt-6 text-center text-sm text-gray-400">
                <div class="flex items-center justify-center space-x-2 mb-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span>Defense Grid Online</span>
                </div>
                <div>Threat Level: <span class="text-orange-400">ELEVATED</span></div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Main Menu -->
    <div id="menuScreen" class="screen items-center justify-center p-4 min-h-screen">
        <div class="text-center max-w-7xl mx-auto w-full">
            <div class="animate-bounce-in">
                <h1 class="game-title text-5xl md:text-8xl mb-4">Vampire Pizzas!</h1>
                <h2 class="tech-title text-2xl md:text-4xl mb-8">Ultimate Defense System</h2>
            </div>
            
            <!-- Enhanced Player Status -->
            <div class="glass-strong rounded-2xl p-6 mb-8 animate-slide-up">
                <div class="flex flex-col md:flex-row items-center justify-center md:space-x-8 space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-3xl animate-float">
                            👤
                        </div>
                        <div class="text-left">
                            <div class="text-2xl font-bold text-cyan-300" id="playerLevel">Level 1 Recruit</div>
                            <div class="text-gray-400" id="playerXP">0 / 100 XP</div>
                            <div class="text-sm text-purple-400" id="playerRank">Combat Rating: Novice</div>
                        </div>
                    </div>
                    
                    <div class="flex-1 max-w-md">
                        <div class="w-full bg-gray-700/50 rounded-full h-4 overflow-hidden mb-2">
                            <div id="xpProgress" class="level-progress" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-400 text-center">Next Unlock: Advanced Traps</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="totalScore">0</div>
                        <div class="text-sm text-gray-400">Total Score</div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Mission Configuration -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Difficulty Selection -->
                <div class="glass-strong rounded-2xl p-6 animate-slide-up">
                    <h3 class="text-2xl font-bold mb-6 text-center text-green-300 flex items-center justify-center">
                        <span class="mr-2">⚙️</span> Threat Assessment
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="difficultySelection">
                        <button class="difficulty-btn selected rounded-xl p-4 text-center transition-all" data-difficulty="beginner">
                            <div class="text-3xl mb-2">🟢</div>
                            <div class="font-bold">Recruit</div>
                            <div class="text-sm text-gray-300">Training Mode</div>
                            <div class="text-xs text-green-400 mt-1">+100% XP</div>
                        </button>
                        <button class="difficulty-btn rounded-xl p-4 text-center transition-all" data-difficulty="intermediate">
                            <div class="text-3xl mb-2">🟡</div>
                            <div class="font-bold">Soldier</div>
                            <div class="text-sm text-gray-300">Standard Ops</div>
                            <div class="text-xs text-blue-400 mt-1">+120% XP</div>
                        </button>
                        <button class="difficulty-btn rounded-xl p-4 text-center transition-all" data-difficulty="advanced">
                            <div class="text-3xl mb-2">🟠</div>
                            <div class="font-bold">Veteran</div>
                            <div class="text-sm text-gray-300">High Risk</div>
                            <div class="text-xs text-orange-400 mt-1">+150% XP</div>
                        </button>
                        <button class="difficulty-btn rounded-xl p-4 text-center transition-all" data-difficulty="expert">
                            <div class="text-3xl mb-2">🔴</div>
                            <div class="font-bold">Elite</div>
                            <div class="text-sm text-gray-300">Nightmare</div>
                            <div class="text-xs text-red-400 mt-1">+200% XP</div>
                        </button>
                    </div>
                </div>
                
                <!-- Game Mode Selection -->
                <div class="glass-strong rounded-2xl p-6 animate-slide-up">
                    <h3 class="text-2xl font-bold mb-6 text-center text-blue-300 flex items-center justify-center">
                        <span class="mr-2">🎯</span> Mission Type
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="gameModeSelection">
                        <button class="mode-btn selected rounded-xl p-4 text-center transition-all" data-mode="classic">
                            <div class="text-3xl mb-2">🏛️</div>
                            <div class="font-bold">Classic</div>
                            <div class="text-sm text-gray-300">25 Waves</div>
                        </button>
                        <button class="mode-btn rounded-xl p-4 text-center transition-all" data-mode="endless">
                            <div class="text-3xl mb-2">♾️</div>
                            <div class="font-bold">Endless</div>
                            <div class="text-sm text-gray-300">Survival Mode</div>
                        </button>
                        <button class="mode-btn rounded-xl p-4 text-center transition-all" data-mode="boss_rush">
                            <div class="text-3xl mb-2">👑</div>
                            <div class="font-bold">Boss Rush</div>
                            <div class="text-sm text-gray-300">Elite Enemies</div>
                        </button>
                        <button class="mode-btn rounded-xl p-4 text-center transition-all" data-mode="speed">
                            <div class="text-3xl mb-2">⚡</div>
                            <div class="font-bold">Blitz</div>
                            <div class="text-sm text-gray-300">Fast & Furious</div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mission Launch -->
            <div class="mb-8">
                <button id="startGameBtn" class="btn-primary px-12 py-6 rounded-2xl font-bold text-2xl animate-glow">
                    <span class="flex items-center justify-center">
                        <span class="mr-3">🚀</span> DEPLOY DEFENSES
                    </span>
                </button>
            </div>
            
            <!-- Enhanced Navigation -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto mb-8">
                <button id="leaderboardBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all group">
                    <div class="text-4xl mb-4 group-hover:animate-bounce">🏆</div>
                    <h3 class="text-xl font-bold mb-2">Command Center</h3>
                    <p class="text-gray-300 text-sm">Rankings & Intel</p>
                </button>
                
                <button id="profileBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all group">
                    <div class="text-4xl mb-4 group-hover:animate-bounce">🎖️</div>
                    <h3 class="text-xl font-bold mb-2">Service Record</h3>
                    <p class="text-gray-300 text-sm">Stats & Achievements</p>
                </button>
                
                <button id="dailyChallengeBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all group">
                    <div class="text-4xl mb-4 group-hover:animate-bounce">📅</div>
                    <h3 class="text-xl font-bold mb-2">Daily Ops</h3>
                    <p class="text-gray-300 text-sm">Special Missions</p>
                </button>
                
                <button id="settingsBtn" class="glass rounded-2xl p-6 hover:bg-white/10 hover:scale-105 transition-all group">
                    <div class="text-4xl mb-4 group-hover:animate-bounce">⚙️</div>
                    <h3 class="text-xl font-bold mb-2">System Config</h3>
                    <p class="text-gray-300 text-sm">Preferences</p>
                </button>
            </div>
            
            <!-- User Info & Controls -->
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                <div id="userInfo" class="text-xl font-semibold text-cyan-300"></div>
                <button id="logoutBtn" class="glass rounded-xl px-6 py-3 hover:bg-red-500/20 transition-all flex items-center space-x-2">
                    <span>🚪</span><span>Logout</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Game Screen -->
    <div id="gameScreen" class="screen flex-col p-2 md:p-4 min-h-screen">
        <div class="flex flex-col xl:flex-row gap-4 h-full max-w-7xl mx-auto w-full">
            <!-- Enhanced Main Game Area -->
            <div class="flex-1 min-w-0">
                <!-- Enhanced Control Bar -->
                <div class="glass-strong rounded-xl p-3 md:p-4 mb-4 flex flex-wrap items-center justify-between gap-2">
                    <button id="backToMenuBtn" class="btn-primary px-4 py-2 rounded-lg text-sm md:text-base">← HQ</button>
                    
                    <div class="text-center flex-1">
                        <h2 class="game-title text-xl md:text-3xl">Wave <span id="currentWave">1</span></h2>
                        <div class="tech-title text-xs md:text-sm" id="gameMode">Classic Mode</div>
                        <div class="text-xs text-gray-400" id="gameDifficulty">Recruit</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="pauseGameBtn" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-2 rounded-lg font-semibold transition-all text-sm">⏸️</button>
                        <button id="speedBtn" class="bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-lg font-semibold transition-all text-sm">1x</button>
                    </div>
                </div>
                
                <!-- Enhanced Stats Bar -->
                <div class="glass rounded-xl p-3 md:p-4 mb-4">
                    <div class="grid grid-cols-3 md:grid-cols-7 gap-2 md:gap-3">
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center">
                            <div class="text-lg md:text-2xl font-bold text-yellow-400" id="pizzaBucks">100</div>
                            <div class="text-xs text-gray-400">Credits</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center">
                            <div class="text-lg md:text-2xl font-bold text-red-400" id="lives">5</div>
                            <div class="text-xs text-gray-400">Lives</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center">
                            <div class="text-lg md:text-2xl font-bold text-green-400" id="kills">0</div>
                            <div class="text-xs text-gray-400">KIA</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center md:block hidden">
                            <div class="text-lg md:text-2xl font-bold text-purple-400" id="score">0</div>
                            <div class="text-xs text-gray-400">Score</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center md:block hidden">
                            <div class="text-lg md:text-2xl font-bold text-blue-400" id="enemiesLeft">0</div>
                            <div class="text-xs text-gray-400">Hostiles</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center md:block hidden">
                            <div class="text-lg md:text-2xl font-bold text-orange-400" id="combo">0</div>
                            <div class="text-xs text-gray-400">Combo</div>
                        </div>
                        <div class="stat-card rounded-lg p-2 md:p-3 text-center md:block hidden">
                            <div class="text-lg md:text-2xl font-bold text-pink-400" id="sessionXP">0</div>
                            <div class="text-xs text-gray-400">XP</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Game Canvas -->
                <div id="gameCanvas" class="game-canvas gpu-accelerated" style="height: 500px;">
                    <!-- Enhanced Path -->
                    <div class="game-path"></div>
                    
                    <!-- FPS Counter -->
                    <div id="fpsCounter" class="absolute top-2 right-2 text-xs text-gray-400 bg-black/50 px-2 py-1 rounded hidden">
                        FPS: <span id="fpsValue">60</span>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Control Panel -->
            <div class="w-full xl:w-96 space-y-4">
                <!-- Enhanced Defense Arsenal -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-primary flex items-center justify-center">
                        <span class="mr-2">🛡️</span> Defense Arsenal
                    </h3>
                    <div class="grid grid-cols-2 gap-3" id="trapShop">
                        <!-- Enhanced trap buttons will be populated here -->
                    </div>
                </div>
                
                <!-- Enhanced Wave Intel -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-blue-400 flex items-center justify-center">
                        <span class="mr-2">📊</span> Wave Intel
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>Next Wave:</span>
                            <span id="waveTimer" class="text-blue-400 font-bold">30s</span>
                        </div>
                        <div class="w-full bg-gray-700/50 rounded-full h-4 overflow-hidden">
                            <div id="waveProgress" class="bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-400 text-center" id="waveInfo">Preparing defenses...</div>
                        <div class="text-xs text-center p-2 bg-red-500/20 rounded" id="threatLevel">
                            Threat Level: <span class="text-red-400 font-bold">LOW</span>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Power Systems -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-green-400 flex items-center justify-center">
                        <span class="mr-2">⚡</span> Power Systems
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-1 gap-3" id="powerupShop">
                        <button class="bg-red-500/20 hover:bg-red-500/30 py-3 px-2 rounded-lg transition-colors font-semibold text-sm" id="airstrikeBtn">
                            <div class="flex items-center justify-center space-x-2">
                                <span>💥</span><span>Orbital Strike</span>
                            </div>
                            <div class="text-xs text-yellow-400">$75</div>
                        </button>
                        <button class="bg-blue-500/20 hover:bg-blue-500/30 py-3 px-2 rounded-lg transition-colors font-semibold text-sm" id="freezeBtn">
                            <div class="flex items-center justify-center space-x-2">
                                <span>❄️</span><span>Cryo Blast</span>
                            </div>
                            <div class="text-xs text-yellow-400">$50</div>
                        </button>
                        <button class="bg-yellow-500/20 hover:bg-yellow-500/30 py-3 px-2 rounded-lg transition-colors font-semibold text-sm" id="repairBtn">
                            <div class="flex items-center justify-center space-x-2">
                                <span>🔧</span><span>Nano Repair</span>
                            </div>
                            <div class="text-xs text-yellow-400">$60</div>
                        </button>
                        <button class="bg-purple-500/20 hover:bg-purple-500/30 py-3 px-2 rounded-lg transition-colors font-semibold text-sm" id="boostBtn">
                            <div class="flex items-center justify-center space-x-2">
                                <span>🚀</span><span>Overcharge</span>
                            </div>
                            <div class="text-xs text-yellow-400">$45</div>
                        </button>
                    </div>
                </div>
                
                <!-- Enhanced Command Actions -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-lg md:text-xl font-bold mb-4 text-center text-orange-400 flex items-center justify-center">
                        <span class="mr-2">🎯</span> Commands
                    </h3>
                    <div class="space-y-3">
                        <button id="sellModeBtn" class="w-full bg-red-500/20 hover:bg-red-500/30 py-3 rounded-lg transition-colors font-semibold text-sm">
                            <span class="flex items-center justify-center space-x-2">
                                <span>💰</span><span>Salvage Mode</span>
                            </span>
                        </button>
                        <button id="upgradeMode" class="w-full bg-green-500/20 hover:bg-green-500/30 py-3 rounded-lg transition-colors font-semibold text-sm">
                            <span class="flex items-center justify-center space-x-2">
                                <span>⬆️</span><span>Upgrade Mode</span>
                            </span>
                        </button>
                        <button id="clearAllBtn" class="w-full bg-orange-500/20 hover:bg-orange-500/30 py-3 rounded-lg transition-colors font-semibold text-sm">
                            <span class="flex items-center justify-center space-x-2">
                                <span>🗑️</span><span>Emergency Clear</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Leaderboard Screen -->
    <div id="leaderboardScreen" class="screen flex-col p-4 md:p-6 min-h-screen">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                <h1 class="game-title text-3xl md:text-6xl">Command Center</h1>
                <button id="backFromLeaderboardBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ← Return to Base
                </button>
            </div>
            
            <div class="glass-strong rounded-2xl p-4 md:p-6">
                <div class="flex flex-wrap justify-center mb-6 gap-2">
                    <div class="flex space-x-1 bg-black/30 rounded-lg p-1">
                        <button id="scoreLeaderboard" class="px-4 py-2 rounded-lg btn-primary text-sm">
                            <span class="flex items-center space-x-2">
                                <span>🏆</span><span class="hidden sm:inline">High Scores</span>
                            </span>
                        </button>
                        <button id="waveLeaderboard" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors text-sm">
                            <span class="flex items-center space-x-2">
                                <span>🌊</span><span class="hidden sm:inline">Wave Records</span>
                            </span>
                        </button>
                        <button id="killsLeaderboard" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors text-sm">
                            <span class="flex items-center space-x-2">
                                <span>⚔️</span><span class="hidden sm:inline">KIA Count</span>
                            </span>
                        </button>
                        <button id="achievementLeaderboard" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors text-sm">
                            <span class="flex items-center space-x-2">
                                <span>🎖️</span><span class="hidden sm:inline">Achievements</span>
                            </span>
                        </button>
                    </div>
                </div>
                
                <div id="leaderboardLoading" class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-400">Accessing command database...</p>
                </div>
                
                <div id="leaderboardContent" class="space-y-3 hidden">
                    <!-- Enhanced leaderboard items will be populated here -->
                </div>
                
                <div id="leaderboardError" class="text-center py-8 hidden">
                    <div class="text-red-400 text-6xl mb-4">⚠️</div>
                    <p class="text-red-400 mb-4">Failed to access command database</p>
                    <button id="retryLeaderboard" class="btn-primary px-6 py-2 rounded-lg">
                        Retry Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Profile Screen -->
    <div id="profileScreen" class="screen flex-col p-4 md:p-6 min-h-screen">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                <h1 class="game-title text-3xl md:text-6xl">Service Record</h1>
                <div class="flex gap-3">
                    <button id="deleteDataBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold transition-all">
                        🗑️ Delete Data
                    </button>
                    <button id="backFromProfileBtn" class="btn-primary px-6 py-3 rounded-lg">
                        ← Return to Base
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Enhanced Commander Info -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-cyan-300 text-center">Commander Profile</h2>
                    <div class="space-y-6">
                        <div class="text-center">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-4xl mx-auto mb-4 animate-float">
                                👤
                            </div>
                            <div class="text-2xl font-bold" id="profileUsername">Commander</div>
                            <div class="text-gray-400" id="profileEmail">commander@hq.com</div>
                        </div>
                        
                        <div class="space-y-3 text-center">
                            <div class="p-3 bg-blue-500/20 rounded-lg">
                                <div class="text-lg font-bold text-blue-300" id="profileLevel">Level 1</div>
                                <div class="text-sm text-gray-400">Current Level</div>
                            </div>
                            <div class="rank-display p-3 rounded-lg">
                                <div class="text-lg font-bold text-purple-300" id="profileRank">Recruit</div>
                                <div class="text-sm text-gray-400">Combat Rank</div>
                            </div>
                            <div class="p-3 bg-green-500/20 rounded-lg">
                                <div class="text-lg font-bold text-green-300" id="profileJoinDate">--</div>
                                <div class="text-sm text-gray-400">Service Start</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Combat Statistics -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-green-300 text-center">Combat Statistics</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="profileHighScore">0</div>
                            <div class="text-sm text-gray-400">Best Score</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="profileMaxWave">0</div>
                            <div class="text-sm text-gray-400">Max Wave</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-400" id="profileTotalKills">0</div>
                            <div class="text-sm text-gray-400">Total KIA</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-400" id="profileGamesPlayed">0</div>
                            <div class="text-sm text-gray-400">Missions</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="profileWinRate">0%</div>
                            <div class="text-sm text-gray-400">Success Rate</div>
                        </div>
                        <div class="stat-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-400" id="profilePlayTime">0h</div>
                            <div class="text-sm text-gray-400">Active Duty</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Achievements -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-yellow-300 text-center">Achievements</h2>
                    <div class="space-y-3 max-h-96 overflow-y-auto" id="achievementsList">
                        <!-- Achievement badges will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Settings Screen -->
    <div id="settingsScreen" class="screen flex-col p-4 md:p-6 min-h-screen">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                <h1 class="game-title text-3xl md:text-6xl">System Config</h1>
                <button id="backFromSettingsBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ← Return to Base
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Enhanced Game Settings -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-blue-300 flex items-center">
                        <span class="mr-3">🎮</span> Game Settings
                    </h2>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Auto-pause between waves</div>
                                <div class="text-sm text-gray-400">Pause when wave ends</div>
                            </div>
                            <div class="toggle-switch" id="autoPauseToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Show damage numbers</div>
                                <div class="text-sm text-gray-400">Display floating damage text</div>
                            </div>
                            <div class="toggle-switch active" id="damageNumbersToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Show trap ranges</div>
                                <div class="text-sm text-gray-400">Display attack range circles</div>
                            </div>
                            <div class="toggle-switch active" id="trapRangesToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Screen shake effects</div>
                                <div class="text-sm text-gray-400">Camera shake on impacts</div>
                            </div>
                            <div class="toggle-switch active" id="screenShakeToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Show FPS counter</div>
                                <div class="text-sm text-gray-400">Display performance metrics</div>
                            </div>
                            <div class="toggle-switch" id="fpsToggle"></div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Default game speed</label>
                            <select id="defaultSpeedSelect" class="w-full px-4 py-2 bg-black/30 border border-blue-500/30 rounded-lg text-white focus:border-primary focus:outline-none">
                                <option value="1">1x (Standard)</option>
                                <option value="2">2x (Fast)</option>
                                <option value="3">3x (Very Fast)</option>
                                <option value="4">4x (Ultra Fast)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Audio/Visual Settings -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-green-300 flex items-center">
                        <span class="mr-3">🎨</span> Audio & Visual
                    </h2>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Sound effects</div>
                                <div class="text-sm text-gray-400">Play game sound effects</div>
                            </div>
                            <div class="toggle-switch active" id="soundEffectsToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Background music</div>
                                <div class="text-sm text-gray-400">Play ambient music</div>
                            </div>
                            <div class="toggle-switch active" id="backgroundMusicToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Particle effects</div>
                                <div class="text-sm text-gray-400">Show explosions and particles</div>
                            </div>
                            <div class="toggle-switch active" id="particleEffectsToggle"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Enhanced animations</div>
                                <div class="text-sm text-gray-400">High-quality visual effects</div>
                            </div>
                            <div class="toggle-switch active" id="animationQualityToggle"></div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Graphics quality</label>
                            <select id="graphicsQualitySelect" class="w-full px-4 py-2 bg-black/30 border border-blue-500/30 rounded-lg text-white focus:border-primary focus:outline-none">
                                <option value="low">Low (Better performance)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Better visuals)</option>
                                <option value="ultra">Ultra (Maximum quality)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block font-semibold">Master volume</label>
                            <input type="range" id="masterVolumeSlider" min="0" max="100" value="80" 
                                   class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <div class="text-center text-sm text-gray-400" id="volumeDisplay">80%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Settings -->
            <div class="text-center mt-8">
                <button id="saveSettingsBtn" class="btn-primary px-12 py-4 rounded-xl font-bold text-lg">
                    <span class="flex items-center justify-center">
                        <span class="mr-3">💾</span> Save Configuration
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Daily Challenge Screen -->
    <div id="dailyChallengeScreen" class="screen flex-col p-4 md:p-6 min-h-screen">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                <h1 class="game-title text-3xl md:text-6xl">Daily Operations</h1>
                <button id="backFromChallengeBtn" class="btn-primary px-6 py-3 rounded-lg">
                    ← Return to Base
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Today's Challenge -->
                <div class="glass-strong rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 text-yellow-300 text-center flex items-center justify-center">
                        <span class="mr-3">⭐</span> Today's Special Operation
                    </h2>
                    <div class="text-center" id="dailyChallenge">
                        <div class="text-6xl mb-4">🎯</div>
                        <h3 class="text-2xl font-bold mb-4" id="challengeTitle">Elite Elimination Protocol</h3>
                        <p class="text-gray-300 mb-6" id="challengeDescription">Eliminate 50 elite enemies using only basic traps</p>
                        <div class="flex justify-center space-x-6 mb-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">+500 XP</div>
                                <div class="text-sm text-gray-400">Reward</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400" id="challengeProgress">0/50</div>
                                <div class="text-sm text-gray-400">Progress</div>
                            </div>
                        </div>
                        <button id="startChallengeBtn" class="btn-primary px-8 py-4 rounded-xl font-bold text-lg">
                            <span class="flex items-center justify-center">
                                <span class="mr-3">🚀</span> Accept Mission
                            </span>
                        </button>
                    </div>
                </div>
                
                <!-- Weekly Challenges -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-bold text-blue-300 mb-3">🏆 Weekly Elite</h3>
                        <p class="text-sm text-gray-300 mb-4">Reach wave 30 in Classic mode</p>
                        <div class="text-yellow-400 font-bold">+1000 XP</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-bold text-purple-300 mb-3">⚡ Speed Demon</h3>
                        <p class="text-sm text-gray-300 mb-4">Complete Blitz mode under 8 minutes</p>
                        <div class="text-yellow-400 font-bold">+750 XP</div>
                    </div>
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-bold text-red-300 mb-3">💀 No Mercy</h3>
                        <p class="text-sm text-gray-300 mb-4">Win on Expert difficulty</p>
                        <div class="text-yellow-400 font-bold">+1500 XP</div>
                    </div>
                </div>
                
                <!-- Additional Daily Operations -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl mb-2">🎪</div>
                        <h4 class="font-bold text-orange-300 mb-2">Carnival of Chaos</h4>
                        <p class="text-sm text-gray-300 mb-3">Survive 15 waves with only explosive traps</p>
                        <div class="text-yellow-400 text-sm">+800 XP</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl mb-2">🏰</div>
                        <h4 class="font-bold text-green-300 mb-2">Fortress Defense</h4>
                        <p class="text-sm text-gray-300 mb-3">Build 20 traps in a single game</p>
                        <div class="text-yellow-400 text-sm">+600 XP</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl mb-2">🌟</div>
                        <h4 class="font-bold text-cyan-300 mb-2">Perfect Strike</h4>
                        <p class="text-sm text-gray-300 mb-3">Achieve 100x combo multiplier</p>
                        <div class="text-yellow-400 text-sm">+1200 XP</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-3xl mb-2">🔮</div>
                        <h4 class="font-bold text-purple-300 mb-2">Mystic Challenge</h4>
                        <p class="text-sm text-gray-300 mb-3">Use only void traps for entire game</p>
                        <div class="text-yellow-400 text-sm">+1500 XP</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Modals -->
    <div id="pauseModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-md w-full mx-4 animate-zoom-in">
            <h2 class="text-3xl font-bold text-center mb-6 game-title">Mission Paused</h2>
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">⏸️</div>
                <p class="text-gray-300">Operations temporarily suspended</p>
            </div>
            <div class="space-y-4">
                <button id="resumeBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">▶️</span> Resume Mission
                    </span>
                </button>
                <button id="restartBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 py-4 rounded-lg text-lg font-semibold transition-all">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">🔄</span> Restart Wave
                    </span>
                </button>
                <button id="quitBtn" class="w-full bg-red-500 hover:bg-red-600 py-4 rounded-lg text-lg font-semibold transition-all">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">🏠</span> Return to Base
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="gameOverModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-lg w-full mx-4 animate-zoom-in">
            <h2 id="gameOverTitle" class="text-3xl font-bold text-center mb-6 game-title">Mission Report</h2>
            <div id="finalStats" class="text-center mb-6">
                <!-- Enhanced stats will be populated here -->
            </div>
            <div id="achievements" class="mb-6">
                <!-- New achievements will be shown here -->
            </div>
            <div class="space-y-4">
                <button id="playAgainBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">🎮</span> New Mission
                    </span>
                </button>
                <button id="menuBtn" class="w-full bg-gray-600 hover:bg-gray-500 py-4 rounded-lg text-lg font-semibold transition-all">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">🏠</span> Command Center
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Level Up Modal -->
    <div id="levelUpModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-md w-full mx-4 animate-bounce-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-bounce">🎉</div>
                <h2 class="text-3xl font-bold game-title mb-2">Promotion!</h2>
                <div class="text-2xl font-bold text-cyan-300" id="newLevel">Level 2</div>
                <div class="text-lg text-gray-400" id="newRank">Soldier</div>
            </div>
            <div class="p-4 bg-blue-500/20 rounded-lg mb-6">
                <div class="font-bold text-blue-300 mb-2 text-center">🔓 New Unlocks:</div>
                <div id="unlockedFeatures" class="text-sm space-y-1">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <button id="levelUpContinueBtn" class="w-full btn-primary py-4 rounded-lg text-lg font-semibold">Continue</button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass-strong rounded-2xl p-8 max-w-md w-full mx-4 animate-zoom-in">
            <div class="text-center mb-6">
                <div class="text-6xl text-red-500 mb-4">⚠️</div>
                <h2 class="text-2xl font-bold text-red-400 mb-2">Confirm Data Deletion</h2>
                <p class="text-gray-300">This will permanently delete ALL your game data, progress, and achievements. This action cannot be undone!</p>
            </div>
            <div class="space-y-4">
                <button id="confirmDeleteBtn" class="w-full bg-red-600 hover:bg-red-700 py-4 rounded-lg text-lg font-semibold transition-all">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">🗑️</span> DELETE EVERYTHING
                    </span>
                </button>
                <button id="cancelDeleteBtn" class="w-full bg-gray-600 hover:bg-gray-500 py-4 rounded-lg text-lg font-semibold transition-all">
                    <span class="flex items-center justify-center">
                        <span class="mr-2">❌</span> Cancel
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notifications Container -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

    <script>
        // ============================================
        // ENHANCED SUPABASE CONFIGURATION
        // ============================================
        
        const SUPABASE_URL = 'https://tzbgavzhciqclgmcmoqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YmdhdnpoY2lxY2xnbWNtb3F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzMwNzYsImV4cCI6MjA2ODc0OTA3Nn0.gwjUMYjSLtiI5u5sBTZpg1S9OqVBhKvTZWttuOYPiek';
        
        let supabase = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.log('Supabase not configured, using enhanced demo mode');
        }
        
        // ============================================
        // ENHANCED GLOBAL STATE
        // ============================================
        
        let currentUser = null;
        let gameLoop = null;
        let selectedGameMode = 'classic';
        let selectedDifficulty = 'beginner';
        let playerLevel = 1;
        let playerXP = 0;
        let sessionXP = 0;
        let totalScore = 0;
        let fpsCounter = 0;
        let lastTime = 0;
        
        let userSettings = {
            autoPause: false,
            showDamageNumbers: true,
            showTrapRanges: true,
            defaultSpeed: 1,
            soundEffects: true,
            backgroundMusic: true,
            masterVolume: 80,
            graphicsQuality: 'medium',
            particleEffects: true,
            screenShake: true,
            animationQuality: true,
            showFPS: false
        };
        
        let gameState = {
            playing: false,
            paused: false,
            wave: 1,
            pizzaBucks: 100,
            lives: 5,
            score: 0,
            kills: 0,
            combo: 0,
            maxCombo: 0,
            selectedTrap: null,
            sellMode: false,
            upgradeMode: false,
            gameSpeed: 1,
            waveTimer: 45,
            enemies: [],
            traps: [],
            powerups: [],
            projectiles: [],
            effects: [],
            frameCount: 0,
            spawnTimer: 0,
            lastKillTime: 0,
            gameMode: 'classic',
            difficulty: 'beginner',
            sessionXP: 0,
            threatLevel: 'LOW',
            specialEvents: []
        };
        
        // ============================================
        // ENHANCED GAME CONFIGURATION
        // ============================================
        
        const CONFIG = {
            WAVE_DURATION: 45,
            DIFFICULTY_MODIFIERS: {
                beginner: { 
                    spawnRate: 2.0, 
                    enemyHealth: 0.6, 
                    enemySpeed: 0.7, 
                    startMoney: 200, 
                    startLives: 8,
                    xpMultiplier: 1.0
                },
                intermediate: { 
                    spawnRate: 1.2, 
                    enemyHealth: 1.0, 
                    enemySpeed: 1.0, 
                    startMoney: 120, 
                    startLives: 5,
                    xpMultiplier: 1.2
                },
                advanced: { 
                    spawnRate: 0.9, 
                    enemyHealth: 1.4, 
                    enemySpeed: 1.3, 
                    startMoney: 80, 
                    startLives: 4,
                    xpMultiplier: 1.5
                },
                expert: { 
                    spawnRate: 0.7, 
                    enemyHealth: 2.0, 
                    enemySpeed: 1.6, 
                    startMoney: 60, 
                    startLives: 3,
                    xpMultiplier: 2.0
                }
            },
            BASE_ENEMY_SPEED: 1,
            TRAP_COOLDOWNS: {
                fast: 20,
                normal: 40,
                slow: 80
            },
            COMBO_TIMEOUT: 3000,
            POWERUP_SPAWN_CHANCE: 0.15,
            LEVEL_XP_REQUIREMENTS: [0, 100, 250, 500, 800, 1200, 1700, 2300, 3000, 3800, 4700, 5700, 6800, 8000, 9300, 10700, 12200, 13800, 15500, 17300, 20000, 25000, 30000, 35000, 45000, 60000, 80000, 100000, 150000, 250000],
            CANVAS_SIZES: {
                desktop: { width: '100%', height: '500px' },
                tablet: { width: '100%', height: '450px' },
                mobile: { width: '100%', height: '350px' }
            }
        };
        
        // ============================================
        // ENHANCED ENEMY TYPES WITH ASSET PATHS
        // ============================================
        
        const ENEMY_TYPES = {
            basic_vampire: {
                name: 'Vampire Pizza',
                health: 60,
                speed: 1.0,
                reward: 20,
                scoreValue: 10,
                color: '#8B4513',
                asset: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/vampire.png',
                abilities: [],
                rarity: 'common',
                spawnWeight: 100,
                minWave: 1,
                xpReward: 3,
                size: 35
            },
            
            zombie_pizza: {
                name: 'Zombie Pizza',
                health: 100,
                speed: 0.6,
                reward: 25,
                scoreValue: 15,
                color: '#556B2F',
                asset: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/zombie_pizza.png',
                abilities: ['regeneration'],
                rarity: 'common',
                spawnWeight: 80,
                minWave: 2,
                xpReward: 4,
                size: 35
            },
            
            werewolf_pizza: {
                name: 'Werewolf Pizza',
                health: 50,
                speed: 2.2,
                reward: 30,
                scoreValue: 25,
                color: '#8B4513',
                asset: 'https://raw.githubusercontent.com/4eudh/pizza-game/main/were_pizza.png',
                abilities: ['speed_boost', 'howl'],
                rarity: 'uncommon',
                spawnWeight: 60,
                minWave: 3,
                xpReward: 6,
                size: 40
            },
            
            shadow_pizza: {
                name: 'Shadow Pizza',
                health: 80,
                speed: 1.8,
                reward: 40,
                scoreValue: 30,
                color: '#4B0082',
                asset: 'shadow_pizza.png',
                abilities: ['invisibility', 'phase'],
                rarity: 'uncommon',
                spawnWeight: 45,
                minWave: 4,
                xpReward: 8,
                size: 35
            },
            
            armored_pizza: {
                name: 'Armored Pizza',
                health: 200,
                speed: 0.7,
                reward: 50,
                scoreValue: 40,
                color: '#708090',
                asset: 'armored_pizza.png',
                abilities: ['armor', 'reflect'],
                rarity: 'rare',
                spawnWeight: 30,
                minWave: 6,
                xpReward: 12,
                size: 45
            },
            
            flying_pizza: {
                name: 'Flying Pizza',
                health: 60,
                speed: 2.5,
                reward: 45,
                scoreValue: 35,
                color: '#87CEEB',
                asset: 'flying_pizza.png',
                abilities: ['flying', 'swoop'],
                rarity: 'rare',
                spawnWeight: 25,
                minWave: 7,
                xpReward: 10,
                size: 40
            },
            
            inferno_pizza: {
                name: 'Inferno Pizza',
                health: 180,
                speed: 1.4,
                reward: 65,
                scoreValue: 50,
                color: '#FF4500',
                asset: 'inferno_pizza.png',
                abilities: ['fire_aura', 'burn_trail'],
                rarity: 'epic',
                spawnWeight: 20,
                minWave: 10,
                xpReward: 18,
                size: 45
            },
            
            frost_pizza: {
                name: 'Frost Pizza',
                health: 160,
                speed: 1.1,
                reward: 60,
                scoreValue: 45,
                color: '#00BFFF',
                asset: 'frost_pizza.png',
                abilities: ['freeze_aura', 'ice_armor'],
                rarity: 'epic',
                spawnWeight: 18,
                minWave: 11,
                xpReward: 16,
                size: 45
            },
            
            lightning_pizza: {
                name: 'Lightning Pizza',
                health: 120,
                speed: 3.0,
                reward: 80,
                scoreValue: 60,
                color: '#FFD700',
                asset: 'lightning_pizza.png',
                abilities: ['lightning_speed', 'shock'],
                rarity: 'legendary',
                spawnWeight: 12,
                minWave: 15,
                xpReward: 25,
                size: 40
            },
            
            void_pizza: {
                name: 'Void Pizza',
                health: 300,
                speed: 1.6,
                reward: 120,
                scoreValue: 100,
                color: '#800080',
                asset: 'void_pizza.png',
                abilities: ['void_walk', 'absorb_energy'],
                rarity: 'legendary',
                spawnWeight: 8,
                minWave: 18,
                xpReward: 35,
                size: 50
            },
            
            cthulhu_boss: {
                name: 'Cosmic Horror Pizza',
                health: 1500,
                speed: 0.4,
                reward: 300,
                scoreValue: 1000,
                color: '#228B22',
                asset: 'cthulhu_boss.png',
                abilities: ['boss', 'summon_minions', 'cosmic_rage'],
                isBoss: true,
                rarity: 'boss',
                spawnWeight: 3,
                minWave: 20,
                xpReward: 150,
                size: 65
            }
        };
        
        // ============================================
        // ENHANCED TRAP TYPES WITH ASSET PATHS
        // ============================================
        
        const TRAP_TYPES = {
            garlic_tower: {
                name: 'Garlic Cannon',
                cost: 30,
                damage: 35,
                range: 100,
                cooldown: 'normal',
                color: '#FFFACD',
                asset: 'garlic_cannon.png',
                abilities: ['poison_shot'],
                upgrades: ['damage', 'range', 'poison_duration'],
                requiredLevel: 1,
                description: 'Basic anti-vampire defense'
            },
            
            pizza_cutter: {
                name: 'Whirling Cutter',
                cost: 50,
                damage: 60,
                range: 80,
                cooldown: 'fast',
                color: '#C0C0C0',
                asset: 'pizza_cutter.png',
                abilities: ['slice', 'bleed'],
                upgrades: ['damage', 'attack_speed', 'bleed_chance'],
                requiredLevel: 2,
                description: 'High-speed slicing action'
            },
            
            holy_water: {
                name: 'Sacred Sprinkler',
                cost: 80,
                damage: 45,
                range: 120,
                cooldown: 'normal',
                color: '#87CEEB',
                asset: 'holy_water.png',
                abilities: ['area_damage', 'purify'],
                upgrades: ['damage', 'area_size', 'purify_power'],
                requiredLevel: 3,
                description: 'Sanctified area denial'
            },
            
            mirror_trap: {
                name: 'Reflection Array',
                cost: 100,
                damage: 70,
                range: 90,
                cooldown: 'normal',
                color: '#E6E6FA',
                asset: 'mirror_trap.png',
                abilities: ['reflect_damage', 'dazzle'],
                upgrades: ['damage', 'reflect_chance', 'dazzle_duration'],
                requiredLevel: 4,
                description: 'Redirects enemy attacks'
            },
            
            ice_cannon: {
                name: 'Cryo Cannon',
                cost: 90,
                damage: 40,
                range: 110,
                cooldown: 'normal',
                color: '#B0E0E6',
                asset: 'ice_cannon.png',
                abilities: ['freeze', 'slow_aura'],
                upgrades: ['freeze_duration', 'slow_power', 'range'],
                requiredLevel: 5,
                description: 'Freezes enemies solid'
            },
            
            stake_launcher: {
                name: 'Ballista Turret',
                cost: 130,
                damage: 100,
                range: 160,
                cooldown: 'slow',
                color: '#8B4513',
                asset: 'stake_launcher.png',
                abilities: ['piercing', 'critical_strike'],
                upgrades: ['damage', 'pierce_count', 'critical_chance'],
                requiredLevel: 6,
                description: 'High-damage piercing shots'
            },
            
            explosive_mine: {
                name: 'Plasma Mine',
                cost: 150,
                damage: 120,
                range: 70,
                cooldown: 'slow',
                color: '#FF4500',
                asset: 'explosive_mine.png',
                abilities: ['explosion', 'chain_reaction'],
                upgrades: ['damage', 'explosion_radius', 'chain_chance'],
                requiredLevel: 8,
                description: 'Devastating area explosion'
            },
            
            lightning_rod: {
                name: 'Tesla Coil',
                cost: 180,
                damage: 90,
                range: 200,
                cooldown: 'slow',
                color: '#FFD700',
                asset: 'lightning_rod.png',
                abilities: ['chain_lightning', 'emp_blast'],
                upgrades: ['damage', 'chain_count', 'emp_duration'],
                requiredLevel: 10,
                description: 'Electrifies multiple targets'
            },
            
            laser_turret: {
                name: 'Photon Cannon',
                cost: 220,
                damage: 140,
                range: 180,
                cooldown: 'normal',
                color: '#FF00FF',
                asset: 'laser_turret.png',
                abilities: ['laser_beam', 'armor_piercing'],
                upgrades: ['damage', 'beam_duration', 'pierce_power'],
                requiredLevel: 12,
                description: 'Continuous laser beam'
            },
            
            void_trap: {
                name: 'Singularity Engine',
                cost: 300,
                damage: 200,
                range: 150,
                cooldown: 'slow',
                color: '#800080',
                asset: 'void_trap.png',
                abilities: ['void_pull', 'reality_tear'],
                upgrades: ['damage', 'pull_strength', 'tear_duration'],
                requiredLevel: 15,
                description: 'Warps space-time itself'
            }
        };
        
        // ============================================
        // ENHANCED ACHIEVEMENTS SYSTEM
        // ============================================
        
        const ACHIEVEMENTS = {
            // Basic Combat
            first_blood: {
                name: 'First Contact',
                description: 'Eliminate your first enemy',
                icon: '🎯',
                xpReward: 10,
                condition: (stats) => stats.totalKills >= 1
            },
            
            rookie_killer: {
                name: 'Rookie Eliminator',
                description: 'Eliminate 50 enemies',
                icon: '⚔️',
                xpReward: 25,
                condition: (stats) => stats.totalKills >= 50
            },
            
            veteran_killer: {
                name: 'Veteran Eliminator',
                description: 'Eliminate 500 enemies',
                icon: '💀',
                xpReward: 100,
                condition: (stats) => stats.totalKills >= 500
            },
            
            legend_killer: {
                name: 'Legendary Eliminator',
                description: 'Eliminate 2000 enemies',
                icon: '☠️',
                xpReward: 300,
                condition: (stats) => stats.totalKills >= 2000
            },
            
            // Wave Progression
            wave_rookie: {
                name: 'Wave Rookie',
                description: 'Reach wave 10',
                icon: '🌊',
                xpReward: 30,
                condition: (stats) => stats.maxWave >= 10
            },
            
            wave_veteran: {
                name: 'Wave Veteran',
                description: 'Reach wave 25',
                icon: '🌊',
                xpReward: 75,
                condition: (stats) => stats.maxWave >= 25
            },
            
            wave_master: {
                name: 'Wave Master',
                description: 'Reach wave 50',
                icon: '🌊',
                xpReward: 200,
                condition: (stats) => stats.maxWave >= 50
            },
            
            // Combo System
            combo_starter: {
                name: 'Combo Starter',
                description: 'Achieve a 5x combo',
                icon: '🔥',
                xpReward: 15,
                condition: (stats) => stats.maxCombo >= 5
            },
            
            combo_expert: {
                name: 'Combo Expert',
                description: 'Achieve a 25x combo',
                icon: '🔥',
                xpReward: 50,
                condition: (stats) => stats.maxCombo >= 25
            },
            
            combo_legend: {
                name: 'Combo Legend',
                description: 'Achieve a 100x combo',
                icon: '🔥',
                xpReward: 150,
                condition: (stats) => stats.maxCombo >= 100
            },
            
            // Score Achievements
            scorer: {
                name: 'Score Collector',
                description: 'Achieve 50,000 points',
                icon: '🏆',
                xpReward: 40,
                condition: (stats) => stats.highScore >= 50000
            },
            
            high_scorer: {
                name: 'High Scorer',
                description: 'Achieve 250,000 points',
                icon: '🏆',
                xpReward: 100,
                condition: (stats) => stats.highScore >= 250000
            },
            
            score_master: {
                name: 'Score Master',
                description: 'Achieve 1,000,000 points',
                icon: '🏆',
                xpReward: 250,
                condition: (stats) => stats.highScore >= 1000000
            },
            
            // Survival
            survivor: {
                name: 'Survivor',
                description: 'Complete 5 missions',
                icon: '🛡️',
                xpReward: 30,
                condition: (stats) => stats.gamesPlayed >= 5
            },
            
            veteran: {
                name: 'Veteran',
                description: 'Complete 25 missions',
                icon: '🎖️',
                xpReward: 75,
                condition: (stats) => stats.gamesPlayed >= 25
            },
            
            elite_commander: {
                name: 'Elite Commander',
                description: 'Complete 100 missions',
                icon: '⭐',
                xpReward: 200,
                condition: (stats) => stats.gamesPlayed >= 100
            },
            
            // Perfect Play
            perfectionist: {
                name: 'Perfectionist',
                description: 'Complete without losing a life',
                icon: '💎',
                xpReward: 100,
                condition: (stats) => stats.perfectGames >= 1
            },
            
            flawless_commander: {
                name: 'Flawless Commander',
                description: '5 perfect completions',
                icon: '💎',
                xpReward: 300,
                condition: (stats) => stats.perfectGames >= 5
            },
            
            // Boss Battles
            boss_hunter: {
                name: 'Boss Hunter',
                description: 'Defeat 3 boss enemies',
                icon: '👑',
                xpReward: 75,
                condition: (stats) => stats.bossesKilled >= 3
            },
            
            boss_slayer: {
                name: 'Boss Slayer',
                description: 'Defeat 10 boss enemies',
                icon: '👑',
                xpReward: 150,
                condition: (stats) => stats.bossesKilled >= 10
            },
            
            // Difficulty Mastery
            elite_difficulty: {
                name: 'Elite Training',
                description: 'Win on Expert difficulty',
                icon: '🔴',
                xpReward: 200,
                condition: (stats) => stats.expertWins >= 1
            },
            
            elite_master: {
                name: 'Elite Master',
                description: '10 Expert difficulty wins',
                icon: '🔴',
                xpReward: 500,
                condition: (stats) => stats.expertWins >= 10
            },
            
            // Special Modes
            speed_runner: {
                name: 'Speed Runner',
                description: 'Complete Blitz mode',
                icon: '⚡',
                xpReward: 60,
                condition: (stats) => stats.speedCompleted >= 1
            },
            
            endless_warrior: {
                name: 'Endless Warrior',
                description: 'Reach wave 40 in Endless',
                icon: '♾️',
                xpReward: 150,
                condition: (stats) => stats.endlessWaves >= 40
            },
            
            // Economy
            wealthy: {
                name: 'Wealthy Commander',
                description: 'Accumulate 2,000 credits',
                icon: '💰',
                xpReward: 50,
                condition: (stats) => stats.maxMoney >= 2000
            },
            
            tycoon: {
                name: 'Defense Tycoon',
                description: 'Accumulate 10,000 credits',
                icon: '💰',
                xpReward: 150,
                condition: (stats) => stats.maxMoney >= 10000
            },
            
            // Building
            architect: {
                name: 'Defense Architect',
                description: 'Build 100 total traps',
                icon: '🏗️',
                xpReward: 75,
                condition: (stats) => stats.totalTrapsBuilt >= 100
            },
            
            master_builder: {
                name: 'Master Builder',
                description: 'Build 500 total traps',
                icon: '🏗️',
                xpReward: 200,
                condition: (stats) => stats.totalTrapsBuilt >= 500
            }
        };
        
        // ============================================
        // ENHANCED LEVEL SYSTEM & REWARDS
        // ============================================
        
        const LEVEL_REWARDS = {
            2: { traps: ['pizza_cutter'], features: ['Enhanced targeting system'] },
            3: { traps: ['holy_water'], features: ['Area damage effects'] },
            4: { traps: ['mirror_trap'], features: ['Reflection mechanics'] },
            5: { traps: ['ice_cannon'], features: ['Freeze abilities'] },
            6: { traps: ['stake_launcher'], features: ['Piercing attacks'] },
            8: { traps: ['explosive_mine'], features: ['Chain reactions'] },
            10: { traps: ['lightning_rod'], features: ['Chain lightning'] },
            12: { traps: ['laser_turret'], features: ['Continuous beams'] },
            15: { traps: ['void_trap'], features: ['Reality manipulation'] }
        };
        
        // ============================================
        // ENHANCED UTILITY FUNCTIONS
        // ============================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showNotification(message, type = 'info', duration = 4000) {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
                achievement: 'bg-purple-500',
                levelup: 'bg-gradient-to-r from-purple-500 to-pink-500'
            };
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️',
                achievement: '🏆',
                levelup: '⬆️'
            };
            
            notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg font-semibold max-w-sm animate-slide-up`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-xl">${icons[type]}</div>
                    <div class="flex-1">${message}</div>
                    <button class="text-white/70 hover:text-white ml-2" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
        
        function playSound(soundName) {
            if (!userSettings.soundEffects) return;
            
            // Enhanced sound effect simulation with visual feedback
            const soundEffects = {
                shoot: () => {
                    console.log('🔫 Enhanced shoot sound');
                    if (userSettings.screenShake) createMiniShake();
                },
                explosion: () => {
                    console.log('💥 Enhanced explosion sound');
                    if (userSettings.screenShake) createScreenShake();
                },
                coin: () => {
                    console.log('💰 Enhanced coin sound');
                },
                death: () => {
                    console.log('💀 Enhanced death sound');
                    if (userSettings.screenShake) createScreenShake();
                },
                wave: () => {
                    console.log('🌊 Enhanced wave sound');
                },
                upgrade: () => {
                    console.log('⬆️ Enhanced upgrade sound');
                },
                error: () => {
                    console.log('❌ Enhanced error sound');
                },
                levelup: () => {
                    console.log('🎉 Enhanced level up sound');
                    if (userSettings.particleEffects) createCelebrationEffect();
                },
                achievement: () => {
                    console.log('🏆 Enhanced achievement sound');
                    if (userSettings.particleEffects) createAchievementEffect();
                }
            };
            
            if (soundEffects[soundName]) {
                soundEffects[soundName]();
            }
        }
        
        function createScreenShake() {
            if (!userSettings.screenShake) return;
            
            const canvas = document.getElementById('gameCanvas');
            canvas.style.animation = 'shake 0.3s ease-in-out';
            
            setTimeout(() => {
                canvas.style.animation = '';
            }, 300);
        }
        
        function createMiniShake() {
            if (!userSettings.screenShake) return;
            
            const canvas = document.getElementById('gameCanvas');
            canvas.style.transform = 'translateX(2px)';
            
            setTimeout(() => {
                canvas.style.transform = 'translateX(-2px)';
                setTimeout(() => {
                    canvas.style.transform = '';
                }, 50);
            }, 50);
        }
        
        function createCelebrationEffect() {
            if (!userSettings.particleEffects) return;
            
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle-effect';
                    particle.style.cssText = `
                        left: ${Math.random() * window.innerWidth}px;
                        top: ${Math.random() * window.innerHeight}px;
                        background: linear-gradient(45deg, #FFD700, #FF4500, #FF69B4);
                    `;
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 1000);
                }, i * 100);
            }
        }
        
        function createAchievementEffect() {
            if (!userSettings.particleEffects) return;
            
            const effect = document.createElement('div');
            effect.className = 'fixed inset-0 pointer-events-none z-40';
            effect.innerHTML = `
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-8xl animate-bounce-in">
                    🏆
                </div>
            `;
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 2000);
        }
        
        function updatePlayerLevel() {
            const xpNeeded = CONFIG.LEVEL_XP_REQUIREMENTS[playerLevel] || (playerLevel * 200);
            const rankInfo = getRankInfo(playerLevel);
            
            document.getElementById('playerLevel').textContent = `Level ${playerLevel} ${rankInfo.name}`;
            document.getElementById('playerXP').textContent = `${playerXP} / ${xpNeeded} XP`;
            document.getElementById('playerRank').textContent = `Combat Rating: ${rankInfo.name}`;
            
            const progress = Math.min((playerXP / xpNeeded) * 100, 100);
            document.getElementById('xpProgress').style.width = `${progress}%`;
            
            // Update rank display styling
            const rankDisplays = document.querySelectorAll('.rank-display');
            rankDisplays.forEach(display => {
                display.className = `rank-display ${rankInfo.class}`;
            });
        }
        
        function checkLevelUp() {
            const xpNeeded = CONFIG.LEVEL_XP_REQUIREMENTS[playerLevel] || (playerLevel * 200);
            
            if (playerXP >= xpNeeded && playerLevel < 30) {
                playerXP -= xpNeeded;
                playerLevel++;
                
                showLevelUpModal();
                savePlayerProgress();
                updateLeaderboardData();
                
                return true;
            }
            return false;
        }
        
        function showLevelUpModal() {
            const modal = document.getElementById('levelUpModal');
            const rankInfo = getRankInfo(playerLevel);
            
            document.getElementById('newLevel').textContent = `Level ${playerLevel}`;
            document.getElementById('newRank').textContent = rankInfo.name;
            
            const rewards = LEVEL_REWARDS[playerLevel];
            if (rewards) {
                const featuresHtml = rewards.features?.map(f => `<div class="text-cyan-300">• ${f}</div>`).join('') || '';
                const trapsHtml = rewards.traps?.map(t => `<div class="text-yellow-300">• ${TRAP_TYPES[t].name}</div>`).join('') || '';
                
                document.getElementById('unlockedFeatures').innerHTML = featuresHtml + trapsHtml;
            } else {
                document.getElementById('unlockedFeatures').innerHTML = '<div class="text-green-300">• Increased combat effectiveness</div>';
            }
            
            modal.classList.remove('hidden');
            playSound('levelup');
            showNotification(`🎉 Promotion achieved! Welcome to Level ${playerLevel}!`, 'levelup', 6000);
        }
        
        function getRankInfo(level) {
            const ranks = [
                { name: 'Recruit', class: '', minLevel: 1 },
                { name: 'Private', class: '', minLevel: 2 },
                { name: 'Corporal', class: '', minLevel: 3 },
                { name: 'Sergeant', class: '', minLevel: 4 },
                { name: 'Lieutenant', class: 'advanced', minLevel: 5 },
                { name: 'Captain', class: 'advanced', minLevel: 7 },
                { name: 'Major', class: 'advanced', minLevel: 9 },
                { name: 'Colonel', class: 'veteran', minLevel: 12 },
                { name: 'General', class: 'veteran', minLevel: 15 },
                { name: 'Marshal', class: 'veteran', minLevel: 18 },
                { name: 'War Chief', class: 'elite', minLevel: 20 },
                { name: 'Battle Master', class: 'elite', minLevel: 22 },
                { name: 'Combat Legend', class: 'elite', minLevel: 24 },
                { name: 'Elite Commander', class: 'elite', minLevel: 26 },
                { name: 'Legendary Guardian', class: 'legendary', minLevel: 28 },
                { name: 'Cosmic Protector', class: 'legendary', minLevel: 30 }
            ];
            
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (level >= ranks[i].minLevel) {
                    return ranks[i];
                }
            }
            return ranks[0];
        }
        
        function addXP(amount) {
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[selectedDifficulty];
            const finalXP = Math.floor(amount * difficultyMod.xpMultiplier);
            
            playerXP += finalXP;
            sessionXP += finalXP;
            gameState.sessionXP = sessionXP;
            
            updatePlayerLevel();
            checkLevelUp();
            
            // Show XP gain
            if (userSettings.showDamageNumbers && gameState.playing) {
                const canvas = document.getElementById('gameCanvas');
                const rect = canvas.getBoundingClientRect();
                showEnhancedDamageNumber(rect.width - 100, 50, `+${finalXP} XP`, 'heal');
            }
        }
        
        function savePlayerProgress() {
            const progress = {
                level: playerLevel,
                xp: playerXP,
                totalScore: totalScore,
                lastPlayed: Date.now()
            };
            localStorage.setItem(`playerProgress_${currentUser.id}`, JSON.stringify(progress));
        }
        
        function loadPlayerProgress() {
            const saved = localStorage.getItem(`playerProgress_${currentUser.id}`);
            if (saved) {
                const progress = JSON.parse(saved);
                playerLevel = progress.level || 1;
                playerXP = progress.xp || 0;
                totalScore = progress.totalScore || 0;
            }
            updatePlayerLevel();
            document.getElementById('totalScore').textContent = totalScore.toLocaleString();
        }
        
        // ============================================
        // ENHANCED RESPONSIVE FUNCTIONS
        // ============================================
        
        function updateCanvasSize() {
            const canvas = document.getElementById('gameCanvas');
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            
            let height;
            if (window.innerWidth >= 1024) {
                height = 500;
            } else if (window.innerWidth >= 768) {
                height = 450;
            } else if (window.innerWidth >= 640) {
                height = 400;
            } else {
                height = 350;
            }
            
            canvas.style.height = `${height}px`;
            canvas.style.width = '100%';
            
            // Update path width
            const path = canvas.querySelector('.game-path');
            if (path) {
                const pathWidth = Math.max(80, Math.min(180, containerWidth * 0.15));
                path.style.width = `${pathWidth}px`;
            }
        }
        
        function handleResize() {
            updateCanvasSize();
            updateUI();
        }
        
        // ============================================
        // ENHANCED GAME LOGIC
        // ============================================
        
        function initGame() {
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[selectedDifficulty];
            
            gameState = {
                playing: true,
                paused: false,
                wave: 1,
                pizzaBucks: difficultyMod.startMoney,
                lives: difficultyMod.startLives,
                score: 0,
                kills: 0,
                combo: 0,
                maxCombo: 0,
                selectedTrap: null,
                sellMode: false,
                upgradeMode: false,
                gameSpeed: userSettings.defaultSpeed,
                waveTimer: CONFIG.WAVE_DURATION,
                enemies: [],
                traps: [],
                powerups: [],
                projectiles: [],
                effects: [],
                frameCount: 0,
                spawnTimer: 0,
                lastKillTime: 0,
                gameMode: selectedGameMode,
                difficulty: selectedDifficulty,
                sessionXP: 0,
                threatLevel: 'LOW',
                specialEvents: []
            };
            
            sessionXP = 0;
            setupEnhancedTrapShop();
            clearCanvas();
            updateCanvasSize();
            updateUI();
            showScreen('gameScreen');
            startGameLoop();
            
            const modeNames = {
                classic: 'Classic Defense',
                endless: 'Endless Survival', 
                boss_rush: 'Boss Elimination',
                speed: 'Blitz Protocol'
            };
            
            document.getElementById('gameMode').textContent = modeNames[selectedGameMode];
            document.getElementById('gameDifficulty').textContent = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
            
            // Update threat level display
            updateThreatLevel();
            
            showNotification(`🚀 ${modeNames[selectedGameMode]} initialized! Defend the base!`, 'success');
            playSound('wave');
        }
        
        function setupEnhancedTrapShop() {
            const trapShop = document.getElementById('trapShop');
            trapShop.innerHTML = '';
            
            Object.entries(TRAP_TYPES).forEach(([key, trap]) => {
                const button = document.createElement('button');
                const isUnlocked = playerLevel >= trap.requiredLevel;
                
                button.className = `trap-btn rounded-lg p-3 text-center w-full transition-all duration-300 ${!isUnlocked ? 'opacity-40' : ''}`;
                
                const canAfford = gameState.pizzaBucks >= trap.cost;
                const costColor = canAfford ? 'text-yellow-400' : 'text-red-400';
                
                button.innerHTML = `
                    <div class="text-2xl mb-2">
                        <img src="${trap.asset}" alt="${trap.name}" class="w-8 h-8 mx-auto" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span style="display:none;">🛡️</span>
                    </div>
                    <div class="text-xs font-bold mb-1">${trap.name}</div>
                    <div class="text-xs ${costColor} mb-1">$${trap.cost}</div>
                    <div class="text-xs text-gray-400">
                        <div>DMG: ${trap.damage}</div>
                        <div>RNG: ${trap.range}</div>
                    </div>
                    ${!isUnlocked ? `<div class="text-xs text-red-400 mt-1">Level ${trap.requiredLevel}</div>` : ''}
                `;
                
                if (isUnlocked) {
                    button.addEventListener('click', () => selectTrap(key));
                } else {
                    button.addEventListener('click', () => {
                        showNotification(`❌ Requires Level ${trap.requiredLevel}!`, 'error');
                    });
                }
                
                button.id = `trap_${key}`;
                trapShop.appendChild(button);
            });
        }
        
        function selectTrap(trapType) {
            const trap = TRAP_TYPES[trapType];
            if (playerLevel < trap.requiredLevel) {
                showNotification(`❌ Requires Level ${trap.requiredLevel}!`, 'error');
                return;
            }
            
            if (gameState.pizzaBucks >= trap.cost) {
                gameState.selectedTrap = trapType;
                gameState.sellMode = false;
                gameState.upgradeMode = false;
                updateTrapButtons();
                showNotification(`🛡️ ${trap.name} selected - Click to deploy!`, 'info');
                playSound('upgrade');
            } else {
                showNotification('❌ Insufficient credits!', 'error');
                playSound('error');
            }
        }
        
        function updateTrapButtons() {
            Object.keys(TRAP_TYPES).forEach(key => {
                const button = document.getElementById(`trap_${key}`);
                const trap = TRAP_TYPES[key];
                
                if (!button) return;
                
                button.classList.remove('selected', 'disabled');
                
                if (gameState.selectedTrap === key) {
                    button.classList.add('selected');
                }
                
                if (gameState.pizzaBucks < trap.cost || playerLevel < trap.requiredLevel) {
                    button.classList.add('disabled');
                }
            });
        }
        
        function updateThreatLevel() {
            let level = 'LOW';
            let color = 'text-green-400';
            
            if (gameState.wave >= 5 && gameState.wave < 15) {
                level = 'MEDIUM';
                color = 'text-yellow-400';
            } else if (gameState.wave >= 15 && gameState.wave < 25) {
                level = 'HIGH';
                color = 'text-orange-400';
            } else if (gameState.wave >= 25) {
                level = 'CRITICAL';
                color = 'text-red-400';
            }
            
            gameState.threatLevel = level;
            const threatDisplay = document.getElementById('threatLevel');
            if (threatDisplay) {
                threatDisplay.innerHTML = `Threat Level: <span class="${color} font-bold">${level}</span>`;
            }
        }
        
        function getEnemyTypeForWave(wave) {
            const availableEnemies = Object.entries(ENEMY_TYPES).filter(([key, enemy]) => {
                return wave >= enemy.minWave;
            });
            
            if (availableEnemies.length === 0) {
                return 'basic_vampire';
            }
            
            // Enhanced boss spawn logic
            if (gameState.gameMode === 'boss_rush') {
                const bossTypes = availableEnemies.filter(([key, enemy]) => enemy.isBoss || enemy.rarity === 'legendary');
                if (bossTypes.length > 0) {
                    return bossTypes[Math.floor(Math.random() * bossTypes.length)][0];
                }
            }
            
            // Regular boss spawns
            if (wave % 10 === 0 && wave >= 10 && Math.random() < 0.4) {
                return 'cthulhu_boss';
            }
            
            // Enhanced weighted spawn system
            const spawnPool = [];
            availableEnemies.forEach(([key, enemy]) => {
                let adjustedWeight = enemy.spawnWeight;
                
                // Dynamic weight adjustment based on wave
                const waveProgressFactor = Math.min(wave / 20, 1);
                
                if (enemy.rarity === 'common') {
                    adjustedWeight *= Math.max(0.2, 1 - waveProgressFactor * 0.6);
                } else if (enemy.rarity === 'uncommon') {
                    adjustedWeight *= 1 + waveProgressFactor * 0.3;
                } else if (enemy.rarity === 'rare') {
                    adjustedWeight *= 1 + waveProgressFactor * 0.5;
                } else if (enemy.rarity === 'epic') {
                    adjustedWeight *= Math.max(0, waveProgressFactor - 0.3) * 2;
                } else if (enemy.rarity === 'legendary') {
                    adjustedWeight *= Math.max(0, waveProgressFactor - 0.6) * 3;
                }
                
                // Add to spawn pool
                for (let i = 0; i < Math.ceil(adjustedWeight); i++) {
                    spawnPool.push(key);
                }
            });
            
            return spawnPool[Math.floor(Math.random() * spawnPool.length)] || 'basic_vampire';
        }
        
        function spawnEnemy() {
            const enemyType = getEnemyTypeForWave(gameState.wave);
            const enemyTemplate = ENEMY_TYPES[enemyType];
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty];
            
            const healthMultiplier = difficultyMod.enemyHealth * (1 + (gameState.wave * 0.08));
            const speedMultiplier = difficultyMod.enemySpeed * (1 + (gameState.wave * 0.02));
            
            const canvas = document.getElementById('gameCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const pathWidth = canvas.querySelector('.game-path').offsetWidth;
            
            const enemy = {
                id: Date.now() + Math.random(),
                type: enemyType,
                x: canvasRect.width,
                y: 50 + Math.random() * (canvasRect.height - 100),
                health: Math.floor(enemyTemplate.health * healthMultiplier),
                maxHealth: Math.floor(enemyTemplate.health * healthMultiplier),
                speed: enemyTemplate.speed * speedMultiplier,
                reward: Math.floor(enemyTemplate.reward * (1 + gameState.wave * 0.05)),
                scoreValue: Math.floor(enemyTemplate.scoreValue * (1 + gameState.wave * 0.1)),
                xpReward: Math.floor(enemyTemplate.xpReward * (1 + gameState.wave * 0.1)),
                color: enemyTemplate.color,
                asset: enemyTemplate.asset,
                abilities: [...enemyTemplate.abilities],
                effects: {},
                shield: 0,
                maxShield: 0,
                rarity: enemyTemplate.rarity,
                size: enemyTemplate.size,
                pathWidth: pathWidth
            };
            
            // Add shields for armored enemies
            if (enemyTemplate.abilities?.includes('armor')) {
                enemy.shield = Math.floor(enemy.maxHealth * 0.4);
                enemy.maxShield = enemy.shield;
            }
            
            gameState.enemies.push(enemy);
            createEnemyElement(enemy);
        }
        
        function createEnemyElement(enemy) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = `entity enemy gpu-accelerated ${ENEMY_TYPES[enemy.type].isBoss ? 'boss' : ''} ${enemy.rarity}`;
            element.id = `enemy_${enemy.id}`;
            
            const size = enemy.size;
            element.style.cssText = `
                left: ${enemy.x}px;
                top: ${enemy.y}px;
                width: ${size}px;
                height: ${size}px;
                background: ${enemy.color};
                z-index: 10;
                font-size: ${Math.max(12, size * 0.4)}px;
            `;
            
            // Create image element with fallback
            const img = document.createElement('img');
            img.src = enemy.asset;
            img.alt = enemy.type;
            img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: inherit;';
            img.onerror = function() {
                // Fallback to text if image fails to load
                this.style.display = 'none';
                element.textContent = '👾'; // Generic enemy icon
            };
            
            element.appendChild(img);
            
            // Enhanced health bar
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar';
            healthBar.innerHTML = '<div class="health-fill" style="width: 100%"></div>';
            element.appendChild(healthBar);
            
            // Shield bar for armored enemies
            if (enemy.shield > 0) {
                const shieldBar = document.createElement('div');
                shieldBar.className = 'shield-bar';
                shieldBar.innerHTML = '<div class="shield-fill" style="width: 100%"></div>';
                element.appendChild(shieldBar);
            }
            
            canvas.appendChild(element);
        }
        
        function updateEnemies() {
            gameState.enemies.forEach((enemy, index) => {
                // Enhanced movement system
                let moveSpeed = enemy.speed * gameState.gameSpeed;
                
                // Apply effects
                if (enemy.effects.slow) {
                    moveSpeed *= 0.3;
                    enemy.effects.slow--;
                    if (enemy.effects.slow <= 0) delete enemy.effects.slow;
                }
                
                if (enemy.effects.freeze) {
                    moveSpeed = 0;
                    enemy.effects.freeze--;
                    if (enemy.effects.freeze <= 0) delete enemy.effects.freeze;
                }
                
                // Enhanced path following
                const targetX = enemy.pathWidth / 2;
                const deltaX = targetX - enemy.x;
                
                if (Math.abs(deltaX) > 5) {
                    // Move towards path center while advancing
                    enemy.x += (deltaX > 0 ? 1 : -1) * Math.min(Math.abs(deltaX) * 0.1, moveSpeed * 0.3);
                    enemy.x -= moveSpeed * 0.7;
                } else {
                    // On path, move normally
                    enemy.x -= moveSpeed;
                }
                
                const element = document.getElementById(`enemy_${enemy.id}`);
                if (element) {
                    element.style.left = `${enemy.x}px`;
                    
                    // Update health bar
                    const healthFill = element.querySelector('.health-fill');
                    if (healthFill) {
                        const healthPercent = (enemy.health / enemy.maxHealth) * 100;
                        healthFill.style.width = `${healthPercent}%`;
                    }
                    
                    // Update shield bar
                    const shieldFill = element.querySelector('.shield-fill');
                    if (shieldFill && enemy.maxShield > 0) {
                        const shieldPercent = (enemy.shield / enemy.maxShield) * 100;
                        shieldFill.style.width = `${shieldPercent}%`;
                    }
                    
                    // Enhanced visual effects
                    if (enemy.effects.freeze) {
                        element.style.filter = 'hue-rotate(240deg) brightness(0.8) blur(1px)';
                    } else if (enemy.effects.slow) {
                        element.style.filter = 'hue-rotate(60deg) brightness(1.2)';
                    } else {
                        element.style.filter = '';
                    }
                }
                
                // Check if reached end
                if (enemy.x < -enemy.size) {
                    gameState.lives--;
                    element?.remove();
                    gameState.enemies.splice(index, 1);
                    showNotification('🚨 Breach detected! Life lost!', 'error');
                    playSound('death');
                    createScreenShake();
                    
                    if (gameState.lives <= 0) {
                        gameOver();
                    }
                    return;
                }
                
                // Check if dead
                if (enemy.health <= 0) {
                    handleEnemyDeath(enemy, index, element);
                }
            });
        }
        
        function handleEnemyDeath(enemy, index, element) {
            gameState.pizzaBucks += enemy.reward;
            gameState.score += enemy.scoreValue * Math.max(1, gameState.combo);
            gameState.kills++;
            
            // Add XP
            addXP(enemy.xpReward);
            
            // Enhanced combo system
            if (Date.now() - gameState.lastKillTime < CONFIG.COMBO_TIMEOUT) {
                gameState.combo++;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
            } else {
                gameState.combo = 1;
            }
            gameState.lastKillTime = Date.now();
            
            element?.remove();
            gameState.enemies.splice(index, 1);
            
            // Enhanced damage numbers
            if (userSettings.showDamageNumbers) {
                showEnhancedDamageNumber(enemy.x, enemy.y, `+$${enemy.reward}`, 'money');
                if (gameState.combo > 1) {
                    showEnhancedDamageNumber(enemy.x, enemy.y - 25, `${gameState.combo}x COMBO!`, 'combo');
                }
            }
            
            // Enhanced death effects
            if (userSettings.particleEffects) {
                createEnhancedExplosionEffect(enemy.x, enemy.y, enemy.rarity);
            }
            
            // Enhanced powerup spawning
            let powerupChance = CONFIG.POWERUP_SPAWN_CHANCE;
            const rarityMultipliers = {
                common: 1,
                uncommon: 1.5,
                rare: 2.5,
                epic: 4,
                legendary: 6,
                boss: 10
            };
            
            powerupChance *= rarityMultipliers[enemy.rarity] || 1;
            
            if (Math.random() < powerupChance) {
                spawnEnhancedPowerup(enemy.x, enemy.y, enemy.rarity);
            }
            
            // Update total score
            totalScore += enemy.scoreValue;
            
            playSound('coin');
        }
        
        function showEnhancedDamageNumber(x, y, amount, type) {
            const canvas = document.getElementById('gameCanvas');
            const damageText = document.createElement('div');
            damageText.className = `damage-number ${type} gpu-accelerated`;
            damageText.style.cssText = `
                left: ${x}px;
                top: ${y}px;
                z-index: 25;
                pointer-events: none;
            `;
            
            damageText.textContent = amount;
            
            canvas.appendChild(damageText);
            setTimeout(() => damageText.remove(), 2000);
        }
        
        function createEnhancedExplosionEffect(x, y, rarity = 'common') {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            
            // Main explosion
            const explosion = document.createElement('div');
            explosion.className = 'explosion-effect gpu-accelerated';
            
            const sizes = {
                common: 60,
                uncommon: 80,
                rare: 100,
                epic: 120,
                legendary: 150,
                boss: 200
            };
            
            const size = sizes[rarity] || 60;
            explosion.style.cssText = `
                left: ${x - size/2}px;
                top: ${y - size/2}px;
                width: ${size}px;
                height: ${size}px;
            `;
            
            canvas.appendChild(explosion);
            setTimeout(() => explosion.remove(), 800);
            
            // Additional particles for rare enemies
            if (rarity !== 'common') {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle-effect gpu-accelerated';
                        particle.style.cssText = `
                            left: ${x + (Math.random() - 0.5) * 100}px;
                            top: ${y + (Math.random() - 0.5) * 100}px;
                        `;
                        canvas.appendChild(particle);
                        setTimeout(() => particle.remove(), 1000);
                    }, i * 100);
                }
            }
        }
        
        function spawnEnhancedPowerup(x, y, rarity = 'common') {
            const powerupTypes = {
                common: ['health', 'money'],
                uncommon: ['health', 'money', 'speed'],
                rare: ['health', 'money', 'speed', 'damage'],
                epic: ['health', 'money', 'speed', 'damage', 'xp'],
                legendary: ['health', 'money', 'speed', 'damage', 'xp', 'mega_boost'],
                boss: ['health', 'money', 'speed', 'damage', 'xp', 'mega_boost', 'time_slow']
            };
            
            const availableTypes = powerupTypes[rarity] || powerupTypes.common;
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            
            const powerup = {
                id: Date.now() + Math.random(),
                type: type,
                x: x,
                y: y,
                lifetime: 600, // 10 seconds at 60fps
                rarity: rarity
            };
            
            gameState.powerups.push(powerup);
            createEnhancedPowerupElement(powerup);
        }
        
        function createEnhancedPowerupElement(powerup) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = 'entity powerup gpu-accelerated';
            element.id = `powerup_${powerup.id}`;
            
            const icons = {
                health: '❤️',
                money: '💰',
                speed: '⚡',
                damage: '💥',
                xp: '⭐',
                mega_boost: '🚀',
                time_slow: '⏰'
            };
            
            const colors = {
                common: 'linear-gradient(45deg, #FFD700, #FFA500)',
                uncommon: 'linear-gradient(45deg, #00FF00, #32CD32)',
                rare: 'linear-gradient(45deg, #0080FF, #4169E1)',
                epic: 'linear-gradient(45deg, #8A2BE2, #9370DB)',
                legendary: 'linear-gradient(45deg, #FF4500, #FF6347)',
                boss: 'linear-gradient(45deg, #FF00FF, #FF1493)'
            };
            
            element.style.cssText = `
                left: ${powerup.x}px;
                top: ${powerup.y}px;
                width: 35px;
                height: 35px;
                background: ${colors[powerup.rarity] || colors.common};
                z-index: 12;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
            `;
            
            element.textContent = icons[powerup.type] || '⭐';
            element.addEventListener('click', () => collectEnhancedPowerup(powerup));
            
            canvas.appendChild(element);
        }
        
        function collectEnhancedPowerup(powerup) {
            const effects = {
                health: () => {
                    const bonus = powerup.rarity === 'boss' ? 3 : powerup.rarity === 'legendary' ? 2 : 1;
                    gameState.lives += bonus;
                    showNotification(`❤️ ${bonus} life(s) restored!`, 'success');
                },
                money: () => {
                    const multipliers = { common: 1, uncommon: 1.5, rare: 2, epic: 3, legendary: 4, boss: 6 };
                    const bonus = Math.floor((75 + gameState.wave * 10) * (multipliers[powerup.rarity] || 1));
                    gameState.pizzaBucks += bonus;
                    showNotification(`💰 Bonus: $${bonus}!`, 'success');
                },
                speed: () => {
                    showNotification('⚡ Turbo boost activated!', 'success');
                    // Apply temporary speed boost to all traps
                    gameState.traps.forEach(trap => {
                        trap.tempSpeedBoost = 300; // 5 seconds
                    });
                },
                damage: () => {
                    showNotification('💥 Damage amplifier activated!', 'success');
                    // Apply temporary damage boost to all traps
                    gameState.traps.forEach(trap => {
                        trap.tempDamageBoost = 300; // 5 seconds
                    });
                },
                xp: () => {
                    const multipliers = { common: 1, uncommon: 1.5, rare: 2, epic: 3, legendary: 4, boss: 6 };
                    const xpBonus = Math.floor((50 + gameState.wave * 5) * (multipliers[powerup.rarity] || 1));
                    addXP(xpBonus);
                    showNotification(`⭐ XP Bonus: +${xpBonus}!`, 'success');
                },
                mega_boost: () => {
                    showNotification('🚀 MEGA BOOST ACTIVATED!', 'success');
                    gameState.traps.forEach(trap => {
                        trap.tempSpeedBoost = 600;
                        trap.tempDamageBoost = 600;
                    });
                },
                time_slow: () => {
                    showNotification('⏰ Time dilation field activated!', 'success');
                    gameState.enemies.forEach(enemy => {
                        enemy.effects.slow = 600; // 10 seconds
                    });
                }
            };
            
            effects[powerup.type]();
            
            const element = document.getElementById(`powerup_${powerup.id}`);
            element?.remove();
            
            gameState.powerups = gameState.powerups.filter(p => p.id !== powerup.id);
            playSound('upgrade');
        }
        
        function updateTraps() {
            gameState.traps.forEach(trap => {
                // Update cooldowns
                trap.cooldown = Math.max(0, trap.cooldown - 1);
                
                // Handle temporary boosts
                if (trap.tempSpeedBoost) {
                    trap.tempSpeedBoost--;
                }
                if (trap.tempDamageBoost) {
                    trap.tempDamageBoost--;
                }
                
                const element = document.getElementById(`trap_${trap.id}`);
                if (element) {
                    if (trap.cooldown === 0) {
                        element.classList.add('ready');
                        element.classList.remove('cooldown');
                    } else {
                        element.classList.remove('ready');
                        element.classList.add('cooldown');
                    }
                    
                    // Show boost effects
                    if (trap.tempSpeedBoost > 0 || trap.tempDamageBoost > 0) {
                        element.style.filter = 'brightness(1.5) hue-rotate(120deg)';
                    } else {
                        element.style.filter = '';
                    }
                }
                
                if (trap.cooldown === 0) {
                    const targets = findTargetsInRange(trap);
                    if (targets.length > 0) {
                        attackTargets(trap, targets);
                        
                        // Calculate cooldown with speed boost
                        let baseCooldown = CONFIG.TRAP_COOLDOWNS[TRAP_TYPES[trap.type].cooldown] || 60;
                        if (trap.tempSpeedBoost > 0) {
                            baseCooldown = Math.floor(baseCooldown * 0.3); // 70% faster
                        }
                        trap.cooldown = baseCooldown;
                    }
                }
            });
        }
        
        function findTargetsInRange(trap) {
            const targets = [];
            const trapType = TRAP_TYPES[trap.type];
            
            gameState.enemies.forEach(enemy => {
                const distance = Math.sqrt(
                    Math.pow(enemy.x - trap.x, 2) + 
                    Math.pow(enemy.y - trap.y, 2)
                );
                
                if (distance <= trap.range) {
                    targets.push({ enemy, distance });
                }
            });
            
            // Enhanced targeting system
            return targets
                .sort((a, b) => {
                    // Prioritize by health, distance, and type
                    const scoreA = (a.enemy.health / a.enemy.maxHealth) * 0.5 + (1 - a.distance / trap.range) * 0.3 + (a.enemy.rarity === 'boss' ? 1 : 0) * 0.2;
                    const scoreB = (b.enemy.health / b.enemy.maxHealth) * 0.5 + (1 - b.distance / trap.range) * 0.3 + (b.enemy.rarity === 'boss' ? 1 : 0) * 0.2;
                    return scoreB - scoreA;
                })
                .map(target => target.enemy);
        }
        
        function attackTargets(trap, targets) {
            const trapType = TRAP_TYPES[trap.type];
            const primary = targets[0];
            
            // Calculate damage with boost
            let damage = trap.damage;
            if (trap.tempDamageBoost > 0) {
                damage = Math.floor(damage * 1.8); // 80% more damage
            }
            
            if (trapType.abilities.includes('area_damage')) {
                // Area damage hits multiple targets
                targets.slice(0, 6).forEach(target => {
                    damageEnemy(target, damage, trap);
                });
                createEnhancedExplosionEffect(primary.x, primary.y, 'uncommon');
            } else if (trapType.abilities.includes('chain_lightning')) {
                // Enhanced chain lightning
                let currentTarget = primary;
                for (let i = 0; i < 4 && currentTarget; i++) {
                    damageEnemy(currentTarget, Math.floor(damage * (0.8 ** i)), trap);
                    createLightningEffect(trap.x, trap.y, currentTarget.x, currentTarget.y);
                    
                    // Find next closest target
                    const remaining = targets.filter(t => t !== currentTarget);
                    currentTarget = remaining.length > 0 ? remaining[0] : null;
                }
            } else if (trapType.abilities.includes('laser_beam')) {
                // Continuous laser beam
                damageEnemy(primary, damage, trap);
                createLaserEffect(trap.x, trap.y, primary.x, primary.y);
            } else {
                // Single target with enhanced projectile
                damageEnemy(primary, damage, trap);
                createEnhancedProjectileEffect(trap.x, trap.y, primary.x, primary.y, trapType.color);
            }
            
            playSound('shoot');
        }
        
        function damageEnemy(enemy, damage, trap) {
            const trapType = TRAP_TYPES[trap.type];
            let finalDamage = damage;
            
            // Enhanced special effects
            if (trapType.abilities.includes('poison_shot')) {
                enemy.effects.poison = 180; // 3 seconds
            }
            
            if (trapType.abilities.includes('freeze')) {
                enemy.effects.freeze = 120; // 2 seconds
            }
            
            if (trapType.abilities.includes('slow_aura')) {
                enemy.effects.slow = 240; // 4 seconds
            }
            
            // Enhanced critical hit system
            let critChance = 0.1; // Base 10%
            if (trapType.abilities.includes('critical_strike')) {
                critChance = 0.25; // 25% for specialized traps
            }
            
            if (Math.random() < critChance) {
                finalDamage *= 2.5;
                if (userSettings.showDamageNumbers) {
                    showEnhancedDamageNumber(enemy.x, enemy.y - 30, 'CRITICAL!', 'critical');
                }
            }
            
            // Apply damage to shield first, then health
            if (enemy.shield > 0) {
                const shieldDamage = Math.min(finalDamage, enemy.shield);
                enemy.shield -= shieldDamage;
                finalDamage -= shieldDamage;
                
                if (userSettings.showDamageNumbers) {
                    showEnhancedDamageNumber(enemy.x + 15, enemy.y - 15, `-${shieldDamage}`, 'damage');
                }
            }
            
            if (finalDamage > 0) {
                enemy.health -= finalDamage;
                
                if (userSettings.showDamageNumbers) {
                    showEnhancedDamageNumber(enemy.x, enemy.y - 15, `-${finalDamage}`, 'damage');
                }
            }
        }
        
        function createEnhancedProjectileEffect(fromX, fromY, toX, toY, color) {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            const projectile = document.createElement('div');
            projectile.className = 'projectile gpu-accelerated';
            projectile.style.cssText = `
                left: ${fromX}px;
                top: ${fromY}px;
                width: 12px;
                height: 12px;
                background: ${color};
                z-index: 15;
                transition: all 0.2s linear;
                box-shadow: 0 0 15px ${color};
            `;
            
            canvas.appendChild(projectile);
            
            setTimeout(() => {
                projectile.style.left = `${toX}px`;
                projectile.style.top = `${toY}px`;
            }, 10);
            
            setTimeout(() => {
                projectile.remove();
            }, 200);
        }
        
        function createLightningEffect(fromX, fromY, toX, toY) {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            const lightning = document.createElement('div');
            lightning.className = 'lightning-effect gpu-accelerated';
            
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            
            lightning.style.cssText = `
                left: ${fromX}px;
                top: ${fromY}px;
                width: ${length}px;
                height: 6px;
                transform: rotate(${angle}rad);
                transform-origin: left center;
            `;
            
            canvas.appendChild(lightning);
            setTimeout(() => lightning.remove(), 300);
        }
        
        function createLaserEffect(fromX, fromY, toX, toY) {
            if (!userSettings.particleEffects) return;
            
            const canvas = document.getElementById('gameCanvas');
            const laser = document.createElement('div');
            laser.className = 'laser-effect gpu-accelerated';
            
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            
            laser.style.cssText = `
                left: ${fromX}px;
                top: ${fromY}px;
                width: ${length}px;
                height: 4px;
                transform: rotate(${angle}rad);
                transform-origin: left center;
            `;
            
            canvas.appendChild(laser);
            setTimeout(() => laser.remove(), 200);
        }
        
        function updateWave() {
            gameState.waveTimer -= 1/60;
            
            if (gameState.waveTimer <= 0) {
                gameState.wave++;
                gameState.waveTimer = CONFIG.WAVE_DURATION;
                
                updateThreatLevel();
                
                // Check victory conditions
                if (selectedGameMode === 'classic' && gameState.wave > 30) {
                    victory();
                    return;
                } else if (selectedGameMode === 'boss_rush' && gameState.wave > 15) {
                    victory();
                    return;
                } else if (selectedGameMode === 'speed' && gameState.wave > 20) {
                    victory();
                    return;
                }
                
                showNotification(`🌊 Wave ${gameState.wave} incoming! Threat level: ${gameState.threatLevel}`, 'warning');
                playSound('wave');
                
                if (userSettings.autoPause) {
                    gameState.paused = true;
                    showNotification('⏸️ Auto-paused between waves', 'info');
                }
            }
        }
        
        function updatePowerups() {
            gameState.powerups.forEach((powerup, index) => {
                powerup.lifetime--;
                if (powerup.lifetime <= 0) {
                    const element = document.getElementById(`powerup_${powerup.id}`);
                    element?.remove();
                    gameState.powerups.splice(index, 1);
                } else if (powerup.lifetime < 120) {
                    // Flash when about to expire
                    const element = document.getElementById(`powerup_${powerup.id}`);
                    if (element) {
                        element.style.opacity = Math.sin(powerup.lifetime * 0.3) * 0.5 + 0.5;
                    }
                }
            });
        }
        
        function updateUI() {
            document.getElementById('pizzaBucks').textContent = gameState.pizzaBucks;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('kills').textContent = gameState.kills;
            document.getElementById('score').textContent = gameState.score.toLocaleString();
            document.getElementById('enemiesLeft').textContent = gameState.enemies.length;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('currentWave').textContent = gameState.wave;
            document.getElementById('waveTimer').textContent = `${Math.ceil(gameState.waveTimer)}s`;
            document.getElementById('speedBtn').textContent = `${gameState.gameSpeed}x`;
            document.getElementById('sessionXP').textContent = sessionXP;
            
            // Update wave progress
            const progress = ((CONFIG.WAVE_DURATION - gameState.waveTimer) / CONFIG.WAVE_DURATION) * 100;
            document.getElementById('waveProgress').style.width = `${progress}%`;
            
            // Update wave info
            const nextEnemyType = getEnemyTypeForWave(gameState.wave);
            document.getElementById('waveInfo').textContent = `Next: ${ENEMY_TYPES[nextEnemyType].name}`;
            
            updateTrapButtons();
            
            // Update FPS if enabled
            if (userSettings.showFPS) {
                updateFPS();
            }
        }
        
        function updateFPS() {
            const now = performance.now();
            const delta = now - lastTime;
            lastTime = now;
            
            if (delta > 0) {
                const fps = Math.round(1000 / delta);
                const fpsElement = document.getElementById('fpsValue');
                if (fpsElement) {
                    fpsElement.textContent = fps;
                }
            }
        }
        
        function gameUpdate() {
            if (!gameState.playing || gameState.paused) return;
            
            gameState.frameCount++;
            gameState.spawnTimer++;
            
            const difficultyMod = CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty];
            let spawnInterval = (difficultyMod.spawnRate * 60);
            
            // Dynamic spawn rate based on game mode
            if (gameState.gameMode === 'speed') {
                spawnInterval *= 0.7; // Faster spawning
            } else if (gameState.gameMode === 'boss_rush') {
                spawnInterval *= 1.5; // Slower but stronger enemies
            }
            
            // Spawn enemies
            if (gameState.spawnTimer >= spawnInterval) {
                spawnEnemy();
                gameState.spawnTimer = 0;
            }
            
            updateEnemies();
            updateTraps();
            updatePowerups();
            updateWave();
            updateUI();
        }
        
        function startGameLoop() {
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(gameUpdate, 1000 / 60); // 60 FPS
        }
        
        function pauseGame() {
            gameState.paused = !gameState.paused;
            document.getElementById('pauseModal').classList.toggle('hidden', !gameState.paused);
            
            if (gameState.paused) {
                showNotification('⏸️ Mission paused', 'info');
            } else {
                showNotification('▶️ Mission resumed', 'success');
            }
        }
        
        function victory() {
            gameState.playing = false;
            if (gameLoop) clearInterval(gameLoop);
            
            // Calculate comprehensive completion bonus
            const baseBonus = 200;
            const waveBonus = gameState.wave * 20;
            const difficultyBonus = {
                beginner: 0,
                intermediate: 100,
                advanced: 250,
                expert: 500
            }[gameState.difficulty] || 0;
            
            const modeBonus = {
                classic: 100,
                endless: 0,
                boss_rush: 300,
                speed: 200
            }[gameState.gameMode] || 0;
            
            const totalBonus = baseBonus + waveBonus + difficultyBonus + modeBonus;
            addXP(totalBonus);
            
            document.getElementById('gameOverTitle').textContent = '🎉 MISSION ACCOMPLISHED!';
            document.getElementById('finalStats').innerHTML = `
                <div class="space-y-4">
                    <div class="text-3xl text-green-400 font-bold animate-bounce">VICTORY!</div>
                    <div class="grid grid-cols-2 gap-4 text-lg">
                        <div>Final Score: <span class="text-primary font-bold">${gameState.score.toLocaleString()}</span></div>
                        <div>Waves: <span class="text-secondary font-bold">${gameState.wave - 1}</span></div>
                        <div>Eliminated: <span class="text-accent font-bold">${gameState.kills}</span></div>
                        <div>Max Combo: <span class="text-purple-400 font-bold">${gameState.maxCombo}</span></div>
                        <div>Lives Left: <span class="text-green-400 font-bold">${gameState.lives}</span></div>
                        <div>XP Earned: <span class="text-blue-400 font-bold">${sessionXP}</span></div>
                    </div>
                    <div class="text-center">
                        <div class="text-yellow-400 font-bold">Difficulty: ${gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1)}</div>
                        <div class="text-cyan-400">Mode: ${gameState.gameMode.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveGameData();
            updateLeaderboardData();
            checkAchievements();
            showNotification('🎉 Victory achieved! Base secured!', 'achievement', 8000);
            playSound('achievement');
        }
        
        function gameOver() {
            gameState.playing = false;
            if (gameLoop) clearInterval(gameLoop);
            
            // Calculate consolation XP
            const consolationXP = Math.floor((gameState.kills * 3) + (gameState.wave * 8) + (gameState.score * 0.01));
            addXP(consolationXP);
            
            document.getElementById('gameOverTitle').textContent = '💀 Mission Failed';
            document.getElementById('finalStats').innerHTML = `
                <div class="space-y-4">
                    <div class="text-3xl text-red-400 font-bold">DEFEAT</div>
                    <div class="grid grid-cols-2 gap-4 text-lg">
                        <div>Final Score: <span class="text-primary font-bold">${gameState.score.toLocaleString()}</span></div>
                        <div>Wave: <span class="text-secondary font-bold">${gameState.wave}</span></div>
                        <div>Eliminated: <span class="text-accent font-bold">${gameState.kills}</span></div>
                        <div>Max Combo: <span class="text-purple-400 font-bold">${gameState.maxCombo}</span></div>
                        <div>XP Earned: <span class="text-blue-400 font-bold">${sessionXP}</span></div>
                        <div>Difficulty: <span class="text-yellow-400 font-bold">${gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1)}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveGameData();
            updateLeaderboardData();
            checkAchievements();
            showNotification('💀 Mission failed! Regroup and try again!', 'error');
            playSound('death');
        }
        
        function checkAchievements() {
            const currentStats = getCurrentStats();
            const newAchievements = [];
            
            Object.entries(ACHIEVEMENTS).forEach(([key, achievement]) => {
                const isUnlocked = JSON.parse(localStorage.getItem(`achievement_${currentUser.id}_${key}`) || 'false');
                
                if (!isUnlocked && achievement.condition(currentStats)) {
                    localStorage.setItem(`achievement_${currentUser.id}_${key}`, 'true');
                    newAchievements.push(achievement);
                    addXP(achievement.xpReward);
                    showNotification(`🏆 Achievement: ${achievement.name}!`, 'achievement', 6000);
                    playSound('achievement');
                }
            });
            
            if (newAchievements.length > 0) {
                displayNewAchievements(newAchievements);
            }
        }
        
        function getCurrentStats() {
            const saved = JSON.parse(localStorage.getItem(`userStats_${currentUser.id}`) || '{}');
            return {
                highScore: Math.max(saved.highScore || 0, gameState.score),
                maxWave: Math.max(saved.maxWave || 0, gameState.wave),
                totalKills: (saved.totalKills || 0) + gameState.kills,
                maxCombo: Math.max(saved.maxCombo || 0, gameState.maxCombo),
                gamesPlayed: (saved.gamesPlayed || 0) + 1,
                wins: (saved.wins || 0) + (gameState.lives > 0 ? 1 : 0),
                trapsBuilt: gameState.traps.length,
                totalTrapsBuilt: (saved.totalTrapsBuilt || 0) + gameState.traps.length,
                perfectGames: (saved.perfectGames || 0) + (gameState.lives === CONFIG.DIFFICULTY_MODIFIERS[gameState.difficulty].startLives ? 1 : 0),
                bossesKilled: (saved.bossesKilled || 0) + gameState.enemies.filter(e => e.rarity === 'boss').length,
                speedGames: (saved.speedGames || 0) + (gameState.gameMode === 'speed' && gameState.lives > 0 ? 1 : 0),
                maxMoney: Math.max(saved.maxMoney || 0, gameState.pizzaBucks),
                expertWins: (saved.expertWins || 0) + (gameState.difficulty === 'expert' && gameState.lives > 0 ? 1 : 0),
                endlessWaves: gameState.gameMode === 'endless' ? Math.max(saved.endlessWaves || 0, gameState.wave) : (saved.endlessWaves || 0),
                speedCompleted: (saved.speedCompleted || 0) + (gameState.gameMode === 'speed' && gameState.lives > 0 ? 1 : 0),
                playTime: (saved.playTime || 0) + Math.floor(gameState.frameCount / 60)
            };
        }
        
        function displayNewAchievements(achievements) {
            const achievementsHtml = achievements.map(achievement => `
                <div class="bg-yellow-500/20 rounded-lg p-4 mb-3 animate-bounce-in">
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">${achievement.icon}</div>
                        <div>
                            <div class="font-bold text-yellow-300">${achievement.name}</div>
                            <div class="text-sm text-gray-300">${achievement.description}</div>
                            <div class="text-xs text-blue-400">+${achievement.xpReward} XP</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('achievements').innerHTML = `
                <h3 class="text-lg font-bold text-yellow-300 mb-4 text-center">🏆 New Achievements!</h3>
                ${achievementsHtml}
            `;
        }
        
        async function saveGameData() {
            if (!currentUser) return;
            
            const gameData = {
                user_id: currentUser.id,
                final_score: gameState.score,
                waves_completed: gameState.wave,
                enemies_killed: gameState.kills,
                max_combo: gameState.maxCombo,
                session_duration_seconds: Math.floor(gameState.frameCount / 60),
                is_victory: gameState.lives > 0,
                game_mode: gameState.gameMode,
                difficulty: gameState.difficulty,
                xp_earned: sessionXP,
                traps_built: gameState.traps.length
            };
            
            if (supabase && currentUser.id !== 'guest') {
                try {
                    await supabase.from('game_sessions').insert(gameData);
                } catch (error) {
                    console.error('Error saving game data:', error);
                }
            } else {
                // Save to localStorage for guests/demo
                const currentStats = getCurrentStats();
                localStorage.setItem(`userStats_${currentUser.id}`, JSON.stringify(currentStats));
            }
            
            savePlayerProgress();
        }
        
        function updateLeaderboardData() {
            if (!currentUser) return;
            
            // Update local leaderboard data
            const leaderboardData = {
                score: gameState.score,
                wave: gameState.wave,
                kills: gameState.kills,
                difficulty: gameState.difficulty,
                gameMode: gameState.gameMode,
                timestamp: Date.now()
            };
            
            localStorage.setItem(`leaderboard_${currentUser.id}`, JSON.stringify(leaderboardData));
        }
        
        function clearCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const entities = canvas.querySelectorAll('.entity, .explosion-effect, .lightning-effect, .laser-effect, .particle-effect, .damage-number');
            entities.forEach(entity => entity.remove());
            
            // Reset states
            gameState.enemies = [];
            gameState.traps = [];
            gameState.powerups = [];
            gameState.projectiles = [];
            gameState.effects = [];
        }
        
        // ============================================
        // ENHANCED CANVAS INTERACTION
        // ============================================
        
        function setupCanvasEvents() {
            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('click', (e) => {
                if (!gameState.playing || gameState.paused) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const pathWidth = canvas.querySelector('.game-path').offsetWidth;
                
                // Don't allow building on the path
                if (x < pathWidth + 20) {
                    showNotification('❌ Cannot build on the path!', 'error');
                    return;
                }
                
                if (gameState.sellMode) {
                    sellTrapAt(x, y);
                } else if (gameState.upgradeMode) {
                    upgradeTrapAt(x, y);
                } else if (gameState.selectedTrap) {
                    buildTrap(x, y);
                }
            });
            
            // Enhanced range preview
            canvas.addEventListener('mousemove', (e) => {
                if (!gameState.selectedTrap || gameState.paused || !gameState.playing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                showEnhancedRangePreview(x, y);
            });
            
            canvas.addEventListener('mouseleave', hideRangePreview);
            
            // Touch support
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                canvas.dispatchEvent(new MouseEvent('click', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }));
            }, { passive: false });
        }
        
        function buildTrap(x, y) {
            const trapType = TRAP_TYPES[gameState.selectedTrap];
            
            // Check level requirement
            if (playerLevel < trapType.requiredLevel) {
                showNotification(`❌ Requires Level ${trapType.requiredLevel}!`, 'error');
                return;
            }
            
            // Check for overlapping traps
            const overlap = gameState.traps.some(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance < 60;
            });
            
            if (overlap) {
                showNotification('❌ Too close to another defense!', 'error');
                return;
            }
            
            if (gameState.pizzaBucks >= trapType.cost) {
                gameState.pizzaBucks -= trapType.cost;
                
                const trap = {
                    id: Date.now() + Math.random(),
                    type: gameState.selectedTrap,
                    x: x,
                    y: y,
                    damage: trapType.damage,
                    range: trapType.range,
                    cooldown: 0,
                    level: 1,
                    kills: 0,
                    tempSpeedBoost: 0,
                    tempDamageBoost: 0
                };
                
                gameState.traps.push(trap);
                createTrapElement(trap);
                
                gameState.selectedTrap = null;
                updateTrapButtons();
                showNotification(`🛡️ ${trapType.name} deployed!`, 'success');
                playSound('upgrade');
            }
        }
        
        function createTrapElement(trap) {
            const canvas = document.getElementById('gameCanvas');
            const trapType = TRAP_TYPES[trap.type];
            
            const element = document.createElement('div');
            element.className = 'entity trap gpu-accelerated';
            element.id = `trap_${trap.id}`;
            
            const size = 45;
            element.style.cssText = `
                left: ${trap.x - size/2}px;
                top: ${trap.y - size/2}px;
                width: ${size}px;
                height: ${size}px;
                background: ${trapType.color};
                z-index: 5;
                cursor: pointer;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 12px;
                font-size: 20px;
            `;
            
            // Create image element with fallback
            const img = document.createElement('img');
            img.src = trapType.asset;
            img.alt = trapType.name;
            img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: inherit;';
            img.onerror = function() {
                // Fallback to text if image fails to load
                this.style.display = 'none';
                element.textContent = '🛡️'; // Generic trap icon
            };
            
            element.appendChild(img);
            
            // Level indicator for upgraded traps
            if (trap.level > 1) {
                const levelIndicator = document.createElement('div');
                levelIndicator.className = 'absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full text-xs flex items-center justify-center text-white font-bold';
                levelIndicator.textContent = trap.level;
                element.style.position = 'relative';
                element.appendChild(levelIndicator);
            }
            
            // Enhanced range display
            if (userSettings.showTrapRanges) {
                element.addEventListener('mouseenter', () => showTrapRange(trap));
                element.addEventListener('mouseleave', hideTrapRange);
            }
            
            // Tooltip
            element.title = `${trapType.name}\nDamage: ${trap.damage}\nRange: ${trap.range}\nLevel: ${trap.level}`;
            
            canvas.appendChild(element);
        }
        
        function showEnhancedRangePreview(x, y) {
            if (!gameState.selectedTrap) return;
            
            hideRangePreview();
            
            const canvas = document.getElementById('gameCanvas');
            const trapType = TRAP_TYPES[gameState.selectedTrap];
            const rangeCircle = document.createElement('div');
            rangeCircle.id = 'rangePreview';
            rangeCircle.className = 'gpu-accelerated';
            rangeCircle.style.cssText = `
                position: absolute;
                left: ${x - trapType.range}px;
                top: ${y - trapType.range}px;
                width: ${trapType.range * 2}px;
                height: ${trapType.range * 2}px;
                border: 3px dashed rgba(124, 58, 237, 0.8);
                border-radius: 50%;
                z-index: 1;
                pointer-events: none;
                background: rgba(124, 58, 237, 0.1);
                animation: pulse-fast infinite;
            `;
            canvas.appendChild(rangeCircle);
        }
        
        function hideRangePreview() {
            const preview = document.getElementById('rangePreview');
            preview?.remove();
        }
        
        function showTrapRange(trap) {
            hideTrapRange();
            
            const canvas = document.getElementById('gameCanvas');
            const rangeCircle = document.createElement('div');
            rangeCircle.id = 'trapRange';
            rangeCircle.className = 'gpu-accelerated';
            rangeCircle.style.cssText = `
                position: absolute;
                left: ${trap.x - trap.range}px;
                top: ${trap.y - trap.range}px;
                width: ${trap.range * 2}px;
                height: ${trap.range * 2}px;
                border: 2px solid rgba(16, 185, 129, 0.8);
                border-radius: 50%;
                z-index: 1;
                pointer-events: none;
                background: rgba(16, 185, 129, 0.1);
            `;
            canvas.appendChild(rangeCircle);
        }
        
        function hideTrapRange() {
            const rangeCircle = document.getElementById('trapRange');
            rangeCircle?.remove();
        }
        
        function sellTrapAt(x, y) {
            const clickedTrap = gameState.traps.find(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance <= 30;
            });
            
            if (clickedTrap) {
                const trapType = TRAP_TYPES[clickedTrap.type];
                const sellPrice = Math.floor(trapType.cost * 0.75 * clickedTrap.level);
                
                gameState.pizzaBucks += sellPrice;
                gameState.traps = gameState.traps.filter(t => t.id !== clickedTrap.id);
                
                const element = document.getElementById(`trap_${clickedTrap.id}`);
                element?.remove();
                
                showNotification(`💰 Salvaged ${trapType.name} for $${sellPrice}!`, 'success');
                playSound('coin');
            }
        }
        
        function upgradeTrapAt(x, y) {
            const clickedTrap = gameState.traps.find(trap => {
                const distance = Math.sqrt(Math.pow(x - trap.x, 2) + Math.pow(y - trap.y, 2));
                return distance <= 30;
            });
            
            if (clickedTrap) {
                const trapType = TRAP_TYPES[clickedTrap.type];
                const upgradeCost = trapType.cost * clickedTrap.level;
                
                if (gameState.pizzaBucks >= upgradeCost && clickedTrap.level < 5) {
                    gameState.pizzaBucks -= upgradeCost;
                    clickedTrap.level++;
                    
                    // Enhanced upgrade bonuses
                    const levelMultiplier = 1 + (clickedTrap.level - 1) * 0.6;
                    clickedTrap.damage = Math.floor(trapType.damage * levelMultiplier);
                    clickedTrap.range = Math.floor(trapType.range * (1 + (clickedTrap.level - 1) * 0.25));
                    
                    // Recreate element with new stats
                    const oldElement = document.getElementById(`trap_${clickedTrap.id}`);
                    oldElement?.remove();
                    createTrapElement(clickedTrap);
                    
                    showNotification(`⬆️ ${trapType.name} upgraded to Level ${clickedTrap.level}!`, 'success');
                    playSound('upgrade');
                } else if (clickedTrap.level >= 5) {
                    showNotification('⚠️ Maximum upgrade level reached!', 'warning');
                } else {
                    showNotification('❌ Insufficient credits for upgrade!', 'error');
                }
            }
        }
        
        // ============================================
        // ENHANCED EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // Auth events
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('playAsGuestBtn').addEventListener('click', playAsGuest);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Form toggles
            document.getElementById('showSignupBtn').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            });
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            
            // Enhanced difficulty selection with proper event handling
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedDifficulty = btn.dataset.difficulty;
                    showNotification(`Threat level set to: ${selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1)}`, 'info', 2000);
                });
            });
            
            // Enhanced game mode selection with proper event handling
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedGameMode = btn.dataset.mode;
                    
                    const modeNames = {
                        classic: 'Classic Defense',
                        endless: 'Endless Survival',
                        boss_rush: 'Boss Elimination',
                        speed: 'Blitz Protocol'
                    };
                    showNotification(`Mission type: ${modeNames[selectedGameMode]}`, 'info', 2000);
                });
            });
            
            // Menu events
            document.getElementById('startGameBtn').addEventListener('click', initGame);
            document.getElementById('leaderboardBtn').addEventListener('click', () => {
                showScreen('leaderboardScreen');
                loadLeaderboard('score');
            });
            document.getElementById('profileBtn').addEventListener('click', () => {
                showScreen('profileScreen');
                loadProfile();
            });
            document.getElementById('settingsBtn').addEventListener('click', () => {
                showScreen('settingsScreen');
            });
            document.getElementById('dailyChallengeBtn').addEventListener('click', () => {
                showScreen('dailyChallengeScreen');
                loadDailyChallenge();
            });
            
            // Back buttons
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                gameState.playing = false;
                if (gameLoop) clearInterval(gameLoop);
                showMainMenu();
            });
            document.getElementById('backFromLeaderboardBtn').addEventListener('click', () => showMainMenu());
            document.getElementById('backFromProfileBtn').addEventListener('click', () => showMainMenu());
            document.getElementById('backFromSettingsBtn').addEventListener('click', () => showMainMenu());
            document.getElementById('backFromChallengeBtn').addEventListener('click', () => showMainMenu());
            
            // Delete data functionality
            document.getElementById('deleteDataBtn').addEventListener('click', () => {
                document.getElementById('deleteConfirmModal').classList.remove('hidden');
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                deleteAllUserData();
                document.getElementById('deleteConfirmModal').classList.add('hidden');
            });
            
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteConfirmModal').classList.add('hidden');
            });
            
            // Game control events
            document.getElementById('pauseGameBtn').addEventListener('click', pauseGame);
            document.getElementById('speedBtn').addEventListener('click', () => {
                gameState.gameSpeed = gameState.gameSpeed >= 4 ? 1 : gameState.gameSpeed + 1;
            });
            
            // Enhanced game actions with improved feedback
            document.getElementById('sellModeBtn').addEventListener('click', () => {
                gameState.sellMode = !gameState.sellMode;
                gameState.selectedTrap = null;
                gameState.upgradeMode = false;
                const btn = document.getElementById('sellModeBtn');
                
                if (gameState.sellMode) {
                    btn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>🔨</span><span>Build Mode</span></span>';
                    btn.className = 'w-full bg-yellow-500/20 hover:bg-yellow-500/30 py-3 rounded-lg transition-colors font-semibold text-sm';
                    showNotification('💰 Salvage mode: Click defenses to sell', 'info');
                } else {
                    btn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>💰</span><span>Salvage Mode</span></span>';
                    btn.className = 'w-full bg-red-500/20 hover:bg-red-500/30 py-3 rounded-lg transition-colors font-semibold text-sm';
                    showNotification('🔨 Build mode activated', 'info');
                }
                
                updateTrapButtons();
            });
            
            document.getElementById('upgradeMode').addEventListener('click', () => {
                gameState.upgradeMode = !gameState.upgradeMode;
                gameState.selectedTrap = null;
                gameState.sellMode = false;
                const btn = document.getElementById('upgradeMode');
                
                if (gameState.upgradeMode) {
                    btn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>🔨</span><span>Build Mode</span></span>';
                    btn.className = 'w-full bg-yellow-500/20 hover:bg-yellow-500/30 py-3 rounded-lg transition-colors font-semibold text-sm';
                    showNotification('⬆️ Upgrade mode: Click defenses to upgrade', 'info');
                } else {
                    btn.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>⬆️</span><span>Upgrade Mode</span></span>';
                    btn.className = 'w-full bg-green-500/20 hover:bg-green-500/30 py-3 rounded-lg transition-colors font-semibold text-sm';
                    showNotification('🔨 Build mode activated', 'info');
                }
                
                updateTrapButtons();
            });
            
            document.getElementById('clearAllBtn').addEventListener('click', () => {
                if (gameState.traps.length === 0) {
                    showNotification('⚠️ No defenses to clear!', 'warning');
                    return;
                }
                
                showCustomDialog(
                    '⚠️ Confirm Emergency Clear',
                    'This will salvage ALL deployed defenses. Continue?',
                    'Clear All',
                    () => {
                        const totalRefund = gameState.traps.reduce((sum, trap) => {
                            const trapType = TRAP_TYPES[trap.type];
                            return sum + Math.floor(trapType.cost * 0.75 * trap.level);
                        }, 0);
                        
                        gameState.pizzaBucks += totalRefund;
                        gameState.traps = [];
                        
                        const canvas = document.getElementById('gameCanvas');
                        canvas.querySelectorAll('.trap').forEach(trap => trap.remove());
                        
                        showNotification(`🗑️ Emergency clear complete! Salvaged $${totalRefund}`, 'success');
                        playSound('coin');
                    }
                );
            });
            
            // Enhanced power-up buttons
            document.getElementById('airstrikeBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 75) {
                    gameState.pizzaBucks -= 75;
                    gameState.enemies.forEach(enemy => {
                        enemy.health -= 150;
                        createEnhancedExplosionEffect(enemy.x, enemy.y, 'epic');
                    });
                    showNotification('💥 Orbital strike deployed!', 'success');
                    createScreenShake();
                    playSound('explosion');
                } else {
                    showNotification('❌ Insufficient credits!', 'error');
                }
            });
            
            document.getElementById('freezeBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 50) {
                    gameState.pizzaBucks -= 50;
                    gameState.enemies.forEach(enemy => {
                        enemy.effects.freeze = 300; // 5 seconds
                    });
                    showNotification('❄️ Cryo blast activated!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('❌ Insufficient credits!', 'error');
                }
            });
            
            document.getElementById('repairBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 60) {
                    gameState.pizzaBucks -= 60;
                    gameState.lives = Math.min(gameState.lives + 2, 12);
                    showNotification('🔧 Nano repair complete! Lives restored!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('❌ Insufficient credits!', 'error');
                }
            });
            
            document.getElementById('boostBtn').addEventListener('click', () => {
                if (gameState.pizzaBucks >= 45) {
                    gameState.pizzaBucks -= 45;
                    gameState.traps.forEach(trap => {
                        trap.tempSpeedBoost = 450; // 7.5 seconds
                        trap.tempDamageBoost = 450;
                    });
                    showNotification('🚀 Overcharge activated!', 'success');
                    playSound('upgrade');
                } else {
                    showNotification('❌ Insufficient credits!', 'error');
                }
            });
            
            // Modal events
            document.getElementById('resumeBtn').addEventListener('click', pauseGame);
            document.getElementById('restartBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('quitBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                gameState.playing = false;
                if (gameLoop) clearInterval(gameLoop);
                showMainMenu();
            });
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                showMainMenu();
            });
            document.getElementById('levelUpContinueBtn').addEventListener('click', () => {
                document.getElementById('levelUpModal').classList.add('hidden');
                setupEnhancedTrapShop(); // Refresh trap shop with new unlocks
            });
            
            // Enhanced keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Enter key handling for forms
                if (e.key === 'Enter') {
                    const activeScreen = document.querySelector('.screen.active');
                    if (activeScreen && activeScreen.id === 'authScreen') {
                        const visibleForm = document.querySelector('#authScreen .glass div:not(.hidden)');
                        if (visibleForm?.id === 'loginForm') {
                            handleLogin();
                        } else if (visibleForm?.id === 'signupForm') {
                            handleSignup();
                        }
                    }
                }
                
                // Game controls
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen && activeScreen.id === 'gameScreen' && gameState.playing) {
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            pauseGame();
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                            gameState.gameSpeed = parseInt(e.key);
                            break;
                        case 'Escape':
                            gameState.selectedTrap = null;
                            gameState.sellMode = false;
                            gameState.upgradeMode = false;
                            updateTrapButtons();
                            showNotification('🔨 Selection cleared', 'info');
                            break;
                        case 's':
                        case 'S':
                            document.getElementById('sellModeBtn').click();
                            break;
                        case 'u':
                        case 'U':
                            document.getElementById('upgradeMode').click();
                            break;
                    }
                }
            });
            
            // Setup additional modules
            setupLeaderboardEvents();
            setupSettingsEvents();
            
            // Window resize handler
            window.addEventListener('resize', handleResize);
            
            // Handle visibility change for performance
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && gameState.playing && !gameState.paused) {
                    pauseGame();
                    showNotification('⏸️ Game paused due to tab switch', 'info');
                }
            });
        }
        
        // Enhanced custom dialog function
        function showCustomDialog(title, message, confirmText, onConfirm, cancelText = 'Cancel') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-strong rounded-2xl p-6 max-w-sm w-full mx-4 animate-zoom-in">
                    <h3 class="text-xl font-bold text-center mb-4">${title}</h3>
                    <p class="text-gray-300 text-center mb-6">${message}</p>
                    <div class="flex space-x-3">
                        <button class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition-all" onclick="this.closest('.fixed').remove()">${cancelText}</button>
                        <button class="flex-1 bg-red-500 hover:bg-red-600 py-3 rounded-lg font-semibold transition-all" onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()">${confirmText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Delete all user data function
        function deleteAllUserData() {
            if (!currentUser) return;
            
            // Delete all localStorage data for this user
            const keysToDelete = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes(currentUser.id)) {
                    keysToDelete.push(key);
                }
            }
            
            keysToDelete.forEach(key => localStorage.removeItem(key));
            
            // Reset player progress
            playerLevel = 1;
            playerXP = 0;
            totalScore = 0;
            
            // If using Supabase, delete from there too
            if (supabase && currentUser.id !== 'guest') {
                supabase.from('user_statistics').delete().eq('user_id', currentUser.id);
                supabase.from('game_sessions').delete().eq('user_id', currentUser.id);
                supabase.from('leaderboards').delete().eq('user_id', currentUser.id);
            }
            
            showNotification('🗑️ All data deleted successfully!', 'success');
            
            // Log out the user
            setTimeout(() => {
                handleLogout();
            }, 2000);
        }
        
        // Authentication functions with enhanced feedback
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showNotification('❌ Please complete all fields', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    loadPlayerProgress();
                    showNotification('✅ Access granted! Welcome back, Commander!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('❌ Access denied: ' + error.message, 'error');
                }
            } else {
                currentUser = { 
                    id: 'user_' + Date.now(), 
                    email: email, 
                    user_metadata: { username: email.split('@')[0] } 
                };
                loadPlayerProgress();
                showNotification('✅ Demo access granted!', 'success');
                showMainMenu();
            }
        }
        
        async function handleSignup() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            
            if (!username || !email || !password) {
                showNotification('❌ Please complete all fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('❌ Password must be at least 6 characters', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: { data: { username } }
                    });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    loadPlayerProgress();
                    showNotification('✅ Commander registered successfully!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('❌ Registration failed: ' + error.message, 'error');
                }
            } else {
                currentUser = { 
                    id: 'user_' + Date.now(), 
                    email: email, 
                    user_metadata: { username: username } 
                };
                loadPlayerProgress();
                showNotification('✅ Demo account created!', 'success');
                showMainMenu();
            }
        }
        
        function playAsGuest() {
            currentUser = { 
                id: 'guest_' + Date.now(), 
                email: 'guest@hq.com', 
                user_metadata: { username: 'Guest Commander' } 
            };
            
            loadPlayerProgress();
            showNotification('🎮 Emergency access granted!', 'success');
            showMainMenu();
        }
        
        async function handleLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            playerLevel = 1;
            playerXP = 0;
            totalScore = 0;
            showNotification('🚪 Session terminated', 'info');
            showScreen('authScreen');
        }
        
        function showMainMenu() {
            if (!currentUser) {
                showScreen('authScreen');
                return;
            }
            
            const username = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Commander';
            document.getElementById('userInfo').textContent = `Welcome back, ${username}!`;
            updatePlayerLevel();
            showScreen('menuScreen');
        }
        
        // Enhanced settings functions
        function loadSettings() {
            const saved = localStorage.getItem('gameSettings');
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) };
            }
            updateSettingsUI();
        }
        
        function saveSettings() {
            localStorage.setItem('gameSettings', JSON.stringify(userSettings));
            showNotification('💾 Configuration saved successfully!', 'success');
            
            // Apply immediate effects
            document.getElementById('fpsCounter').classList.toggle('hidden', !userSettings.showFPS);
        }
        
        function updateSettingsUI() {
            // Update toggles
            document.getElementById('autoPauseToggle').classList.toggle('active', userSettings.autoPause);
            document.getElementById('damageNumbersToggle').classList.toggle('active', userSettings.showDamageNumbers);
            document.getElementById('trapRangesToggle').classList.toggle('active', userSettings.showTrapRanges);
            document.getElementById('soundEffectsToggle').classList.toggle('active', userSettings.soundEffects);
            document.getElementById('backgroundMusicToggle').classList.toggle('active', userSettings.backgroundMusic);
            document.getElementById('particleEffectsToggle').classList.toggle('active', userSettings.particleEffects);
            document.getElementById('screenShakeToggle').classList.toggle('active', userSettings.screenShake);
            document.getElementById('animationQualityToggle').classList.toggle('active', userSettings.animationQuality);
            document.getElementById('fpsToggle').classList.toggle('active', userSettings.showFPS);
            
            // Update selects and sliders
            document.getElementById('defaultSpeedSelect').value = userSettings.defaultSpeed;
            document.getElementById('graphicsQualitySelect').value = userSettings.graphicsQuality;
            document.getElementById('masterVolumeSlider').value = userSettings.masterVolume;
            document.getElementById('volumeDisplay').textContent = `${userSettings.masterVolume}%`;
            
            // Apply FPS display setting
            document.getElementById('fpsCounter').classList.toggle('hidden', !userSettings.showFPS);
        }
        
        function setupSettingsEvents() {
            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    
                    const settingMap = {
                        'autoPauseToggle': 'autoPause',
                        'damageNumbersToggle': 'showDamageNumbers',
                        'trapRangesToggle': 'showTrapRanges',
                        'soundEffectsToggle': 'soundEffects',
                        'backgroundMusicToggle': 'backgroundMusic',
                        'particleEffectsToggle': 'particleEffects',
                        'screenShakeToggle': 'screenShake',
                        'animationQualityToggle': 'animationQuality',
                        'fpsToggle': 'showFPS'
                    };
                    
                    const setting = settingMap[toggle.id];
                    if (setting) {
                        userSettings[setting] = toggle.classList.contains('active');
                    }
                });
            });
            
            // Select dropdowns
            document.getElementById('defaultSpeedSelect').addEventListener('change', (e) => {
                userSettings.defaultSpeed = parseInt(e.target.value);
            });
            
            document.getElementById('graphicsQualitySelect').addEventListener('change', (e) => {
                userSettings.graphicsQuality = e.target.value;
            });
            
            // Volume slider
            const volumeSlider = document.getElementById('masterVolumeSlider');
            const volumeDisplay = document.getElementById('volumeDisplay');
            
            volumeSlider.addEventListener('input', (e) => {
                userSettings.masterVolume = parseInt(e.target.value);
                volumeDisplay.textContent = `${userSettings.masterVolume}%`;
            });
            
            // Save button
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        }
        
        // Enhanced leaderboard functions
        async function loadLeaderboard(type = 'score') {
            const loadingEl = document.getElementById('leaderboardLoading');
            const contentEl = document.getElementById('leaderboardContent');
            const errorEl = document.getElementById('leaderboardError');
            
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            try {
                let data = [];
                
                if (supabase) {
                    const { data: leaderboardData, error } = await supabase
                        .from('leaderboards')
                        .select('*')
                        .eq('leaderboard_type', type)
                        .order('rank')
                        .limit(50);
                    
                    if (error) throw error;
                    data = leaderboardData || [];
                } else {
                    data = generateEnhancedDemoLeaderboard(type);
                }
                
                displayLeaderboard(data, type);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        function generateEnhancedDemoLeaderboard(type) {
            const names = [
                'PizzaDestroyer', 'VampireSlayer', 'GarlicMaster', 'DefenseKing', 'TrapLord', 
                'PizzaHunter', 'GhostBuster', 'TowerMaster', 'FlameGuard', 'ShadowWard',
                'EliteCommander', 'VoidMaster', 'CyberDefender', 'PlasmaKnight', 'QuantumGuard'
            ];
            
            return names.map((username, index) => ({
                rank: index + 1,
                username,
                value: type === 'score' ? Math.floor(Math.random() * 2000000) + 100000 :
                       type === 'waves' ? Math.floor(Math.random() * 100) + 20 :
                       Math.floor(Math.random() * 10000) + 1000,
                secondary_value: Math.floor(Math.random() * 200) + 50,
                game_mode: ['Classic', 'Endless', 'Boss Rush', 'Blitz'][Math.floor(Math.random() * 4)],
                difficulty: ['Recruit', 'Soldier', 'Veteran', 'Elite'][Math.floor(Math.random() * 4)]
            })).sort((a, b) => b.value - a.value).map((item, index) => ({ ...item, rank: index + 1 }));
        }
        
        function displayLeaderboard(data, type) {
            const loadingEl = document.getElementById('leaderboardLoading');
            const contentEl = document.getElementById('leaderboardContent');
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
            const typeLabels = {
                score: { main: 'Score', secondary: 'Wave' },
                waves: { main: 'Wave', secondary: 'Score' },
                kills: { main: 'Kills', secondary: 'Games' },
                achievements: { main: 'Achievements', secondary: 'Points' }
            };
            
            contentEl.innerHTML = data.map(player => `
                <div class="leaderboard-item rounded-lg p-4 flex items-center justify-between hover:bg-white/10 transition-all">
                    <div class="flex items-center space-x-4">
                        <div class="rank-medal ${getRankClass(player.rank)} flex-shrink-0">
                            ${player.rank}
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-xl font-bold flex-shrink-0">
                            👤
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-lg truncate">${player.username}</div>
                            <div class="text-sm text-gray-400">${typeLabels[type].secondary}: ${player.secondary_value.toLocaleString()}</div>
                            <div class="text-xs">
                                ${player.game_mode ? `<span class="text-blue-400">${player.game_mode}</span>` : ''}
                                ${player.difficulty ? `<span class="text-orange-400 ml-2">${player.difficulty}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="text-2xl font-bold text-primary">${player.value.toLocaleString()}</div>
                        <div class="text-sm text-gray-400">${typeLabels[type].main}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }
        
        function setupLeaderboardEvents() {
            document.getElementById('scoreLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('scoreLeaderboard');
                loadLeaderboard('score');
            });
            
            document.getElementById('waveLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('waveLeaderboard');
                loadLeaderboard('waves');
            });
            
            document.getElementById('killsLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('killsLeaderboard');
                loadLeaderboard('kills');
            });
            
            document.getElementById('achievementLeaderboard').addEventListener('click', () => {
                setActiveLeaderboardTab('achievementLeaderboard');
                loadLeaderboard('achievements');
            });
            
            document.getElementById('retryLeaderboard').addEventListener('click', () => {
                loadLeaderboard('score');
            });
        }
        
        function setActiveLeaderboardTab(activeId) {
            ['scoreLeaderboard', 'waveLeaderboard', 'killsLeaderboard', 'achievementLeaderboard'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.className = 'px-4 py-2 rounded-lg btn-primary text-sm';
                } else {
                    btn.className = 'px-4 py-2 rounded-lg hover:bg-white/10 transition-colors text-sm';
                }
            });
        }
        
        // Enhanced profile functions
        async function loadProfile() {
            if (!currentUser) return;
            
            const username = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Commander';
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileEmail').textContent = currentUser.email || 'guest@hq.com';
            document.getElementById('profileLevel').textContent = `Level ${playerLevel}`;
            
            if (supabase && currentUser.id !== 'guest') {
                try {
                    const { data: stats } = await supabase
                        .from('user_statistics')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (stats) {
                        updateProfileStats(stats);
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            } else {
                const savedStats = JSON.parse(localStorage.getItem(`userStats_${currentUser.id}`) || '{}');
                updateProfileStats(savedStats);
            }
            
            loadAchievements();
            
            const joinDate = currentUser.created_at ? 
                new Date(currentUser.created_at).toLocaleDateString() : 
                new Date().toLocaleDateString();
            document.getElementById('profileJoinDate').textContent = `Enlisted: ${joinDate}`;
            
            const rankInfo = getRankInfo(playerLevel);
            document.getElementById('profileRank').textContent = `Rank: ${rankInfo.name}`;
        }
        
        function updateProfileStats(stats) {
            document.getElementById('profileHighScore').textContent = (stats.highScore || stats.highest_score || 0).toLocaleString();
            document.getElementById('profileMaxWave').textContent = (stats.maxWave || stats.highest_wave || 0);
            document.getElementById('profileTotalKills').textContent = (stats.totalKills || stats.total_enemies_killed || 0).toLocaleString();
            document.getElementById('profileGamesPlayed').textContent = (stats.gamesPlayed || stats.total_games_played || 0);
            
            const winRate = stats.gamesPlayed > 0 ? Math.round(((stats.wins || 0) / stats.gamesPlayed) * 100) : 0;
            document.getElementById('profileWinRate').textContent = `${winRate}%`;
            
            const playTimeHours = Math.floor((stats.playTime || 0) / 3600);
            document.getElementById('profilePlayTime').textContent = `${playTimeHours}h`;
        }
        
        function loadAchievements() {
            const achievements = Object.entries(ACHIEVEMENTS).map(([key, achievement]) => {
                const isUnlocked = JSON.parse(localStorage.getItem(`achievement_${currentUser.id}_${key}`) || 'false');
                return {
                    ...achievement,
                    unlocked: isUnlocked,
                    key: key
                };
            });
            
            const container = document.getElementById('achievementsList');
            container.innerHTML = achievements.map(achievement => `
                <div class="achievement-badge ${achievement.unlocked ? '' : 'locked'} rounded-lg p-3 flex items-center space-x-3 transition-all hover:scale-105">
                    <div class="text-2xl flex-shrink-0">${achievement.unlocked ? achievement.icon : '🔒'}</div>
                    <div class="min-w-0">
                        <div class="font-bold ${achievement.unlocked ? 'text-white' : 'text-gray-500'}">${achievement.name}</div>
                        <div class="text-sm text-gray-400">${achievement.description}</div>
                        ${achievement.unlocked ? 
                            `<div class="text-xs text-green-400">+${achievement.xpReward} XP</div>` : 
                            `<div class="text-xs text-gray-500">Locked</div>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        // Enhanced Daily Challenge functions
        function loadDailyChallenge() {
            // Generate daily challenge based on current date
            const today = new Date().toDateString();
            const savedChallenge = localStorage.getItem(`dailyChallenge_${today}`);
            
            let challenge;
            if (savedChallenge) {
                challenge = JSON.parse(savedChallenge);
            } else {
                challenge = generateDailyChallenge();
                localStorage.setItem(`dailyChallenge_${today}`, JSON.stringify(challenge));
            }
            
            document.getElementById('challengeTitle').textContent = challenge.title;
            document.getElementById('challengeDescription').textContent = challenge.description;
            document.getElementById('challengeProgress').textContent = `${challenge.progress}/${challenge.target}`;
            
            document.getElementById('startChallengeBtn').addEventListener('click', () => {
                // Set up special challenge mode
                selectedGameMode = 'challenge';
                selectedDifficulty = challenge.difficulty;
                initGame();
            });
        }
        
        function generateDailyChallenge() {
            const challenges = [
                {
                    title: 'Elite Elimination Protocol',
                    description: 'Eliminate 100 enemies using only basic traps',
                    target: 100,
                    progress: 0,
                    difficulty: 'intermediate',
                    reward: 500
                },
                {
                    title: 'Speed Demon',
                    description: 'Complete 15 waves in under 8 minutes',
                    target: 15,
                    progress: 0,
                    difficulty: 'advanced',
                    reward: 750
                },
                {
                    title: 'Perfect Defense',
                    description: 'Complete Classic mode without losing a life',
                    target: 1,
                    progress: 0,
                    difficulty: 'expert',
                    reward: 1000
                },
                {
                    title: 'Economic Warfare',
                    description: 'Win with spending less than 500 credits',
                    target: 1,
                    progress: 0,
                    difficulty: 'advanced',
                    reward: 800
                },
                {
                    title: 'Combo Master',
                    description: 'Achieve a 50x combo multiplier',
                    target: 50,
                    progress: 0,
                    difficulty: 'intermediate',
                    reward: 600
                },
                {
                    title: 'Boss Hunter',
                    description: 'Defeat 5 boss enemies in Boss Rush mode',
                    target: 5,
                    progress: 0,
                    difficulty: 'expert',
                    reward: 1200
                },
                {
                    title: 'Arsenal Master',
                    description: 'Use every type of trap in a single game',
                    target: 10,
                    progress: 0,
                    difficulty: 'intermediate',
                    reward: 700
                }
            ];
            
            const today = new Date();
            const challengeIndex = today.getDate() % challenges.length;
            return challenges[challengeIndex];
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupEventListeners();
            setupCanvasEvents();
            updateCanvasSize();
            showScreen('authScreen');
            
            // Auto-login check for Supabase
            if (supabase) {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        currentUser = session.user;
                        loadPlayerProgress();
                        showMainMenu();
                    }
                });
            }
            
            // Enhanced dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Performance monitoring
            if (userSettings.showFPS) {
                lastTime = performance.now();
            }
            
            // Preload critical elements
            setTimeout(() => {
                updateCanvasSize();
            }, 100);
        });
    </script>
</body>
</html>
