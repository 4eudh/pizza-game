<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack of the Vampire Pizzas!</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        'creepster': ['Creepster', 'cursive'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        
        .game-title {
            font-family: 'Creepster', cursive;
            background: linear-gradient(45deg, #7C3AED, #EC4899, #F59E0B);
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.5));
        }
        
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #7C3AED, #EC4899);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
        }
        
        .game-canvas {
            background: #1a1a2e;
            border: 3px solid #7C3AED;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.3);
        }
        
        .enemy, .trap {
            position: absolute;
            transition: all 0.2s ease;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .health-bar {
            position: absolute;
            top: -8px;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 2px;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #EF4444, #10B981);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .path {
            background: linear-gradient(90deg, #8B4513, #A0522D);
            border-radius: 4px;
        }
        
        .notification {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .trap-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .trap-btn:hover {
            border-color: #7C3AED;
            transform: scale(1.05);
        }
        
        .trap-btn.selected {
            border-color: #F59E0B;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        
        .trap-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-white">
    <!-- Authentication Screen -->
    <div id="authScreen" class="screen active min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="game-title text-5xl mb-4">Vampire Pizzas!</h1>
                <p class="text-gray-300">Defend your pizzeria from the undead!</p>
            </div>
            
            <div class="glass rounded-2xl p-8">
                <!-- Login Form -->
                <div id="loginForm">
                    <h2 class="text-2xl font-bold text-center mb-6">Welcome Back</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="loginEmail" 
                                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-base focus:border-primary focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="loginPassword" 
                                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-base focus:border-primary focus:outline-none">
                        </div>
                        <button id="loginBtn" class="w-full btn-primary py-3 rounded-lg font-semibold">
                            Sign In
                        </button>
                        <div class="text-center space-y-2">
                            <button id="showSignupBtn" class="text-primary hover:text-secondary transition-colors">
                                Don't have an account? Sign up
                            </button>
                            <br>
                            <button id="playAsGuestBtn" class="text-gray-400 hover:text-white transition-colors">
                                Play as Guest
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="signupForm" class="hidden">
                    <h2 class="text-2xl font-bold text-center mb-6">Create Account</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Username</label>
                            <input type="text" id="signupUsername" 
                                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-base focus:border-primary focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="signupEmail" 
                                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-base focus:border-primary focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="signupPassword" 
                                   class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-base focus:border-primary focus:outline-none">
                        </div>
                        <button id="signupBtn" class="w-full btn-primary py-3 rounded-lg font-semibold">
                            Create Account
                        </button>
                        <div class="text-center">
                            <button id="showLoginBtn" class="text-primary hover:text-secondary transition-colors">
                                Already have an account? Sign in
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Menu -->
    <div id="menuScreen" class="screen min-h-screen flex items-center justify-center p-6">
        <div class="text-center">
            <h1 class="game-title text-6xl mb-8">Vampire Pizzas!</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl">
                <button id="startGameBtn" class="glass rounded-2xl p-8 btn-primary hover:scale-105 transition-transform">
                    <div class="text-4xl mb-4">üéÆ</div>
                    <h3 class="text-xl font-bold mb-2">Start Game</h3>
                    <p class="text-gray-300">Begin your defense!</p>
                </button>
                
                <button id="leaderboardBtn" class="glass rounded-2xl p-8 hover:bg-white/10 hover:scale-105 transition-all">
                    <div class="text-4xl mb-4">üèÜ</div>
                    <h3 class="text-xl font-bold mb-2">Leaderboard</h3>
                    <p class="text-gray-300">View top players</p>
                </button>
                
                <button id="profileBtn" class="glass rounded-2xl p-8 hover:bg-white/10 hover:scale-105 transition-all">
                    <div class="text-4xl mb-4">üë§</div>
                    <h3 class="text-xl font-bold mb-2">Profile</h3>
                    <p class="text-gray-300">View your stats</p>
                </button>
                
                <button id="logoutBtn" class="glass rounded-2xl p-8 hover:bg-red-500/20 hover:scale-105 transition-all">
                    <div class="text-4xl mb-4">üö™</div>
                    <h3 class="text-xl font-bold mb-2">Logout</h3>
                    <p class="text-gray-300">Sign out</p>
                </button>
            </div>
            
            <div id="userInfo" class="mt-8 text-lg"></div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen" class="screen min-h-screen p-4">
        <div class="flex flex-col lg:flex-row gap-4 h-full">
            <!-- Main Game Area -->
            <div class="flex-1">
                <!-- Top Bar -->
                <div class="glass rounded-xl p-4 mb-4 flex items-center justify-between">
                    <button id="backToMenuBtn" class="btn-primary px-4 py-2 rounded-lg">‚Üê Menu</button>
                    <h2 class="game-title text-2xl">Wave <span id="currentWave">1</span></h2>
                    <div class="flex gap-2">
                        <button id="pauseGameBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg">‚è∏Ô∏è</button>
                        <button id="speedBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg">1x</button>
                    </div>
                </div>
                
                <!-- Stats Bar -->
                <div class="glass rounded-xl p-4 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="pizzaBucks">30</div>
                            <div class="text-sm text-gray-400">Pizza Bucks</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-400" id="lives">3</div>
                            <div class="text-sm text-gray-400">Lives</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-400" id="kills">0</div>
                            <div class="text-sm text-gray-400">Kills</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-400" id="score">0</div>
                            <div class="text-sm text-gray-400">Score</div>
                        </div>
                        <div class="stat-card rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="enemiesLeft">0</div>
                            <div class="text-sm text-gray-400">Enemies</div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Canvas -->
                <div id="gameCanvas" class="game-canvas w-full aspect-video relative">
                    <!-- Game entities will be added here -->
                </div>
            </div>
            
            <!-- Side Panel -->
            <div class="w-full lg:w-80 space-y-4">
                <!-- Trap Shop -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center">Trap Shop</h3>
                    <div class="grid grid-cols-2 gap-3" id="trapShop">
                        <!-- Trap buttons will be populated here -->
                    </div>
                </div>
                
                <!-- Wave Progress -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center">Wave Progress</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>Next Wave:</span>
                            <span id="waveTimer" class="text-blue-400">30s</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="waveProgress" class="bg-blue-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-bold mb-4 text-center">Actions</h3>
                    <div class="space-y-2">
                        <button id="sellModeBtn" class="w-full bg-red-500/20 hover:bg-red-500/30 py-2 rounded-lg transition-colors">
                            üí∞ Sell Mode
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="pauseModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">Game Paused</h2>
            <div class="space-y-4">
                <button id="resumeBtn" class="w-full btn-primary py-3 rounded-lg">Resume</button>
                <button id="restartBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 py-3 rounded-lg">Restart</button>
                <button id="quitBtn" class="w-full bg-red-500 hover:bg-red-600 py-3 rounded-lg">Quit to Menu</button>
            </div>
        </div>
    </div>
    
    <div id="gameOverModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
            <h2 id="gameOverTitle" class="text-2xl font-bold text-center mb-6">Game Over!</h2>
            <div id="finalStats" class="text-center mb-6">
                <!-- Stats will be populated here -->
            </div>
            <div class="space-y-4">
                <button id="playAgainBtn" class="w-full btn-primary py-3 rounded-lg">Play Again</button>
                <button id="menuBtn" class="w-full bg-gray-500 hover:bg-gray-600 py-3 rounded-lg">Main Menu</button>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        
        // REPLACE THESE WITH YOUR ACTUAL SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://tzbgavzhciqclgmcmoqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YmdhdnpoY2lxY2xnbWNtb3F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzMwNzYsImV4cCI6MjA2ODc0OTA3Nn0.gwjUMYjSLtiI5u5sBTZpg1S9OqVBhKvTZWttuOYPiek';
        
        // Initialize Supabase client
        let supabase = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.log('Supabase not configured, using local storage');
        }
        
        // ============================================
        // GAME STATE
        // ============================================
        
        let currentUser = null;
        let gameState = {
            playing: false,
            paused: false,
            wave: 1,
            pizzaBucks: 30,
            lives: 3,
            score: 0,
            kills: 0,
            selectedTrap: null,
            sellMode: false,
            gameSpeed: 1,
            waveTimer: 30,
            enemies: [],
            traps: [],
            frameCount: 0
        };
        
        // Game configuration
        const CONFIG = {
            WAVE_DURATION: 30, // seconds
            SPAWN_RATE: 2, // seconds between spawns
            CANVAS_WIDTH: 800,
            CANVAS_HEIGHT: 450,
            TILE_SIZE: 50
        };
        
        // Asset definitions with placeholders
        const ENEMY_TYPES = {
            basic: { name: 'Basic Pizza', health: 100, speed: 1, reward: 10, color: '#8B4513' },
            fast: { name: 'Fast Pizza', health: 60, speed: 2, reward: 15, color: '#FF4500' },
            tank: { name: 'Tank Pizza', health: 200, speed: 0.5, reward: 25, color: '#2F4F4F' }
        };
        
        const TRAP_TYPES = {
            garlic: { name: 'Garlic Trap', cost: 15, damage: 20, range: 100, color: '#FFFACD', icon: 'üßÑ' },
            cutter: { name: 'Pizza Cutter', cost: 25, damage: 35, range: 80, color: '#C0C0C0', icon: 'üî™' },
            holy_water: { name: 'Holy Water', cost: 40, damage: 50, range: 120, color: '#87CEEB', icon: 'üíß' }
        };
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    showNotification('Logged in successfully!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('Login failed: ' + error.message, 'error');
                }
            } else {
                // Fallback for demo
                currentUser = { id: 'demo', email: email };
                showNotification('Logged in (demo mode)', 'success');
                showMainMenu();
            }
        }
        
        async function handleSignup() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!username || !email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: { data: { username } }
                    });
                    if (error) throw error;
                    
                    currentUser = data.user;
                    showNotification('Account created successfully!', 'success');
                    showMainMenu();
                } catch (error) {
                    showNotification('Signup failed: ' + error.message, 'error');
                }
            } else {
                // Fallback for demo
                currentUser = { id: 'demo', email: email, user_metadata: { username } };
                showNotification('Account created (demo mode)', 'success');
                showMainMenu();
            }
        }
        
        function playAsGuest() {
            currentUser = { id: 'guest', email: 'guest@example.com', user_metadata: { username: 'Guest' } };
            showNotification('Playing as guest', 'info');
            showMainMenu();
        }
        
        async function handleLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            showScreen('authScreen');
            showNotification('Logged out successfully', 'info');
        }
        
        // ============================================
        // SCREEN MANAGEMENT
        // ============================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function showMainMenu() {
            const username = currentUser?.user_metadata?.username || currentUser?.email?.split('@')[0] || 'Player';
            document.getElementById('userInfo').textContent = `Welcome, ${username}!`;
            showScreen('menuScreen');
        }
        
        // ============================================
        // GAME LOGIC
        // ============================================
        
        function initGame() {
            gameState = {
                playing: true,
                paused: false,
                wave: 1,
                pizzaBucks: 30,
                lives: 3,
                score: 0,
                kills: 0,
                selectedTrap: null,
                sellMode: false,
                gameSpeed: 1,
                waveTimer: 30,
                enemies: [],
                traps: [],
                frameCount: 0
            };
            
            setupTrapShop();
            updateUI();
            showScreen('gameScreen');
            startGameLoop();
        }
        
        function setupTrapShop() {
            const trapShop = document.getElementById('trapShop');
            trapShop.innerHTML = '';
            
            Object.entries(TRAP_TYPES).forEach(([key, trap]) => {
                const button = document.createElement('button');
                button.className = 'trap-btn rounded-lg p-3 text-center';
                button.innerHTML = `
                    <div class="text-2xl mb-1">${trap.icon}</div>
                    <div class="text-sm font-bold">${trap.name}</div>
                    <div class="text-xs text-yellow-400">$${trap.cost}</div>
                `;
                button.addEventListener('click', () => selectTrap(key));
                button.id = `trap_${key}`;
                trapShop.appendChild(button);
            });
        }
        
        function selectTrap(trapType) {
            const trap = TRAP_TYPES[trapType];
            if (gameState.pizzaBucks >= trap.cost) {
                gameState.selectedTrap = trapType;
                gameState.sellMode = false;
                updateTrapButtons();
                showNotification(`Selected ${trap.name}`, 'info');
            } else {
                showNotification('Not enough Pizza Bucks!', 'error');
            }
        }
        
        function updateTrapButtons() {
            Object.keys(TRAP_TYPES).forEach(key => {
                const button = document.getElementById(`trap_${key}`);
                const trap = TRAP_TYPES[key];
                
                button.classList.remove('selected', 'disabled');
                
                if (gameState.selectedTrap === key) {
                    button.classList.add('selected');
                }
                
                if (gameState.pizzaBucks < trap.cost) {
                    button.classList.add('disabled');
                }
            });
        }
        
        function spawnEnemy() {
            const enemyTypes = Object.keys(ENEMY_TYPES);
            const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            const enemyTemplate = ENEMY_TYPES[randomType];
            
            const enemy = {
                id: Date.now() + Math.random(),
                type: randomType,
                x: 800,
                y: 50 + Math.random() * 300,
                health: enemyTemplate.health,
                maxHealth: enemyTemplate.health,
                speed: enemyTemplate.speed,
                reward: enemyTemplate.reward,
                color: enemyTemplate.color
            };
            
            gameState.enemies.push(enemy);
            createEnemyElement(enemy);
        }
        
        function createEnemyElement(enemy) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = 'enemy';
            element.id = `enemy_${enemy.id}`;
            element.style.cssText = `
                left: ${enemy.x}px;
                top: ${enemy.y}px;
                width: 40px;
                height: 40px;
                background: ${enemy.color};
                z-index: 10;
            `;
            element.textContent = 'üçï';
            
            // Health bar
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar';
            healthBar.innerHTML = '<div class="health-fill" style="width: 100%"></div>';
            element.appendChild(healthBar);
            
            canvas.appendChild(element);
        }
        
        function updateEnemies() {
            gameState.enemies.forEach((enemy, index) => {
                enemy.x -= enemy.speed * gameState.gameSpeed;
                
                const element = document.getElementById(`enemy_${enemy.id}`);
                if (element) {
                    element.style.left = `${enemy.x}px`;
                    
                    // Update health bar
                    const healthFill = element.querySelector('.health-fill');
                    if (healthFill) {
                        healthFill.style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
                    }
                }
                
                // Check if reached end
                if (enemy.x < -50) {
                    gameState.lives--;
                    element?.remove();
                    gameState.enemies.splice(index, 1);
                    
                    if (gameState.lives <= 0) {
                        gameOver();
                    }
                    return;
                }
                
                // Check if dead
                if (enemy.health <= 0) {
                    gameState.pizzaBucks += enemy.reward;
                    gameState.score += enemy.reward * 10;
                    gameState.kills++;
                    element?.remove();
                    gameState.enemies.splice(index, 1);
                }
            });
        }
        
        function updateTraps() {
            gameState.traps.forEach(trap => {
                trap.cooldown = Math.max(0, trap.cooldown - 1);
                
                if (trap.cooldown === 0) {
                    const nearestEnemy = findNearestEnemy(trap);
                    if (nearestEnemy) {
                        attackEnemy(trap, nearestEnemy);
                        trap.cooldown = 30; // 0.5 second cooldown at 60fps
                    }
                }
            });
        }
        
        function findNearestEnemy(trap) {
            let nearest = null;
            let minDistance = Infinity;
            
            gameState.enemies.forEach(enemy => {
                const distance = Math.sqrt(
                    Math.pow(enemy.x - trap.x, 2) + 
                    Math.pow(enemy.y - trap.y, 2)
                );
                
                if (distance <= trap.range && distance < minDistance) {
                    nearest = enemy;
                    minDistance = distance;
                }
            });
            
            return nearest;
        }
        
        function attackEnemy(trap, enemy) {
            enemy.health -= trap.damage;
            
            // Visual attack effect
            createAttackEffect(trap.x, trap.y, enemy.x, enemy.y);
        }
        
        function createAttackEffect(fromX, fromY, toX, toY) {
            const canvas = document.getElementById('gameCanvas');
            const projectile = document.createElement('div');
            projectile.style.cssText = `
                position: absolute;
                left: ${fromX}px;
                top: ${fromY}px;
                width: 4px;
                height: 4px;
                background: #FFD700;
                border-radius: 50%;
                z-index: 15;
                transition: all 0.3s ease;
            `;
            
            canvas.appendChild(projectile);
            
            setTimeout(() => {
                projectile.style.left = `${toX}px`;
                projectile.style.top = `${toY}px`;
            }, 10);
            
            setTimeout(() => {
                projectile.remove();
            }, 300);
        }
        
        function updateWave() {
            gameState.waveTimer -= 1/60; // Decrease by 1/60th of a second
            
            if (gameState.waveTimer <= 0) {
                gameState.wave++;
                gameState.waveTimer = 30;
                showNotification(`Wave ${gameState.wave} incoming!`, 'info');
            }
        }
        
        function updateUI() {
            document.getElementById('pizzaBucks').textContent = gameState.pizzaBucks;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('kills').textContent = gameState.kills;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('enemiesLeft').textContent = gameState.enemies.length;
            document.getElementById('currentWave').textContent = gameState.wave;
            document.getElementById('waveTimer').textContent = `${Math.ceil(gameState.waveTimer)}s`;
            
            // Update wave progress
            const progress = ((30 - gameState.waveTimer) / 30) * 100;
            document.getElementById('waveProgress').style.width = `${progress}%`;
            
            updateTrapButtons();
        }
        
        function gameLoop() {
            if (!gameState.playing || gameState.paused) return;
            
            gameState.frameCount++;
            
            // Spawn enemies
            if (gameState.frameCount % (CONFIG.SPAWN_RATE * 60) === 0) {
                spawnEnemy();
            }
            
            updateEnemies();
            updateTraps();
            updateWave();
            updateUI();
        }
        
        function startGameLoop() {
            setInterval(gameLoop, 1000 / 60); // 60 FPS
        }
        
        function pauseGame() {
            gameState.paused = !gameState.paused;
            document.getElementById('pauseModal').classList.toggle('hidden', !gameState.paused);
        }
        
        function gameOver() {
            gameState.playing = false;
            
            document.getElementById('finalStats').innerHTML = `
                <div class="text-lg mb-2">Final Score: <span class="text-primary">${gameState.score}</span></div>
                <div class="text-lg mb-2">Wave Reached: <span class="text-secondary">${gameState.wave}</span></div>
                <div class="text-lg">Enemies Killed: <span class="text-accent">${gameState.kills}</span></div>
            `;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            saveGameData();
        }
        
        async function saveGameData() {
            if (!currentUser || !supabase) return;
            
            try {
                await supabase.from('game_sessions').insert({
                    user_id: currentUser.id,
                    final_score: gameState.score,
                    waves_completed: gameState.wave,
                    enemies_killed: gameState.kills,
                    session_duration_seconds: Math.floor(gameState.frameCount / 60)
                });
            } catch (error) {
                console.error('Error saving game data:', error);
            }
        }
        
        // ============================================
        // CANVAS INTERACTION
        // ============================================
        
        function setupCanvasEvents() {
            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('click', (e) => {
                if (!gameState.selectedTrap) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                buildTrap(x, y);
            });
        }
        
        function buildTrap(x, y) {
            const trapType = TRAP_TYPES[gameState.selectedTrap];
            
            if (gameState.pizzaBucks >= trapType.cost) {
                gameState.pizzaBucks -= trapType.cost;
                
                const trap = {
                    id: Date.now(),
                    type: gameState.selectedTrap,
                    x: x,
                    y: y,
                    damage: trapType.damage,
                    range: trapType.range,
                    cooldown: 0
                };
                
                gameState.traps.push(trap);
                createTrapElement(trap);
                
                gameState.selectedTrap = null;
                updateTrapButtons();
                showNotification(`Built ${trapType.name}!`, 'success');
            }
        }
        
        function createTrapElement(trap) {
            const canvas = document.getElementById('gameCanvas');
            const trapType = TRAP_TYPES[trap.type];
            
            const element = document.createElement('div');
            element.className = 'trap';
            element.id = `trap_${trap.id}`;
            element.style.cssText = `
                left: ${trap.x - 20}px;
                top: ${trap.y - 20}px;
                width: 40px;
                height: 40px;
                background: ${trapType.color};
                z-index: 5;
            `;
            element.textContent = trapType.icon;
            
            canvas.appendChild(element);
        }
        
        // ============================================
        // NOTIFICATIONS
        // ============================================
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `notification ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // Auth events
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('playAsGuestBtn').addEventListener('click', playAsGuest);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Form toggles
            document.getElementById('showSignupBtn').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            });
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            });
            
            // Menu events
            document.getElementById('startGameBtn').addEventListener('click', initGame);
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                gameState.playing = false;
                showMainMenu();
            });
            
            // Game events
            document.getElementById('pauseGameBtn').addEventListener('click', pauseGame);
            document.getElementById('speedBtn').addEventListener('click', () => {
                gameState.gameSpeed = gameState.gameSpeed >= 4 ? 1 : gameState.gameSpeed + 1;
                document.getElementById('speedBtn').textContent = `${gameState.gameSpeed}x`;
            });
            
            // Modal events
            document.getElementById('resumeBtn').addEventListener('click', pauseGame);
            document.getElementById('restartBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('quitBtn').addEventListener('click', () => {
                document.getElementById('pauseModal').classList.add('hidden');
                gameState.playing = false;
                showMainMenu();
            });
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                initGame();
            });
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('gameOverModal').classList.add('hidden');
                showMainMenu();
            });
            
            // Sell mode
            document.getElementById('sellModeBtn').addEventListener('click', () => {
                gameState.sellMode = !gameState.sellMode;
                gameState.selectedTrap = null;
                const btn = document.getElementById('sellModeBtn');
                btn.textContent = gameState.sellMode ? 'üî® Build Mode' : 'üí∞ Sell Mode';
                btn.className = gameState.sellMode ? 
                    'w-full bg-yellow-500/20 hover:bg-yellow-500/30 py-2 rounded-lg transition-colors' :
                    'w-full bg-red-500/20 hover:bg-red-500/30 py-2 rounded-lg transition-colors';
                updateTrapButtons();
            });
            
            // Enter key for forms
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const activeForm = document.querySelector('#authScreen .glass div:not(.hidden)');
                    if (activeForm) {
                        if (activeForm.id === 'loginForm') {
                            handleLogin();
                        } else if (activeForm.id === 'signupForm') {
                            handleSignup();
                        }
                    }
                }
            });
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            setupEventListeners();
            setupCanvasEvents();
            
            // Auto-login check
            if (supabase) {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        currentUser = session.user;
                        showMainMenu();
                    }
                });
            }
        });
    </script>
</body>
</html>
